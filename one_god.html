<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°è¦ç±³ä¿®ä»™ä¹‹æ—… V4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a69bd;
            --primary-dark: #1e3799;
            --accent: #e55039;
            --success: #26de81;
            --warning: #f7b731;
            --special: #8e44ad;
            --text-main: #2f3542;
            --bg-color: #f1f2f6;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background: #2f3640;
            color: var(--text-main);
            height: 100vh; /* Fallback */
            height: 100dvh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* PC / Tablet Optimization */
        @media (min-width: 501px) {
            #app-container {
                max-width: 480px;
                height: 95vh;
                border-radius: 20px;
                border: 8px solid #dfe4ea;
            }
            .story-icon { font-size: 4rem; }
            .btn-lg { max-width: 300px; }
        }

        /* Mobile Optimization */
        @media (max-width: 500px) {
            .story-card {
                padding: 15px !important;
                margin-bottom: 10px !important;
            }
            .story-icon {
                font-size: 3rem !important; /* Smaller icon on mobile */
                margin-bottom: 5px !important;
            }
            .story-title {
                font-size: 1.2rem !important;
                margin-bottom: 5px !important;
            }
            .story-desc {
                font-size: 0.95rem !important;
                line-height: 1.4 !important;
            }
            .choice-item {
                padding: 12px 10px !important; /* Larger touch area */
                margin-bottom: 8px !important;
            }
            .top-bar {
                padding: 8px 12px !important;
            }
            .stat-box {
                font-size: 0.7rem !important;
            }
            .stat-box span {
                font-size: 0.9rem !important;
            }
        }

        .screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            transition: transform 0.3s ease, opacity 0.3s;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
            z-index: 0;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            z-index: 10;
        }

        /* UI Components */
        h1 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin: 10px 0;
            text-align: center;
        }

        .btn {
            border: none; outline: none; cursor: pointer;
            font-family: inherit; font-weight: bold;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }

        .btn-lg {
            width: 80%; padding: 15px; font-size: 1.1rem;
            color: white; background: var(--primary);
            border-radius: 50px;
            box-shadow: 0 4px 0 var(--primary-dark);
            margin: 20px auto; display: block;
        }

        /* Gender Selection */
        .gender-box {
            display: flex; justify-content: center; gap: 15px; margin: 20px 0;
        }
        .gender-option {
            width: 80px; height: 80px;
            border-radius: 15px; background: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-size: 2rem; border: 3px solid transparent;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .gender-option.selected {
            border-color: var(--primary); background: #eef2ff;
        }
        .gender-option span { font-size: 0.9rem; margin-top: 5px; font-weight: bold; }

        /* Game Layout */
        .top-bar {
            background: white; padding: 10px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 8px;
            flex-shrink: 0; /* Don't shrink */
        }

        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
            text-align: center;
        }
        .stat-box {
            background: #f1f2f6; padding: 4px; border-radius: 8px;
            font-size: 0.75rem; color: #747d8c;
        }
        .stat-box span { display: block; font-size: 1rem; color: var(--text-main); font-weight: bold; }

        .hp-container {
            width: 100%; background: #dfe4ea; height: 8px;
            border-radius: 4px; overflow: hidden;
        }
        .hp-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.3s; }

        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; color: #57606f;
        }
        
        .identity-badge {
            background: var(--special); color: white;
            padding: 2px 8px; border-radius: 10px;
            font-size: 0.75rem; margin-left: 5px;
        }

        /* Event Area */
        .event-container {
            flex: 1; padding: 10px 0;
            display: flex; flex-direction: column;
            overflow-y: auto; /* Allow scroll inside */
            -webkit-overflow-scrolling: touch;
        }

        .story-card {
            background: white; border-radius: 15px; padding: 20px;
            margin: 0 10px 15px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center; border-top: 4px solid var(--accent);
            flex-shrink: 0;
        }

        .story-icon { display: block; margin: 0 auto 10px auto; }
        .story-title { font-weight: bold; color: var(--text-main); }
        .story-desc { color: #57606f; text-align: justify; }

        .choices-list {
            padding: 0 10px 20px 10px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .choice-item {
            background: white; border: 1px solid #dfe4ea;
            border-radius: 12px; padding: 15px;
            cursor: pointer; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .choice-item:active { background: #f1f2f6; }
        
        .choice-main { font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: var(--text-main); }
        .choice-meta {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: #747d8c;
        }

        .tag { padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .tag-high { color: #e55039; background: rgba(229, 80, 57, 0.1); } /* High Risk */
        .tag-mid { color: #f39c12; background: rgba(243, 156, 18, 0.1); } /* Mid Risk */
        .tag-safe { color: #27ae60; background: rgba(39, 174, 96, 0.1); } /* Safe */
        .tag-bonus { color: var(--special); background: rgba(142, 68, 173, 0.1); border: 1px solid var(--special); } /* Identity Bonus */

        /* Modal */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 100; display: none;
            justify-content: center; align-items: center;
            padding: 20px; animation: fadeIn 0.2s;
        }
        .modal-card {
            background: white; width: 100%; max-width: 360px;
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        .result-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--accent); }
        
        .changes-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin: 15px 0;
        }
        .change-pill {
            font-size: 0.8rem; padding: 3px 8px; border-radius: 6px;
            background: #f1f2f6; font-weight: bold;
        }
        .pill-good { color: var(--success); border: 1px solid var(--success); }
        .pill-bad { color: var(--accent); border: 1px solid var(--accent); }

        /* End Screen */
        .summary-box {
            background: white; padding: 15px; border-radius: 12px;
            margin: 15px 0; text-align: left;
        }
        .summary-row {
            display: flex; justify-content: space-between; 
            padding: 8px 0; border-bottom: 1px solid #eee;
        }

        /* Floating Text */
        .float-text {
            position: absolute; font-weight: bold; font-size: 1.2rem;
            pointer-events: none; animation: floatUp 1.2s forwards; z-index: 50;
            text-shadow: 1px 1px 0 white;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }

    </style>
</head>
<body>

<div id="app-container">
    
    <!-- START SCREEN -->
    <div id="start-screen" class="screen active" style="justify-content: center; overflow-y: auto;">
        <div style="text-align: center; padding: 20px;">
            <div style="color: var(--accent); font-weight: bold; transform: rotate(-3deg); display: inline-block; border: 2px solid var(--accent); padding: 5px 10px; border-radius: 8px; margin-bottom: 10px;">V4.0 å…«å¤§å‡ºèº«ç‰ˆ</div>
            <h1>å°è¦ç±³ä¿®ä»™ä¹‹æ—…</h1>
            <p style="color: #747d8c; margin-bottom: 20px;">ä¸€æŒ‡ä¿®ä»™ï¼Œå¿«æ¨‚ç„¡é‚Š</p>
            
            <p style="color: #666; font-size: 0.9rem;">è«‹é¸æ“‡é“å‹æ³•ç›¸ï¼š</p>
            <div class="gender-box">
                <div class="gender-option selected" onclick="selectGender('male')" id="btn-male">
                    ğŸ‘¦<span>å°‘ä¿ </span>
                </div>
                <div class="gender-option" onclick="selectGender('female')" id="btn-female">
                    ğŸ‘§<span>ä¿ å¥³</span>
                </div>
            </div>

            <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 0.85rem; color: #555; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">ğŸ“œ ç‰ˆæœ¬æ›´æ–°ï¼š</div>
                1. <b>å…«å¤§éš¨æ©Ÿå‡ºèº«</b>ï¼šå¯Œå®¶å­å¼Ÿã€æ­¦æ—ä¸–å®¶ã€å¤©ç…å­¤æ˜Ÿ...ä¸åŒå‡ºèº«å½±éŸ¿åˆå§‹æ•¸å€¼èˆ‡åˆ¤å®šæ©Ÿç‡ï¼<br>
                2. <b>ç­–ç•¥é¸æ“‡</b>ï¼šé«˜é¢¨éšªé«˜å›å ±ï¼Œä½é¢¨éšªæ±‚ç©©ã€‚<br>
                3. <b>æ‰‹æ©Ÿå„ªåŒ–</b>ï¼šå–®æ‰‹æ“ä½œæ›´é †æš¢ã€‚
            </div>

            <button class="btn btn-lg" onclick="startGame()">è¼ªè¿´è½‰ä¸– (é–‹å§‹)</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
        <!-- Top Stats Bar -->
        <div class="top-bar">
            <div class="info-row">
                <span style="font-weight: bold; color: var(--primary);">å£½å…ƒ(HP)</span>
                <span id="disp-hp-val">100/100</span>
            </div>
            <div class="hp-container">
                <div id="hp-bar" class="hp-fill"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">ä¿®ç‚º<span id="disp-cult">0</span></div>
                <div class="stat-box">é«”é­„<span id="disp-str">10</span></div>
                <div class="stat-box">æ‚Ÿæ€§<span id="disp-int">10</span></div>
                <div class="stat-box">æ©Ÿç·£<span id="disp-luck">10</span></div>
            </div>
            
            <div class="info-row" style="border-top: 1px dashed #ddd; padding-top: 5px;">
                <div style="display: flex; align-items: center;">
                    <span>ğŸ’° <b id="disp-money">0</b></span>
                    <span id="identity-tag" class="identity-badge">å‡¡äºº</span>
                </div>
                <span style="background: var(--text-main); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">ç¬¬ <span id="round-num">1</span>/20 åŠ«</span>
            </div>
        </div>

        <!-- Event Area -->
        <div class="event-container">
            <div class="story-card" id="card-elem">
                <span class="story-icon" id="event-icon">ğŸ¤–</span>
                <div class="story-title" id="event-title">è¼‰å…¥ä¸­...</div>
                <div class="story-desc" id="event-desc">
                    æ­£åœ¨ç”Ÿæˆéš¨æ©Ÿäº‹ä»¶...
                </div>
            </div>

            <div class="choices-list" id="choices-box">
                <!-- Choices rendered here -->
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="modal-overlay" onclick="nextEvent()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div style="font-size: 3rem; margin-bottom: 10px;" id="res-icon">âœ¨</div>
            <div class="result-title" id="res-title">æˆåŠŸ</div>
            <p style="color: #666; line-height: 1.4; margin-bottom: 15px;" id="res-text">çµæœæè¿°</p>
            
            <div class="changes-grid" id="res-changes">
                <!-- Change pills -->
            </div>

            <button class="btn btn-lg" style="margin: 0 auto; width: 100%;" onclick="nextEvent()">ç¹¼çºŒä¿®ä»™</button>
        </div>
    </div>

    <!-- END SCREEN -->
    <div id="end-screen" class="screen" style="overflow-y: auto;">
        <div style="padding: 20px; text-align: center;">
            <div style="font-size: 4rem;" id="end-icon">ğŸ</div>
            <h2 id="end-title" style="margin: 10px 0; color: var(--primary-dark);">çµå±€</h2>
            <p id="end-desc" style="color: #666; line-height: 1.5;">çµå±€æè¿°</p>
            
            <div class="summary-box">
                <div style="text-align: center; margin-bottom: 10px;">
                    <span style="font-size: 4rem; font-weight: bold; color: var(--warning); text-shadow: 2px 2px 0 rgba(0,0,0,0.1);" id="end-rank">C</span>
                    <div style="font-size: 0.8rem; color: #aaa;">ç¶œåˆè©•åƒ¹</div>
                </div>
                
                <div class="summary-row"><span>æœ€çµ‚ä¿®ç‚º</span><b id="end-cult-val">0</b></div>
                <div class="summary-row"><span>é«”é­„</span><b id="end-str-val">0</b></div>
                <div class="summary-row"><span>æ‚Ÿæ€§</span><b id="end-int-val">0</b></div>
                <div class="summary-row"><span>æ©Ÿç·£</span><b id="end-luck-val">0</b></div>
                <div class="summary-row"><span>è²¡å¯Œ</span><b id="end-money-val">0</b></div>
            </div>

            <button class="btn btn-lg" onclick="resetGame()">å†å…¥è¼ªè¿´</button>
        </div>
    </div>

</div>

<script>
/**
 * å°è¦ç±³ä¿®ä»™ä¹‹æ—… V4.0 Logic
 */

let player = {
    gender: 'male',
    hp: 100,
    maxHp: 100,
    cultivation: 0,
    str: 10,
    int: 10,
    luck: 10,
    money: 0,
    round: 1,
    identity: null
};

const MAX_ROUNDS = 20;

// --- 8å¤§å‡ºèº« (Identities) ---
// type æ±ºå®šäº†å“ªç¨®åˆ¤å®šæœ‰åŠ æˆ: 'str', 'int', 'luck', 'money', 'all'
const identities = [
    { name: "å¯Œå®¶å­å¼Ÿ", bonus: "åˆå§‹éˆçŸ³+200ï¼Œé‡‘éŒ¢æ¶ˆè€—é¡äº‹ä»¶æœ‰å„ªæƒ æ„Ÿ(è…¦è£œ)", init: (p)=>{p.money+=200;}, type: 'money' },
    { name: "æ­¦å­¸ä¸–å®¶", bonus: "åˆå§‹é«”é­„+20ï¼Œæˆ°é¬¥åˆ¤å®š(é«”é­„)æˆåŠŸç‡+15%", init: (p)=>{p.str+=20;}, type: 'str' },
    { name: "æ›¸é¦™é–€ç¬¬", bonus: "åˆå§‹æ‚Ÿæ€§+20ï¼Œæ™ºè¬€åˆ¤å®š(æ‚Ÿæ€§)æˆåŠŸç‡+15%", init: (p)=>{p.int+=20;}, type: 'int' },
    { name: "å¤©é¸ä¹‹äºº", bonus: "åˆå§‹æ©Ÿç·£+20ï¼Œé‹æ°£åˆ¤å®š(æ©Ÿç·£)æˆåŠŸç‡+15%", init: (p)=>{p.luck+=20;}, type: 'luck' },
    { name: "è—¥ç‹å‚³äºº", bonus: "åˆå§‹å£½å…ƒ+50ï¼Œç”Ÿå­˜åŠ›æ¥µå¼·", init: (p)=>{p.maxHp+=50; p.hp+=50;}, type: 'hp' },
    { name: "å¸‚äº•æµæ°“", bonus: "é«”é­„+10 æ©Ÿç·£+10ï¼Œæ“…é•·é€ƒè·‘èˆ‡æŠ•æ©Ÿ", init: (p)=>{p.str+=10; p.luck+=10;}, type: 'mix_str_luck' },
    { name: "è½é­„è²´æ—", bonus: "åˆå§‹ä¿®ç‚º+100ï¼Œä½†èº«ç„¡åˆ†æ–‡", init: (p)=>{p.cultivation+=100; p.money=0;}, type: 'cult' },
    { name: "è½‰ä¸–ä»™äºº", bonus: "å…¨å±¬æ€§+8ï¼Œæ‰€æœ‰åˆ¤å®šæˆåŠŸç‡+5%", init: (p)=>{p.str+=8; p.int+=8; p.luck+=8; p.money+=20;}, type: 'all' }
];

// --- Events Pool ---
// We define structure: 3 choices. 
// 1. High Risk/Reward (Diff ~50-60)
// 2. Mid Risk/Reward (Diff ~30-40)
// 3. Low Risk/Safe (Diff <20 or Cost)
const eventPool = [
    {
        title: "é­é‡å±±è³Š",
        desc: "ä¸€ç¾¤å‡¶ç¥æƒ¡ç…çš„å±±è³Šæ””ä½äº†å»è·¯ï¼Œé ˜é ­çš„çœ‹èµ·ä¾†æ˜¯å€‹ç·´å®¶å­ã€‚",
        icon: "âš”ï¸",
        choices: [
            { txt: "å–®æŒ‘å¯¨ä¸» (é«˜å ±é…¬)", type: "str", diff: 55, succ: "ä½ ä¸€æ‹³æ‰“é£›å¯¨ä¸»ï¼Œæ”¶ç¹³äº†å±±å¯¨å¯¶åº«ï¼", fail: "ä½ è¢«å¯¨ä¸»æŒ‰åœ¨åœ°ä¸Šæ‘©æ“¦ã€‚", succEff: {cultivation: 80, money: 100}, failEff: {hp: -40} },
            { txt: "å¨åš‡å˜å›‰ (ä¸­åº¸)", type: "str", diff: 30, succ: "å˜å›‰å€‘è¢«ä½ çš„æ°£å‹¢åš‡è·‘äº†ã€‚", fail: "è™›å¼µè²å‹¢å¤±æ•—ï¼Œè¢«åœæ¯†ã€‚", succEff: {cultivation: 30}, failEff: {hp: -15} },
            { txt: "ç ´è²¡æ¶ˆç½ (å®‰å…¨)", type: "money", cost: 20, succ: "äº¤éŒ¢èµ°äººï¼Œå¹³å®‰ç„¡äº‹ã€‚", fail: "æ²’éŒ¢ï¼Œè¢«æ‰“äº†ä¸€é “ã€‚", succEff: {luck: 5}, failEff: {hp: -20} }
        ]
    },
    {
        title: "å¤è€æ®˜å·",
        desc: "åœ°æ”¤ä¸Šç™¼ç¾ä¸€æœ¬ç ´ç ´çˆ›çˆ›çš„æ›¸ï¼Œéš±ç´„æ•£ç™¼è‘—éˆæ°£ã€‚",
        icon: "ğŸ“œ",
        choices: [
            { txt: "å¼·è¡Œåƒæ‚Ÿ (é«˜é¢¨éšª)", type: "int", diff: 60, succ: "é “æ‚Ÿäº†ä¸Šå¤ç¥åŠŸï¼ä¿®ç‚ºæš´æ¼²ï¼", fail: "èµ°ç«å…¥é­”ï¼Œç¶“è„ˆé€†è¡Œï¼", succEff: {cultivation: 150, int: 20}, failEff: {hp: -50, cultivation: -20} },
            { txt: "ç ”ç©¶åºè¨€ (ä¸­åº¸)", type: "int", diff: 35, succ: "å­¸åˆ°äº†ä¸€äº›å¯¦ç”¨çš„å°æ³•è¡“ã€‚", fail: "çœ‹ä¸æ‡‚ï¼Œçœ‹å¾—é ­ç—›ã€‚", succEff: {cultivation: 40, int: 5}, failEff: {hp: -10} },
            { txt: "è²·ä¸‹ä¾†æ”¶è— (å®‰å…¨)", type: "money", cost: 30, succ: "é›–ç„¶çœ‹ä¸æ‡‚ï¼Œä½†æ„Ÿè¦ºå¾ˆæœ‰æ ¼èª¿ã€‚", fail: "éŒ¢ä¸å¤ ã€‚", succEff: {luck: 10}, failEff: {} }
        ]
    },
    {
        title: "æ‡¸å´–æ¡è—¥",
        desc: "æ‡¸å´–é‚Šé•·è‘—ä¸€æ ªåƒå¹´éˆèŠï¼Œä½†å‘¨åœæœ‰å¦–é¢¨é™£é™£ã€‚",
        icon: "ğŸ„",
        choices: [
            { txt: "é£›èº«æ‘˜å– (é«˜é¢¨éšª)", type: "luck", diff: 55, succ: "ä¸€é™£é¢¨æŠŠä½ å¹åˆ°äº†éˆèŠæ—ï¼Œå¹¸é‹ï¼", fail: "ä¸€é™£é¢¨æŠŠä½ å¹ä¸‹äº†æ‡¸å´–ã€‚", succEff: {cultivation: 100, hp: 50}, failEff: {hp: -60} },
            { txt: "å°å¿ƒæ”€çˆ¬ (ä¸­åº¸)", type: "str", diff: 35, succ: "é›–ç„¶è²»åŠ›ï¼Œä½†æˆåŠŸæ¡åˆ°äº†éˆèŠã€‚", fail: "æ‰‹æ»‘äº†ï¼Œæ‘”å¾—ä¸è¼•ã€‚", succEff: {hp: 30, str: 5}, failEff: {hp: -20} },
            { txt: "æ”¾æ£„é›¢é–‹ (å®‰å…¨)", type: "free", succ: "å‘½æ¯”è—¥é‡è¦ã€‚", succEff: {int: 2} }
        ]
    },
    {
        title: "å®—é–€è³­å±€",
        desc: "å®—é–€å…§æ­£åœ¨é–‹è¨­è³­å±€ï¼Œè³­èª°èƒ½æˆç‚ºé¦–å¸­å¼Ÿå­ã€‚",
        icon: "ğŸ²",
        choices: [
            { txt: "æ¢­å“ˆå†·é–€ (é«˜é¢¨éšª)", type: "luck", diff: 65, succ: "çˆ†å†·é–€ï¼ä½ è´å¾—ç›†æ»¿ç¼½æ»¿ï¼", fail: "è¼¸å¾—åªå‰©è¤²è¡©ã€‚", succEff: {money: 300}, failEff: {money: -999} }, // clear money
            { txt: "å°è³­æ€¡æƒ… (ä¸­åº¸)", type: "luck", diff: 40, succ: "é‹æ°£ä¸éŒ¯ï¼Œè´äº†ä¸€é»ã€‚", fail: "é‹æ°£ä¸€èˆ¬ï¼Œè¼¸äº†é»é›¶èŠ±éŒ¢ã€‚", succEff: {money: 50}, failEff: {money: -20} },
            { txt: "ä¸è³­ç‚ºè´ (å®‰å…¨)", type: "free", succ: "åè³­ä¹è¼¸ï¼Œæˆ‘ä¸ç©ã€‚", succEff: {int: 5} }
        ]
    },
    {
        title: "å¿ƒé­”åŠ«",
        desc: "ä¿®ç…‰æ™‚å¿ƒé­”ä½œç¥Ÿï¼ŒåŒ–ä½œä½ æœ€ææ‡¼çš„æ¨£å­ã€‚",
        icon: "ğŸ‘»",
        choices: [
            { txt: "æ–¬æ»…å¿ƒé­” (é«˜é¢¨éšª)", type: "str", diff: 60, succ: "å¿ƒé­”æ¶ˆæ•£ï¼Œé“å¿ƒå …å¦‚ç£çŸ³ï¼", fail: "è¢«å¿ƒé­”åå™¬ï¼Œå…ƒæ°£å¤§å‚·ã€‚", succEff: {cultivation: 120, str: 15}, failEff: {hp: -50, cultivation: -30} },
            { txt: "éœå¿ƒå’’ (ä¸­åº¸)", type: "int", diff: 30, succ: "å¿ƒé­”æš«æ™‚é€€å»ã€‚", fail: "å¿µéŒ¯å’’èªï¼Œå’¬åˆ°èˆŒé ­ã€‚", succEff: {cultivation: 40}, failEff: {hp: -10} },
            { txt: "åƒè—¥å£“é©š (å®‰å…¨)", type: "money", cost: 40, succ: "å—‘äº†ä¸€é¡†æ¸…å¿ƒä¸¹ï¼Œæ²’äº‹äº†ã€‚", fail: "æ²’éŒ¢è²·è—¥ï¼Œç¡¬æŠ—ã€‚", succEff: {hp: 10}, failEff: {hp: -20} }
        ]
    },
    {
        title: "è‹±é›„æ•‘ç¾/æ•‘å¸¥",
        desc: "è·¯é‡æƒ¡éœ¸å¼·æ¶æ°‘å¥³/æ°‘ç”·ã€‚",
        icon: "â¤ï¸",
        choices: [
            { txt: "å‡ºæ‰‹ç›¸æ•‘ (é«˜é¢¨éšª)", type: "str", diff: 50, succ: "æ‰“è·‘æƒ¡éœ¸ï¼Œå°æ–¹ä»¥èº«ç›¸è¨±ï¼ˆé€ç¦®ï¼‰ã€‚", fail: "è¢«æ‰“å¾—é¼»é’è‡‰è…«ï¼Œå°æ–¹ä¹Ÿè·‘äº†ã€‚", succEff: {cultivation: 60, luck: 20, money: 50}, failEff: {hp: -40} },
            { txt: "è¬›é“ç† (ä¸­åº¸)", type: "int", diff: 35, succ: "æƒ¡éœ¸è¢«ä½ çš„å£æ‰æŠ˜æœã€‚", fail: "ç§€æ‰é‡åˆ°å…µï¼Œæœ‰ç†èªªä¸æ¸…ã€‚", succEff: {cultivation: 30, int: 10}, failEff: {hp: -15} },
            { txt: "å ±å®˜ (å®‰å…¨)", type: "luck", diff: 20, succ: "å®˜å…µåŠæ™‚è¶•åˆ°ã€‚", fail: "å®˜å…µä¾†æ™šäº†ã€‚", succEff: {money: 10}, failEff: {cultivation: -5} }
        ]
    },
    {
        title: "ç¥ç§˜æ‹è³£æœƒ",
        desc: "æ‹è³£æœƒä¸Šå‡ºç¾äº†ä¸€ä»¶ç–‘ä¼¼ç¥å™¨çš„ç‰©å“ã€‚",
        icon: "ğŸ”¨",
        choices: [
            { txt: "ç«¶åƒ¹ (é«˜é¢¨éšª)", type: "money", cost: 100, succ: "å±…ç„¶çœŸçš„æ˜¯ç¥å™¨ï¼è³ºç¿»äº†ï¼", fail: "è²·äº†å€‹è´—å“ï¼Œè™§å¤§äº†ã€‚", succEff: {cultivation: 150, str: 20}, failEff: {cultivation: -10} },
            { txt: "é‘‘å¯¶ (ä¸­åº¸)", type: "int", diff: 40, succ: "çœ‹ç©¿äº†æ˜¯å‡è²¨ï¼Œé¿å…äº†æå¤±ã€‚", fail: "çœ‹èµ°çœ¼äº†ï¼ŒéŒ¯éå¥½æ±è¥¿ã€‚", succEff: {int: 15}, failEff: {luck: -5} },
            { txt: "çœ‹ç†±é¬§ (å®‰å…¨)", type: "free", succ: "åƒç“œç¾¤çœ¾æœ€å¿«æ¨‚ã€‚", succEff: {hp: 5} }
        ]
    },
    {
        title: "ç…‰ä¸¹æˆ¿äº‹æ•…",
        desc: "å¸«å¼Ÿç…‰ä¸¹æ“ä½œå¤±èª¤ï¼Œä¸¹çˆå³å°‡çˆ†ç‚¸ï¼",
        icon: "ğŸ’¥",
        choices: [
            { txt: "å£“åˆ¶ä¸¹çˆ (é«˜é¢¨éšª)", type: "str", diff: 65, succ: "æŒ½ç‹‚ç€¾æ–¼æ—¢å€’ï¼Œç…‰å‡ºæ¥µå“ä¸¹è—¥ï¼", fail: "ç‚¸å¾—æ»¿è‡‰é»‘ç°ï¼Œé ­é«®éƒ½ç„¦äº†ã€‚", succEff: {cultivation: 100, money: 100}, failEff: {hp: -60} },
            { txt: "ç–æ•£äººç¾¤ (ä¸­åº¸)", type: "int", diff: 30, succ: "ç„¡äººå‚·äº¡ï¼ŒåŠŸå¾·ä¸€ä»¶ã€‚", fail: "è·‘å¾—å¤ªæ…¢ï¼Œè¢«ç¢ç‰‡ç ¸ä¸­ã€‚", succEff: {cultivation: 40, luck: 10}, failEff: {hp: -20} },
            { txt: "å…ˆè·‘ç‚ºæ•¬ (å®‰å…¨)", type: "free", succ: "åªè¦æˆ‘è·‘å¾—å¿«ï¼Œçˆ†ç‚¸å°±è¿½ä¸ä¸Šæˆ‘ã€‚", succEff: {luck: 2} }
        ]
    },
    {
        title: "è¿·ä¹‹æ´çªŸ",
        desc: "ä¸€å€‹æ·±ä¸è¦‹åº•çš„æ´çªŸï¼Œå‚³ä¾†è©­ç•°çš„è²éŸ³ã€‚",
        icon: "ğŸ•³ï¸",
        choices: [
            { txt: "æ·±å…¥æ¢ç´¢ (é«˜é¢¨éšª)", type: "luck", diff: 60, succ: "ç™¼ç¾å‰è¼©éºåºœï¼Œç¹¼æ‰¿éºç”¢ï¼", fail: "é‡åˆ°åƒå¹´æ®­å±ï¼Œé€ƒå‘½è¦ç·Šã€‚", succEff: {cultivation: 200, money: 100}, failEff: {hp: -50} },
            { txt: "æŠ•çŸ³å•è·¯ (ä¸­åº¸)", type: "int", diff: 30, succ: "åˆ¤æ–·å‡ºè£¡é¢æœ‰å±éšªï¼Œæ’¤é€€ã€‚", fail: "çŸ³é ­ç ¸é†’äº†è™è ç¾¤ã€‚", succEff: {int: 10}, failEff: {hp: -15} },
            { txt: "å°é–‰æ´å£ (å®‰å…¨)", type: "str", diff: 20, succ: "é˜²æ­¢ä»–äººå—å®³ï¼Œåšå¥½äº‹ã€‚", fail: "æ¬ä¸å‹•çŸ³é ­ã€‚", succEff: {cultivation: 10}, failEff: {str: -2} }
        ]
    },
    {
        title: "é “æ‚Ÿæ™‚åˆ»",
        desc: "çœ‹è‘—è½è‘‰é£„é›¶ï¼Œä½ çªç„¶æœ‰æ‰€æ„Ÿæ‚Ÿã€‚",
        icon: "ğŸ‚",
        choices: [
            { txt: "åƒæ‚Ÿå¤§é“ (é«˜é¢¨éšª)", type: "int", diff: 70, succ: "å¤©äººåˆä¸€ï¼Œå¢ƒç•Œçªç ´ï¼", fail: "æƒ³å¤ªå¤šï¼Œè…¦è¢‹æ‰“çµäº†ã€‚", succEff: {cultivation: 300}, failEff: {int: -10, hp: -10} },
            { txt: "ä½œè©©ä¸€é¦– (ä¸­åº¸)", type: "int", diff: 40, succ: "æ‰æ°£é€¼äººï¼Œå—åˆ°çœ¾äººè¿½æ§ã€‚", fail: "ç„¡ç—…å‘»åŸï¼Œè¢«è·¯äººé„™è¦–ã€‚", succEff: {cultivation: 50, luck: 10}, failEff: {cultivation: -10} },
            { txt: "æƒåœ° (å®‰å…¨)", type: "free", succ: "æƒåœ°åƒ§ä¹Ÿæ˜¯ä¸€ç¨®ä¿®è¡Œã€‚", succEff: {str: 5} }
        ]
    }
];

// è£œå……æ›´å¤šéš¨æ©Ÿäº‹ä»¶ä»¥é”åˆ°è±å¯Œåº¦ï¼Œçµæ§‹ç›¸åŒ...
// (æ­¤è™•ç‚ºäº†ä»£ç¢¼é•·åº¦çœç•¥é‡è¤‡çµæ§‹ï¼Œå¯¦éš›éŠæˆ²æœƒé‡è¤‡ä¸Šè¿°é‚è¼¯ç”Ÿæˆæ›´å¤šäº‹ä»¶)
// ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘è¤‡è£½ä¸¦å¾®èª¿ä¸€äº›äº‹ä»¶é€²å»
const extraEvents = [
    {
        title: "é­é‡ç¢°ç“·",
        desc: "ä¸€éš»è€çƒé¾œèººåœ¨è·¯ä¸­é–“ï¼Œèªªæ˜¯ä½ è¸©å‚·äº†å®ƒã€‚",
        icon: "ğŸ¢",
        choices: [
            { txt: "è¸¢é£›å®ƒ (é«˜é¢¨éšª)", type: "str", diff: 50, succ: "åŸä¾†æ˜¯ç¥ç¸ç„æ­¦çš„è¦ªæˆšï¼Œä½ æŠŠå®ƒæ‰“æœäº†ã€‚", fail: "ä½ çš„è…³éª¨æŠ˜äº†ï¼Œé¾œæ®¼å¤ªç¡¬ã€‚", succEff: {str: 20, cultivation: 60}, failEff: {hp: -30} },
            { txt: "è¾¯è«– (ä¸­åº¸)", type: "int", diff: 30, succ: "ä½ è­‰æ˜äº†æ˜¯å®ƒè‡ªå·±ç¿»éä¾†çš„ã€‚", fail: "è¢«å®ƒç¹æšˆäº†ï¼Œè³ äº†éŒ¢ã€‚", succEff: {int: 10}, failEff: {money: -20} },
            { txt: "è³ éŒ¢ (å®‰å…¨)", type: "money", cost: 10, succ: "ç ´è²¡å…ç½ã€‚", fail: "æ²’éŒ¢ã€‚", succEff: {luck: 2}, failEff: {hp: -10} }
        ]
    },
    {
        title: "å¤©ä¸Šæ‰é¤¡é¤…",
        desc: "ä¸€å€‹ä¸æ˜ç‰©é«”å¾å¤©è€Œé™ã€‚",
        icon: "ğŸ",
        choices: [
            { txt: "æ¥ä½ (é«˜é¢¨éšª)", type: "str", diff: 60, succ: "æ¥ä½äº†ï¼æ˜¯å¤©å¤–éš•éµï¼", fail: "è¢«ç ¸é€²äº†åœ°è£¡ï¼Œæ˜¯éš•çŸ³ã€‚", succEff: {money: 150, str: 10}, failEff: {hp: -60} },
            { txt: "è§€å¯Ÿ (ä¸­åº¸)", type: "int", diff: 30, succ: "ç®—å‡ºè½é»ï¼Œæå‰æŒ–åˆ°äº†å¯¶è²ã€‚", fail: "ç®—éŒ¯è½é»ï¼Œåªèƒ½çœ‹å€‹å‘ã€‚", succEff: {money: 50}, failEff: {} },
            { txt: "èº²é–‹ (å®‰å…¨)", type: "free", succ: "å®‰å…¨ç¬¬ä¸€ã€‚", succEff: {luck: 5} }
        ]
    }
];
eventPool.push(...extraEvents); // Add extras

// DOM Elements
const screens = {
    start: document.getElementById('start-screen'),
    game: document.getElementById('game-screen'),
    end: document.getElementById('end-screen'),
    modal: document.getElementById('result-modal')
};

const display = {
    hpVal: document.getElementById('disp-hp-val'),
    hpBar: document.getElementById('hp-bar'),
    cult: document.getElementById('disp-cult'),
    str: document.getElementById('disp-str'),
    int: document.getElementById('disp-int'),
    luck: document.getElementById('disp-luck'),
    money: document.getElementById('disp-money'),
    round: document.getElementById('round-num'),
    identity: document.getElementById('identity-tag'),
    
    eventIcon: document.getElementById('event-icon'),
    eventTitle: document.getElementById('event-title'),
    eventDesc: document.getElementById('event-desc'),
    choicesBox: document.getElementById('choices-box'),
    
    // Result Modal
    resIcon: document.getElementById('res-icon'),
    resTitle: document.getElementById('res-title'),
    resText: document.getElementById('res-text'),
    resChanges: document.getElementById('res-changes'),
    
    // End
    endRank: document.getElementById('end-rank'),
    endTitle: document.getElementById('end-title'),
    endDesc: document.getElementById('end-desc'),
    endCult: document.getElementById('end-cult-val'),
    endStr: document.getElementById('end-str-val'),
    endInt: document.getElementById('end-int-val'),
    endLuck: document.getElementById('end-luck-val'),
    endMoney: document.getElementById('end-money-val')
};

// --- Game Functions ---

function selectGender(g) {
    player.gender = g;
    document.getElementById('btn-male').classList.toggle('selected', g === 'male');
    document.getElementById('btn-female').classList.toggle('selected', g === 'female');
}

function startGame() {
    // 1. Reset Player
    player.hp = 100; player.maxHp = 100;
    player.cultivation = 0;
    player.str = 10 + Math.floor(Math.random()*5);
    player.int = 10 + Math.floor(Math.random()*5);
    player.luck = 10 + Math.floor(Math.random()*5);
    player.money = 20 + Math.floor(Math.random()*20);
    player.round = 1;

    // 2. Pick Identity
    const iden = identities[Math.floor(Math.random() * identities.length)];
    player.identity = iden;
    iden.init(player); // Apply init bonus

    // 3. UI Update
    display.identity.innerText = iden.name;
    screens.start.classList.remove('active');
    screens.game.classList.add('active');

    // Float text for identity
    setTimeout(() => showFloat(`å‡ºèº«ï¼š${iden.name}`, '#8e44ad'), 500);

    updateUI();
    loadEvent();
}

function updateUI() {
    display.hpVal.innerText = `${player.hp}/${player.maxHp}`;
    let pct = (player.hp / player.maxHp) * 100;
    display.hpBar.style.width = Math.max(0, pct) + '%';
    display.hpBar.style.background = pct < 30 ? '#e55039' : '#26de81';

    display.cult.innerText = player.cultivation;
    display.str.innerText = player.str;
    display.int.innerText = player.int;
    display.luck.innerText = player.luck;
    display.money.innerText = player.money;
    display.round.innerText = player.round;
}

function loadEvent() {
    if (player.hp <= 0) return endGame("dead");
    if (player.round > MAX_ROUNDS) return endGame("win");

    // Random Event
    const ev = eventPool[Math.floor(Math.random() * eventPool.length)];
    
    display.eventIcon.innerText = ev.icon;
    display.eventTitle.innerText = ev.title;
    display.eventDesc.innerText = ev.desc;
    
    // Render Choices
    display.choicesBox.innerHTML = '';
    ev.choices.forEach(c => {
        let btn = document.createElement('div');
        btn.className = 'choice-item';

        // Calculate Probability
        let prob = 100;
        let diff = c.diff || 0;
        let statVal = 0;
        let isBonus = false;

        if(c.type === 'str') statVal = player.str;
        if(c.type === 'int') statVal = player.int;
        if(c.type === 'luck') statVal = player.luck;

        if (['str','int','luck'].includes(c.type)) {
            // Formula: 70 + (Stat - Diff)*2 + IdentityBonus
            prob = 65 + (statVal - diff) * 2;
            
            // Check Identity Bonus
            if (player.identity.type === c.type || player.identity.type === 'all' || (player.identity.type === 'mix_str_luck' && (c.type==='str'||c.type==='luck'))) {
                prob += 15;
                isBonus = true;
            }
            
            prob = Math.min(95, Math.max(5, prob));
        }

        let tagClass = 'tag-mid';
        let tagText = '';

        if (c.type === 'free') {
            tagClass = 'tag-safe'; tagText = 'å®‰å…¨';
        } else if (c.type === 'money') {
            tagClass = 'tag-safe'; tagText = `-${c.cost} éˆçŸ³`;
        } else {
            tagText = `${Math.floor(prob)}% æˆåŠŸ`;
            if (diff >= 50) tagClass = 'tag-high'; // High risk
            else if (diff <= 25) tagClass = 'tag-safe';
            else tagClass = 'tag-mid';
        }
        
        if (isBonus) {
            tagText += " (å¤©è³¦UP)";
            tagClass = 'tag-bonus';
        }

        // Check disabled
        let disabled = (c.type === 'money' && player.money < c.cost);
        if (disabled) {
            btn.style.opacity = 0.5;
            tagText = 'éˆçŸ³ä¸è¶³';
            tagClass = 'tag-high';
        }

        btn.innerHTML = `
            <div class="choice-main">${c.txt}</div>
            <div class="choice-meta">
                <span>${getStatName(c.type)}</span>
                <span class="tag ${tagClass}">${tagText}</span>
            </div>
        `;

        if(!disabled) btn.onclick = () => resolveChoice(c, prob);
        
        display.choicesBox.appendChild(btn);
    });
}

function getStatName(t) {
    if(t==='str') return 'é«”é­„åˆ¤å®š';
    if(t==='int') return 'æ‚Ÿæ€§åˆ¤å®š';
    if(t==='luck') return 'æ©Ÿç·£åˆ¤å®š';
    if(t==='money') return 'æ¶ˆè€—éˆçŸ³';
    return 'ç„¡é ˆåˆ¤å®š';
}

function resolveChoice(c, prob) {
    let success = false;
    if (c.type === 'free' || c.type === 'money') success = true;
    else {
        success = Math.random() * 100 < prob;
    }

    if (c.type === 'money') player.money -= c.cost;

    let msg = success ? c.succ : c.fail;
    let eff = success ? c.succEff : c.failEff;
    
    // Apply effects
    let changesHTML = '';
    if (eff) {
        if(eff.hp) { apply('hp', eff.hp); changesHTML += pill('hp', eff.hp); }
        if(eff.money) { apply('money', eff.money); changesHTML += pill('éˆçŸ³', eff.money); }
        if(eff.cultivation) { apply('cultivation', eff.cultivation); changesHTML += pill('ä¿®ç‚º', eff.cultivation); }
        if(eff.str) { apply('str', eff.str); changesHTML += pill('é«”é­„', eff.str); }
        if(eff.int) { apply('int', eff.int); changesHTML += pill('æ‚Ÿæ€§', eff.int); }
        if(eff.luck) { apply('luck', eff.luck); changesHTML += pill('æ©Ÿç·£', eff.luck); }
    }

    display.resTitle.innerText = success ? "åˆ¤å®šæˆåŠŸ" : "åˆ¤å®šå¤±æ•—";
    display.resTitle.className = "result-title " + (success ? "text-green" : "text-red");
    display.resIcon.innerText = success ? "ğŸ‰" : "ğŸ’¥";
    display.resText.innerText = msg;
    display.resChanges.innerHTML = changesHTML;

    screens.modal.style.display = 'flex';
}

function apply(key, val) {
    player[key] += val;
    if(key === 'hp' && player.hp > player.maxHp) player.hp = player.maxHp;
    updateUI();
}

function pill(name, val) {
    let cls = val > 0 ? 'pill-good' : 'pill-bad';
    let sign = val > 0 ? '+' : '';
    if(name === 'hp') name = 'å£½å…ƒ';
    return `<div class="change-pill ${cls}">${name} ${sign}${val}</div>`;
}

function nextEvent() {
    screens.modal.style.display = 'none';
    player.round++;
    updateUI();
    loadEvent();
}

function showFloat(text, color) {
    let el = document.createElement('div');
    el.className = 'float-text';
    el.innerText = text;
    el.style.color = color;
    el.style.left = '50%';
    el.style.top = '40%';
    el.style.transform = 'translateX(-50%)';
    document.getElementById('app-container').appendChild(el);
    setTimeout(()=>el.remove(), 1200);
}

function endGame(type) {
    screens.game.classList.remove('active');
    screens.modal.style.display = 'none';
    screens.end.classList.add('active');

    // Fill Summary
    display.endCult.innerText = player.cultivation;
    display.endStr.innerText = player.str;
    display.endInt.innerText = player.int;
    display.endLuck.innerText = player.luck;
    display.endMoney.innerText = player.money;

    let rank = 'C';
    let title = 'è·¯äººç”²';
    let desc = 'ä¿®ä»™è·¯æ¼«æ¼«ï¼Œä½ æœ€çµ‚é‚„æ˜¯æ­¸æ–¼å¹³å‡¡ã€‚';

    if (type === 'dead') {
        rank = 'F'; title = 'é“æ¶ˆèº«æ­»'; desc = 'å‡ºå¸«æœªæ·èº«å…ˆæ­»ï¼Œé•·ä½¿è‹±é›„æ·šæ»¿è¥Ÿã€‚';
    } else {
        let score = player.cultivation + (player.str+player.int+player.luck)*2 + player.money/2;
        if (score > 800) { rank = 'SSS'; title = 'ä»™å¸è½‰ä¸–'; desc = 'ä½ å·²ç¶“ç„¡æ•µäº†ï¼Œé€™å±†ä¿®ä»™è€…ä¸€å€‹èƒ½æ‰“çš„éƒ½æ²’æœ‰ã€‚'; }
        else if (score > 600) { rank = 'S'; title = 'ä¸€æ–¹å·¨æ“˜'; desc = 'é–‹å®—ç«‹æ´¾ï¼Œå—è¬äººæ™¯ä»°ã€‚'; }
        else if (score > 450) { rank = 'A'; title = 'å…ƒå¬°è€ç¥–'; desc = 'é›–ç„¶ä¸æ˜¯æœ€å¼·ï¼Œä½†ä¹Ÿé€é™è‡ªåœ¨ã€‚'; }
        else if (score > 300) { rank = 'B'; title = 'çµä¸¹ä¿®å£«'; desc = 'æ¯”ä¸Šä¸è¶³ï¼Œæ¯”ä¸‹æœ‰é¤˜ã€‚'; }
    }

    display.endRank.innerText = rank;
    display.endTitle.innerText = title;
    display.endDesc.innerText = desc;
}

function resetGame() {
    screens.end.classList.remove('active');
    screens.start.classList.add('active');
}

</script>
</body>
</html>