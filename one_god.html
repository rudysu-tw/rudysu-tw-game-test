<!DOCTYPE html>
<html lang="zh-TW">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°è¦ç±³ä¿®ä»™ä¹‹æ—… V5.1 (ä¿®å¾©ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a69bd;
            --primary-dark: #1e3799;
            --accent: #e55039;
            --mid-risk: #f39c12;
            --success: #27ae60;
            --warning: #f7b731;
            --special: #8e44ad;
            --text-main: #2f3542;
            --bg-color: #f1f2f6;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background: #2f3640;
            color: var(--text-main);
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        @media (min-width: 501px) {
            #app-container {
                max-width: 480px;
                height: 95vh;
                border-radius: 20px;
                border: 8px solid #dfe4ea;
            }
        }

        /* ç•«é¢åˆ‡æ›é‚è¼¯ (ä¿®å¾©ç™½å±å•é¡Œ) */
        .screen {
            flex: 1;
            display: none; /* é è¨­å®Œå…¨éš±è— */
            flex-direction: column;
            padding: 20px;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            animation: fadeIn 0.4s ease; /* åŠ å…¥æ·¡å…¥å‹•ç•« */
        }

        .screen.active {
            display: flex; /* å•Ÿå‹•æ™‚é¡¯ç¤º */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* UI å…ƒä»¶æ¨£å¼ */
        h1 { font-size: 1.8rem; color: var(--primary-dark); margin: 10px 0; text-align: center; }

        .btn {
            border: none; outline: none; cursor: pointer;
            font-family: inherit; font-weight: bold;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }

        .btn-lg {
            width: 80%; padding: 15px; font-size: 1.1rem;
            color: white; background: var(--primary);
            border-radius: 50px;
            box-shadow: 0 4px 0 var(--primary-dark);
            margin: 20px auto; display: block;
        }

        .gender-box { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .gender-option {
            width: 80px; height: 80px; border-radius: 15px; background: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 2rem; border: 3px solid transparent;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .gender-option.selected { border-color: var(--primary); background: #eef2ff; }
        .gender-option span { font-size: 0.9rem; margin-top: 5px; font-weight: bold; }

        /* Status Bar */
        .top-bar {
            background: white; padding: 10px 15px; border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px;
            flex-shrink: 0;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; }
        .stat-box { background: #f1f2f6; padding: 4px; border-radius: 8px; font-size: 0.75rem; color: #747d8c; }
        .stat-box span { display: block; font-size: 1rem; color: var(--text-main); font-weight: bold; }
        .hp-container { width: 100%; background: #dfe4ea; height: 8px; border-radius: 4px; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.3s; }
        
        .identity-badge {
            background: var(--special); color: white; padding: 2px 8px;
            border-radius: 10px; font-size: 0.75rem; margin-left: 5px;
        }

        /* Events */
        .event-container {
            flex: 1; padding: 10px 0; display: flex; flex-direction: column;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .story-card {
            background: white; border-radius: 15px; padding: 20px; margin: 0 10px 15px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; border-top: 4px solid var(--primary);
            flex-shrink: 0;
        }
        .story-icon { font-size: 4rem; display: block; margin: 0 auto 10px auto; }
        .story-title { font-size: 1.3rem; font-weight: bold; color: var(--text-main); margin-bottom: 10px;}
        .story-desc { color: #57606f; text-align: justify; line-height: 1.6; font-size: 1rem; }

        @media (max-width: 500px) {
            .story-icon { font-size: 3rem; }
            .story-title { font-size: 1.2rem; }
            .story-desc { font-size: 0.95rem; }
        }

        .choices-list { padding: 0 10px 20px 10px; display: flex; flex-direction: column; gap: 10px; }
        .choice-item {
            background: white; border: 1px solid #dfe4ea; border-radius: 12px; padding: 15px;
            cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background 0.2s; border-left: 5px solid transparent;
        }
        .choice-item:active { background: #f1f2f6; transform: scale(0.98); }
        
        .risk-high { border-left-color: var(--accent); }
        .risk-mid { border-left-color: var(--mid-risk); }
        .risk-safe { border-left-color: var(--success); }

        .choice-main { font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: var(--text-main); display: flex; justify-content: space-between; }
        .choice-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #747d8c; }

        .tag { padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
        .tag-high { color: var(--accent); background: rgba(229, 80, 57, 0.1); }
        .tag-mid { color: var(--mid-risk); background: rgba(243, 156, 18, 0.1); }
        .tag-safe { color: var(--success); background: rgba(39, 174, 96, 0.1); }
        .tag-bonus { color: var(--special); background: rgba(142, 68, 173, 0.1); border: 1px solid var(--special); }

        /* Modal */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 100; display: none; justify-content: center; align-items: center;
            padding: 20px; animation: modalFade 0.2s;
        }
        @keyframes modalFade { from {opacity: 0;} to {opacity: 1;} }

        .modal-card {
            background: white; width: 90%; max-width: 360px;
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .result-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--accent); }
        
        .changes-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin: 15px 0; }
        .change-pill {
            font-size: 0.8rem; padding: 3px 8px; border-radius: 6px;
            background: #f1f2f6; font-weight: bold;
        }
        .pill-good { color: var(--success); border: 1px solid var(--success); }
        .pill-bad { color: var(--accent); border: 1px solid var(--accent); }

        /* End Screen */
        .summary-box { background: white; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: left; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        .float-text {
            position: absolute; font-weight: bold; font-size: 1.5rem; pointer-events: none;
            animation: floatUp 1.2s forwards; z-index: 99; text-shadow: 2px 2px 0 #fff;
            width: 100%; text-align: center; left: 0;
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }
    </style>
</head>
<body>

<div id="app-container">
    
    <!-- START SCREEN -->
    <div id="start-screen" class="screen active" style="justify-content: center; overflow-y: auto;">
        <div style="text-align: center; padding: 20px;">
            <div style="color: var(--accent); font-weight: bold; transform: rotate(-3deg); display: inline-block; border: 2px solid var(--accent); padding: 5px 10px; border-radius: 8px; margin-bottom: 10px;">V5.1 ä¿®å¾©ç‰ˆ</div>
            <h1>å°è¦ç±³ä¿®ä»™ä¹‹æ—…</h1>
            
            <p style="color: #666; font-size: 0.9rem;">å–®æŒ‡é€†å¤©ï¼Œç¬‘çœ‹ç´…å¡µ</p>
            <div class="gender-box">
                <div class="gender-option selected" onclick="selectGender('male')" id="btn-male">
                    ğŸ‘¦<span>å°‘ä¿ </span>
                </div>
                <div class="gender-option" onclick="selectGender('female')" id="btn-female">
                    ğŸ‘§<span>ä¿ å¥³</span>
                </div>
            </div>

            <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 0.85rem; color: #555; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); line-height: 1.6;">
                <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">ğŸ”§ æ›´æ–°èªªæ˜ï¼š</div>
                1. ä¿®æ­£äº†é€²å…¥éŠæˆ²å¾Œç™½ç•«é¢çš„å•é¡Œã€‚<br>
                2. å„ªåŒ–äº†æ‰‹æ©Ÿç‰ˆé¢é¡¯ç¤ºã€‚<br>
                3. å¹³è¡¡äº†é«˜/ä¸­/ä½é¢¨éšªé¸é …çš„æ©Ÿç‡ã€‚
            </div>

            <button class="btn btn-lg" onclick="startGame()">è¼ªè¿´è½‰ä¸– (é–‹å§‹)</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
        <div class="top-bar">
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #666;">
                <span style="font-weight: bold; color: var(--primary);">å£½å…ƒ(HP)</span>
                <span id="disp-hp-val">100/100</span>
            </div>
            <div class="hp-container">
                <div id="hp-bar" class="hp-fill"></div>
            </div>

            <div class="stats-grid" style="margin-top: 5px;">
                <div class="stat-box">ä¿®ç‚º<span id="disp-cult">0</span></div>
                <div class="stat-box">é«”é­„<span id="disp-str">10</span></div>
                <div class="stat-box">æ‚Ÿæ€§<span id="disp-int">10</span></div>
                <div class="stat-box">æ©Ÿç·£<span id="disp-luck">10</span></div>
            </div>
            
            <div style="border-top: 1px dashed #ddd; padding-top: 5px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                <div style="display: flex; align-items: center;">
                    <span>ğŸ’° <b id="disp-money">0</b></span>
                    <span id="identity-tag" class="identity-badge">å‡¡äºº</span>
                </div>
                <span style="background: var(--text-main); color: white; padding: 2px 8px; border-radius: 10px;">ç¬¬ <span id="round-num">1</span>/20 åŠ«</span>
            </div>
        </div>

        <div class="event-container">
            <div class="story-card" id="card-elem">
                <span class="story-icon" id="event-icon">ğŸ”„</span>
                <div class="story-title" id="event-title">å‘½é‹æµè½‰ä¸­...</div>
                <div class="story-desc" id="event-desc">æ­£åœ¨ç”Ÿæˆä½ çš„ä¿®ä»™æ©Ÿç·£...</div>
            </div>

            <div class="choices-list" id="choices-box"></div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="modal-overlay" onclick="nextEvent()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div style="font-size: 3rem; margin-bottom: 10px;" id="res-icon">âœ¨</div>
            <div class="result-title" id="res-title">æˆåŠŸ</div>
            <p style="color: #666; line-height: 1.4; margin-bottom: 15px;" id="res-text">çµæœæè¿°</p>
            <div class="changes-grid" id="res-changes"></div>
            <button class="btn btn-lg" style="margin: 0 auto; width: 100%;" onclick="nextEvent()">ç¹¼çºŒä¿®ä»™</button>
        </div>
    </div>

    <!-- END SCREEN -->
    <div id="end-screen" class="screen" style="overflow-y: auto;">
        <div style="padding: 20px; text-align: center;">
            <div style="font-size: 4rem;" id="end-icon">ğŸ</div>
            <h2 id="end-title" style="margin: 10px 0; color: var(--primary-dark);">çµå±€</h2>
            <p id="end-desc" style="color: #666; line-height: 1.5;">çµå±€æè¿°</p>
            
            <div class="summary-box">
                <div style="text-align: center; margin-bottom: 10px;">
                    <span style="font-size: 4rem; font-weight: bold; color: var(--warning); text-shadow: 2px 2px 0 rgba(0,0,0,0.1);" id="end-rank">C</span>
                    <div style="font-size: 0.8rem; color: #aaa;">ç¶œåˆè©•åƒ¹</div>
                </div>
                
                <div class="summary-row"><span>æœ€çµ‚ä¿®ç‚º</span><b id="end-cult-val">0</b></div>
                <div class="summary-row"><span>é«”é­„</span><b id="end-str-val">0</b></div>
                <div class="summary-row"><span>æ‚Ÿæ€§</span><b id="end-int-val">0</b></div>
                <div class="summary-row"><span>æ©Ÿç·£</span><b id="end-luck-val">0</b></div>
                <div class="summary-row"><span>è²¡å¯Œ</span><b id="end-money-val">0</b></div>
            </div>

            <button class="btn btn-lg" onclick="resetGame()">å†å…¥è¼ªè¿´</button>
        </div>
    </div>
</div>

<script>
/**
 * V5.1 Logic - Fix White Screen & Full Data
 */

let player = {
    gender: 'male', hp: 100, maxHp: 100, cultivation: 0,
    str: 10, int: 10, luck: 10, money: 0, round: 1, identity: null
};

const MAX_ROUNDS = 20;

// èº«ä»½å®šç¾©
const identities = [
    { name: "å¯Œå®¶å­å¼Ÿ", desc: "åˆå§‹éˆçŸ³+150", init: (p)=>{p.money+=150;}, type: 'money' },
    { name: "æ­¦å­¸ä¸–å®¶", desc: "åˆå§‹é«”é­„+25 (é«”é­„åˆ¤å®šUP)", init: (p)=>{p.str+=25;}, type: 'str' },
    { name: "æ›¸é¦™é–€ç¬¬", desc: "åˆå§‹æ‚Ÿæ€§+25 (æ‚Ÿæ€§åˆ¤å®šUP)", init: (p)=>{p.int+=25;}, type: 'int' },
    { name: "å¤©é¸ä¹‹äºº", desc: "åˆå§‹æ©Ÿç·£+25 (æ©Ÿç·£åˆ¤å®šUP)", init: (p)=>{p.luck+=25;}, type: 'luck' },
    { name: "è—¥ç‹å‚³äºº", desc: "åˆå§‹å£½å…ƒ+80", init: (p)=>{p.maxHp+=80; p.hp+=80;}, type: 'hp' },
    { name: "å¸‚äº•æµæ°“", desc: "é«”é­„+15 æ©Ÿç·£+15", init: (p)=>{p.str+=15; p.luck+=15;}, type: 'mix_str_luck' },
    { name: "è½é­„è²´æ—", desc: "åˆå§‹ä¿®ç‚º+150ï¼ŒéˆçŸ³æ­¸é›¶", init: (p)=>{p.cultivation+=150; p.money=0;}, type: 'cult' },
    { name: "è½‰ä¸–ä»™äºº", desc: "å…¨å±¬æ€§+10ï¼ŒéˆçŸ³+30", init: (p)=>{p.str+=10; p.int+=10; p.luck+=10; p.money+=30;}, type: 'all' }
];

// å®Œæ•´äº‹ä»¶åº«
const eventPool = [
    {
        title: "ä¸Šå¤åŠå¡š",
        desc: "ä¸€æŠŠæ•£ç™¼è‘—æ¯€æ»…æ°£æ¯çš„é­”åŠæ’åœ¨çŸ³ç¸«ä¸­ã€‚",
        icon: "âš”ï¸",
        choices: [
            { txt: "å¼·è¡Œæ‹”åŠ", risk: "high", type: "str", succ: "ä½ å¦‚ç¥é­”é™ä¸–ï¼Œæ‹”å‡ºé­”åŠï¼", fail: "åŠæ°£çˆ†ç™¼ï¼Œä½ è¢«éœ‡é£›åè¡€ã€‚", succEff: {cultivation: 120, str: 20}, failEff: {hp: -50} },
            { txt: "æ„Ÿæ‚ŸåŠæ„", risk: "mid", type: "int", succ: "é›–æœªå¾—åŠï¼Œä½†åŠé“å¤§é€²ã€‚", fail: "åäº†åŠå¤©è…¿éº»äº†ã€‚", succEff: {cultivation: 60, int: 5}, failEff: {hp: -10} },
            { txt: "æ’¿æŠŠéµåŠ", risk: "safe", succ: "æ’¿æŠŠæ™®é€šçš„åŠé˜²èº«ã€‚", succEff: {str: 5} }
        ]
    },
    {
        title: "çç“æ£‹å±€",
        desc: "å±±æ´ä¸­ç„¡äººè‡ªå¼ˆçš„æ£‹å±€ï¼Œä¼¼ä¹è˜Šå«å¤©åœ°è‡³ç†ã€‚",
        icon: "â™Ÿï¸",
        choices: [
            { txt: "è½å­ç ´å±€", risk: "high", type: "int", succ: "å‹å¤©åŠå­ï¼å¤©åœ°éˆæ°£çŒé ‚ï¼", fail: "ç®—åŠ›ä¸è¶³ï¼Œå¤§è…¦ç•¶æ©Ÿã€‚", succEff: {cultivation: 150, int: 20}, failEff: {int: -5, hp: -30} },
            { txt: "è§€æ‘©æ£‹è·¯", risk: "mid", type: "int", succ: "ç•¥æœ‰æ‰€å¾—ï¼Œæ£‹è—ç²¾é€²ã€‚", fail: "çœ‹ç¡è‘—äº†ã€‚", succEff: {cultivation: 50, int: 8}, failEff: {hp: -5} },
            { txt: "æ‰“äº‚æ£‹ç›¤", risk: "safe", succ: "ä½ æŠŠæ£‹å­äº‚æ‰”ï¼Œæ„Ÿè¦ºå¾ˆè§£å£“ã€‚", succEff: {hp: 5} }
        ]
    },
    {
        title: "è³­çŸ³å¤§æœƒ",
        desc: "é€™å¡ŠçŸ³é ­æ¨™åƒ¹ 50 éˆçŸ³ï¼Œæœ‰äººèªªè£¡é¢æœ‰ä»™ç‰ã€‚",
        icon: "ğŸ’",
        choices: [
            { txt: "é€è¦–çœ¼é–‹", risk: "high", type: "luck", succ: "é–‹å‡ºæ¥µå“ä»™ç‰ï¼Œå…¨å ´éœ‡é©šï¼", fail: "é–‹å‡ºä¸€å¡ŠéµåµçŸ³ï¼Œæ°£åˆ°åè¡€ã€‚", succEff: {money: 300, cultivation: 50}, failEff: {money: -50, hp: -10} },
            { txt: "æ†‘ç¶“é©—æŒ‘", risk: "mid", type: "int", succ: "å°è³ºä¸€ç­†ã€‚", fail: "çœ‹èµ°çœ¼äº†ã€‚", succEff: {money: 80}, failEff: {money: -20} },
            { txt: "ä¸è²·ç«‹çœ", risk: "safe", succ: "çœ‹ç†±é¬§ä¸å«Œäº‹å¤§ã€‚", succEff: {int: 2} }
        ]
    },
    {
        title: "åˆæ­¡å®—æ‹›è¦ª",
        desc: "åˆæ­¡å®—è–å¥³/è–å­æ­£åœ¨æ‹‹ç¹¡çƒæ‹›è¦ªã€‚",
        icon: "ğŸ’•",
        choices: [
            { txt: "æ¶ç¹¡çƒ", risk: "high", type: "str", succ: "æŠ±å¾—ç¾äºº/å¸¥å“¥æ­¸ï¼Œç²å¾—é›™ä¿®ç§˜æ³•ï¼", fail: "è¢«å…¶ä»–è¿½æ±‚è€…æ‰“æˆè±¬é ­ã€‚", succEff: {cultivation: 100, luck: 20}, failEff: {hp: -40} },
            { txt: "å±•ç¾é­…åŠ›", risk: "mid", type: "luck", succ: "å°æ–¹å°ä½ é’çœ¼æœ‰åŠ ï¼Œé€ä½ ç¦®ç‰©ã€‚", fail: "è¢«ç„¡è¦–äº†ï¼Œå¥½å°·å°¬ã€‚", succEff: {cultivation: 40, money: 30}, failEff: {cultivation: -5} },
            { txt: "èŠ±éŒ¢è²·é€š", risk: "safe", type: "money", cost: 40, succ: "èµ°å¾Œé–€ç²å¾—äº†é¢è©¦æ©Ÿæœƒã€‚", succEff: {cultivation: 20, int: 5} }
        ]
    },
    {
        title: "é­é‡ç¸æ½®",
        desc: "ç„¡æ•¸å¦–ç¸å¥”æ¹§è€Œä¾†ï¼Œå‰è·¯è¢«é˜»ã€‚",
        icon: "ğŸº",
        choices: [
            { txt: "æ“’è³Šæ“’ç‹", risk: "high", type: "str", succ: "è¬è»å¾ä¸­å–ç¸ç‹é¦–ç´šï¼", fail: "è¢«ç¸ç‹ä¸€å£åäº†åŠæˆªã€‚", succEff: {cultivation: 150, str: 15}, failEff: {hp: -60} },
            { txt: "ç¦æ°´æ±å¼•", risk: "mid", type: "int", succ: "ä½ æŠŠç¸æ½®å¼•å‘äº†æ•µå°å®—é–€ã€‚", fail: "å¼•åˆ°äº†è‡ªå·±å®¶é–€å£ã€‚", succEff: {cultivation: 60, money: 20}, failEff: {hp: -20, money: -20} },
            { txt: "èº²åœ°æ´", risk: "safe", succ: "é›–ç„¶æ†‹å±ˆï¼Œä½†æ´»ä¸‹ä¾†äº†ã€‚", succEff: {hp: -5} }
        ]
    },
    {
        title: "æ‹è³£æœƒå£“è»¸",
        desc: "å£“è»¸å¯¶ç‰©æ˜¯å‚³èªªä¸­çš„ã€Œç¯‰åŸºä¸¹ã€ï¼Œèµ·æ‹åƒ¹é«˜æ˜‚ã€‚",
        icon: "ğŸ”¨",
        choices: [
            { txt: "æ®ºäººå¥ªå¯¶", risk: "high", type: "str", succ: "é›–ç„¶åè²è‡­äº†ï¼Œä½†ä¸¹è—¥åˆ°æ‰‹ï¼", fail: "è¢«æ‹è³£å ´ä¾›å¥‰æ‰“æ®˜ã€‚", succEff: {cultivation: 200}, failEff: {hp: -50, cultivation: -20} },
            { txt: "æ’¿æ¼è´—å“", risk: "mid", type: "luck", succ: "åœ¨å»¢å“å€æ·˜åˆ°äº†çœŸå¯¶è²ï¼", fail: "è²·äº†ä¸€å †åƒåœ¾ã€‚", succEff: {cultivation: 80, money: 20}, failEff: {money: -30} },
            { txt: "é«˜åƒ¹ç«¶æ‹", risk: "safe", type: "money", cost: 80, succ: "éŒ¢èƒ½é€šç¥ï¼Œé †åˆ©æ‹¿ä¸‹ã€‚", succEff: {cultivation: 100} }
        ]
    },
    {
        title: "å®—é–€å…§æ²",
        desc: "å¸«å…„å¼Ÿå€‘éƒ½åœ¨ç˜‹ç‹‚åŠ ç­ä¿®ç…‰ï¼Œä½ è¦åŠ å…¥å—ï¼Ÿ",
        icon: "ğŸ˜«",
        choices: [
            { txt: "æ¥µé™ä¿®ç…‰", risk: "high", type: "str", succ: "ä½ æ˜¯æ²ç‹ä¹‹ç‹ï¼ä¿®ç‚ºæš´æ¼²ï¼", fail: "éå‹å€’ä¸‹ï¼Œä½é€²ICUã€‚", succEff: {cultivation: 100, str: 10}, failEff: {hp: -40} },
            { txt: "æ‘¸é­šä¿®ç…‰", risk: "mid", type: "int", succ: "å‹é€¸çµåˆï¼Œæ•ˆæœä¸éŒ¯ã€‚", fail: "è¢«å¸«å‚…ç™¼ç¾å·æ‡¶ï¼Œç½°ç«™ã€‚", succEff: {cultivation: 40}, failEff: {cultivation: -10} },
            { txt: "ç›´æ¥æ“ºçˆ›", risk: "safe", succ: "åªè¦æˆ‘èººå¾—å¤ å¹³ï¼Œå°±ä¸æœƒè·Œå€’ã€‚", succEff: {hp: 10} }
        ]
    },
    {
        title: "ç¥ç§˜ç›²ç›’",
        desc: "ä¿®ä»™ç•Œæµè¡Œçš„æ‰­è›‹æ©Ÿï¼Œ100%æœ‰çï¼Ÿ",
        icon: "ğŸ",
        choices: [
            { txt: "è³­éš±è—æ¬¾", risk: "high", type: "luck", succ: "é‡‘å…‰ä¸€é–ƒï¼SSRç¥å™¨ï¼", fail: "å…¨æ˜¯Nå¡åƒåœ¾ã€‚", succEff: {money: 200, str: 20}, failEff: {money: -50} },
            { txt: "é€£æŠ½åæ¬¡", risk: "mid", type: "luck", succ: "ä¿åº•å‡ºè²¨ï¼Œä¸è™§ã€‚", fail: "å…¨æ˜¯ä¿åº•ï¼Œè™§äº†ã€‚", succEff: {money: 50, cultivation: 20}, failEff: {money: -30} },
            { txt: "è²·å€‹ç©ºç›’", risk: "safe", type: "money", cost: 10, succ: "é›–ç„¶æ²’æ±è¥¿ï¼Œä½†ç›’å­æŒºå¥½çœ‹ã€‚", succEff: {int: 5} }
        ]
    },
    {
        title: "æ‡¸å´–å‚³èªª",
        desc: "å‰é¢æœ‰å€‹æ‡¸å´–ï¼Œç‰Œå­ä¸Šå¯«è‘—ã€Œè·³å´–å¾—ç¥åŠŸã€ã€‚",
        icon: "â›°ï¸",
        choices: [
            { txt: "ç›´æ¥è·³", risk: "high", type: "luck", succ: "æ›æ¨¹ä¸Šæ’¿åˆ°æˆ’æŒ‡è€çˆºçˆºï¼", fail: "è‡ªç”±è½é«”ï¼Œå•ªå˜°ã€‚", succEff: {cultivation: 150, int: 20}, failEff: {hp: -70} },
            { txt: "åŠç¹©ä¸‹å»", risk: "mid", type: "int", succ: "ç™¼ç¾å‰äººæ´åºœï¼Œå°æœ‰æ”¶ç©«ã€‚", fail: "ç¹©å­æ–·äº†ï¼Œæ‘”æ–·è…¿ã€‚", succEff: {cultivation: 50, money: 30}, failEff: {hp: -20} },
            { txt: "æ‰”çŸ³é ­", risk: "safe", succ: "è½å€‹éŸ¿ï¼Œç¢ºèªæ˜¯å¯¦å¿ƒçš„ã€‚", succEff: {int: 2} }
        ]
    },
    {
        title: "å¤©åŠ«é™è‡¨",
        desc: "çƒé›²å¯†ä½ˆï¼Œé›·åŠ«å°‡è‡³ï¼Œé¿ç„¡å¯é¿ï¼",
        icon: "âš¡",
        choices: [
            { txt: "è‚‰èº«æŠ—é›·", risk: "high", type: "str", succ: "é›·éœ†æ·¬é«”ï¼Œé‡‘å‰›ä¸å£ï¼", fail: "è¢«åŠˆæˆé»‘ç‚­ï¼Œå¥„å¥„ä¸€æ¯ã€‚", succEff: {cultivation: 120, str: 30}, failEff: {hp: -60} },
            { txt: "ä½ˆé™£å¼•é›·", risk: "mid", type: "int", succ: "å°‡é›·é›»è½‰åŒ–ç‚ºéˆåŠ›å¸æ”¶ã€‚", fail: "é™£æ³•æ¼é›»ã€‚", succEff: {cultivation: 70}, failEff: {hp: -20} },
            { txt: "æ³•å¯¶æ“‹ç½", risk: "safe", type: "money", cost: 50, succ: "æ³•å¯¶ç¢äº†ï¼Œäººæ²’äº‹ã€‚", succEff: {hp: 5} }
        ]
    },
    {
        title: "è·¯é‡ä¹ä¸",
        desc: "ä¸€å€‹é«’å…®å…®çš„ä¹ä¸æ””ä½ä½ ï¼Œèªªä½ éª¨éª¼é©šå¥‡ã€‚",
        icon: "ğŸ¦´",
        choices: [
            { txt: "æ‹œå¸«å­¸è—", risk: "high", type: "luck", succ: "ä»–æ˜¯éš±ä¸–é«˜æ‰‹ï¼å‚³ä½ çµ•å­¸ï¼", fail: "ä»–æ˜¯é¨™å­ï¼Œé¨™ä½ èº«å­ã€‚", succEff: {cultivation: 150, str: 10}, failEff: {money: -50, hp: -10} },
            { txt: "æ¢æŸ¥è™›å¯¦", risk: "mid", type: "int", succ: "ç™¼ç¾ä»–æ˜¯é­”æ•™æ¢å­ï¼Œèˆ‰å ±æœ‰çã€‚", fail: "çœ‹ä¸é€ï¼Œè¢«ä»–å˜²ç¬‘ã€‚", succEff: {money: 50}, failEff: {int: -5} },
            { txt: "çµ¦éŒ¢æ‰“ç™¼", risk: "safe", type: "money", cost: 10, succ: "æ—¥è¡Œä¸€å–„ã€‚", succEff: {luck: 5} }
        ]
    },
    {
        title: "ç…‰ä¸¹æˆ¿",
        desc: "ä½ å˜—è©¦ç…‰è£½å‚³èªªä¸­çš„ã€Œä¹è½‰é‡‘ä¸¹ã€ã€‚",
        icon: "ğŸ’Š",
        choices: [
            { txt: "åŠ å…¥çŒ›æ–™", risk: "high", type: "int", succ: "ä¸¹æˆé¾é³³ç¾ï¼æ¥µå“ç¥ä¸¹ï¼", fail: "ç‚¸çˆäº†ï¼æ¯€å¤©æ»…åœ°ï¼", succEff: {cultivation: 150, hp: 50}, failEff: {hp: -50, money: -50} },
            { txt: "æŒ‰éƒ¨å°±ç­", risk: "mid", type: "int", succ: "ç…‰å‡ºä¸€çˆä¸Šå“ä¸¹è—¥ã€‚", fail: "ç«å€™æ²’æ§å¥½ï¼Œç…‰æˆç„¦ç‚­ã€‚", succEff: {cultivation: 50}, failEff: {money: -10} },
            { txt: "ç…‰å¤§åŠ›ä¸¸", risk: "safe", succ: "ç°¡å–®çš„ä¸¹è—¥ï¼Œå¿…å®šæˆåŠŸã€‚", succEff: {str: 5, money: 10} }
        ]
    }
];

// DOM Elements
const screens = {
    start: document.getElementById('start-screen'),
    game: document.getElementById('game-screen'),
    end: document.getElementById('end-screen'),
    modal: document.getElementById('result-modal')
};

const display = {
    hpVal: document.getElementById('disp-hp-val'),
    hpBar: document.getElementById('hp-bar'),
    cult: document.getElementById('disp-cult'),
    str: document.getElementById('disp-str'),
    int: document.getElementById('disp-int'),
    luck: document.getElementById('disp-luck'),
    money: document.getElementById('disp-money'),
    round: document.getElementById('round-num'),
    identity: document.getElementById('identity-tag'),
    
    eventIcon: document.getElementById('event-icon'),
    eventTitle: document.getElementById('event-title'),
    eventDesc: document.getElementById('event-desc'),
    choicesBox: document.getElementById('choices-box'),
    
    // Result Modal
    resIcon: document.getElementById('res-icon'),
    resTitle: document.getElementById('res-title'),
    resText: document.getElementById('res-text'),
    resChanges: document.getElementById('res-changes'),
    
    // End
    endRank: document.getElementById('end-rank'),
    endTitle: document.getElementById('end-title'),
    endDesc: document.getElementById('end-desc'),
    endCult: document.getElementById('end-cult-val'),
    endStr: document.getElementById('end-str-val'),
    endInt: document.getElementById('end-int-val'),
    endLuck: document.getElementById('end-luck-val'),
    endMoney: document.getElementById('end-money-val')
};

function selectGender(g) {
    player.gender = g;
    document.getElementById('btn-male').classList.toggle('selected', g === 'male');
    document.getElementById('btn-female').classList.toggle('selected', g === 'female');
}

function startGame() {
    try {
        // 1. Reset
        player.hp = 100; player.maxHp = 100;
        player.cultivation = 0;
        player.str = 10; player.int = 10; player.luck = 10; player.money = 20;
        player.round = 1;

        // 2. Identity
        const iden = identities[Math.floor(Math.random() * identities.length)];
        player.identity = iden;
        iden.init(player);

        display.identity.innerText = iden.name;
        
        // 3. Screen Switch (Display none -> flex)
        screens.start.classList.remove('active');
        screens.game.classList.add('active');

        // 4. Float Text
        setTimeout(() => showFloat(`å‡ºèº«ï¼š${iden.name}`, '#8e44ad'), 300);
        
        // 5. Load
        updateUI();
        loadEvent();
    } catch (e) {
        alert("éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚\n" + e);
    }
}

function updateUI() {
    display.hpVal.innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
    let pct = (player.hp / player.maxHp) * 100;
    display.hpBar.style.width = Math.max(0, pct) + '%';
    display.hpBar.style.background = pct < 30 ? '#e55039' : '#27ae60';

    display.cult.innerText = player.cultivation;
    display.str.innerText = player.str;
    display.int.innerText = player.int;
    display.luck.innerText = player.luck;
    display.money.innerText = player.money;
    display.round.innerText = player.round;
}

function loadEvent() {
    if (player.hp <= 0) return endGame("dead");
    if (player.round > MAX_ROUNDS) return endGame("win");

    const ev = eventPool[Math.floor(Math.random() * eventPool.length)];
    
    display.eventIcon.innerText = ev.icon;
    display.eventTitle.innerText = ev.title;
    display.eventDesc.innerText = ev.desc;
    
    display.choicesBox.innerHTML = '';
    ev.choices.forEach(c => {
        let btn = document.createElement('div');
        let riskClass = c.risk === 'high' ? 'risk-high' : (c.risk === 'mid' ? 'risk-mid' : 'risk-safe');
        btn.className = `choice-item ${riskClass}`;

        // CALC PROBABILITY
        let prob = 100;
        let statVal = 0;
        let statName = "";
        
        if (c.type === 'str') { statVal = player.str; statName = "é«”é­„"; }
        if (c.type === 'int') { statVal = player.int; statName = "æ‚Ÿæ€§"; }
        if (c.type === 'luck') { statVal = player.luck; statName = "æ©Ÿç·£"; }

        if (c.risk === 'high') {
            // High Risk: Base 30% + Stat. Max 60%.
            prob = 30 + statVal; 
            if (prob > 60) prob = 60;
        } else if (c.risk === 'mid') {
            // Mid Risk: Base 60% + Stat. Max 90%.
            prob = 60 + statVal;
            if (prob > 90) prob = 90;
        } else {
            // Safe
            prob = 100;
        }

        // Identity Bonus (+15% break cap if matching type)
        let isBonus = false;
        if (player.identity && (player.identity.type === 'all' || player.identity.type === c.type || (player.identity.type === 'mix_str_luck' && (c.type==='str'||c.type==='luck')))) {
            if (c.risk !== 'safe') {
                prob += 15;
                isBonus = true;
            }
        }

        // Render UI Text
        let badgeClass = c.risk === 'high' ? 'tag-high' : (c.risk === 'mid' ? 'tag-mid' : 'tag-safe');
        let badgeText = "";
        
        if (c.risk === 'safe') {
            if (c.type === 'money') badgeText = `-${c.cost} éˆçŸ³`;
            else badgeText = "100% å®‰å…¨";
        } else {
            badgeText = `${Math.floor(prob)}%`;
            if (isBonus) badgeText += " (â†‘å¤©è³¦)";
        }

        // Check Disabled
        let disabled = (c.type === 'money' && player.money < c.cost);
        if (disabled) {
            btn.style.opacity = 0.5;
            badgeText = "éˆçŸ³ä¸è¶³";
            badgeClass = 'tag-high';
        }

        // Stat Requirement Text
        let reqText = c.risk === 'safe' ? 'æ¶ˆè€—/ä¿åº•' : `${statName}åˆ¤å®š`;

        btn.innerHTML = `
            <div class="choice-main">
                <span>${c.txt}</span>
                <span class="tag ${badgeClass}">${badgeText}</span>
            </div>
            <div class="choice-meta">
                <span>${reqText}</span>
                <span style="font-size:0.7rem; color:#aaa;">${c.risk==='high'?'é«˜å›å ±':(c.risk==='mid'?'ä¸­å›å ±':'ç©©å¥')}</span>
            </div>
        `;

        if (!disabled) {
            btn.onclick = () => resolveChoice(c, prob);
        }
        display.choicesBox.appendChild(btn);
    });
}

function resolveChoice(c, prob) {
    let success = false;
    if (c.risk === 'safe') success = true;
    else {
        success = Math.random() * 100 < prob;
    }

    if (c.type === 'money') player.money -= c.cost;

    let msg = success ? c.succ : c.fail;
    let eff = success ? c.succEff : c.failEff;
    
    // Apply effects
    let changesHTML = '';
    if (eff) {
        if(eff.hp) { apply('hp', eff.hp); changesHTML += pill('hp', eff.hp); }
        if(eff.money) { apply('money', eff.money); changesHTML += pill('éˆçŸ³', eff.money); }
        if(eff.cultivation) { apply('cultivation', eff.cultivation); changesHTML += pill('ä¿®ç‚º', eff.cultivation); }
        if(eff.str) { apply('str', eff.str); changesHTML += pill('é«”é­„', eff.str); }
        if(eff.int) { apply('int', eff.int); changesHTML += pill('æ‚Ÿæ€§', eff.int); }
        if(eff.luck) { apply('luck', eff.luck); changesHTML += pill('æ©Ÿç·£', eff.luck); }
    }

    display.resTitle.innerText = success ? "åˆ¤å®šæˆåŠŸ" : "åˆ¤å®šå¤±æ•—";
    display.resTitle.className = "result-title " + (success ? "text-green" : "text-red");
    display.resIcon.innerText = success ? "ğŸ‰" : "ğŸ’¥";
    display.resText.innerText = msg;
    display.resChanges.innerHTML = changesHTML;

    screens.modal.style.display = 'flex';
}

function apply(key, val) {
    player[key] += val;
    if(key === 'hp' && player.hp > player.maxHp) player.hp = player.maxHp;
    updateUI();
}

function pill(name, val) {
    let cls = val > 0 ? 'pill-good' : 'pill-bad';
    let sign = val > 0 ? '+' : '';
    if(name === 'hp') name = 'å£½å…ƒ';
    return `<div class="change-pill ${cls}">${name} ${sign}${val}</div>`;
}

function nextEvent() {
    screens.modal.style.display = 'none';
    player.round++;
    updateUI();
    loadEvent();
}

function showFloat(text, color) {
    let el = document.createElement('div');
    el.className = 'float-text';
    el.innerText = text;
    el.style.color = color;
    el.style.top = '40%';
    document.getElementById('app-container').appendChild(el);
    setTimeout(()=>el.remove(), 1200);
}

function endGame(type) {
    screens.game.classList.remove('active');
    screens.modal.style.display = 'none';
    screens.end.classList.add('active');

    display.endCult.innerText = player.cultivation;
    display.endStr.innerText = player.str;
    display.endInt.innerText = player.int;
    display.endLuck.innerText = player.luck;
    display.endMoney.innerText = player.money;

    let rank = 'C';
    let title = 'è·¯äººç”²';
    let desc = 'ä¿®ä»™è·¯æ¼«æ¼«ï¼Œä½ æœ€çµ‚é‚„æ˜¯æ­¸æ–¼å¹³å‡¡ã€‚';
    
    let totalScore = player.cultivation + (player.str + player.int + player.luck) * 5 + player.money;

    if (type === 'dead') {
        rank = 'F'; title = 'é“æ¶ˆèº«æ­»'; desc = 'å‡ºå¸«æœªæ·èº«å…ˆæ­»ï¼Œè«‹å¤§ä¿ é‡æ–°ä¾†éã€‚';
    } else {
        if (totalScore > 1000) { rank = 'SSS'; title = 'ä»™å¸è½‰ä¸–'; desc = 'ä½ çš„åå­—éŸ¿å¾¹ä¸‰ç•Œï¼Œç¨æ–·è¬å¤ï¼'; }
        else if (totalScore > 800) { rank = 'SS'; title = 'é£›æ˜‡å¤§èƒ½'; desc = 'è·é›¢æˆä»™åƒ…ä¸€æ­¥ä¹‹é™ã€‚'; }
        else if (totalScore > 600) { rank = 'S'; title = 'ä¸€æ–¹å·¨æ“˜'; desc = 'é–‹å®—ç«‹æ´¾ï¼Œå—è¬äººæ™¯ä»°ã€‚'; }
        else if (totalScore > 400) { rank = 'A'; title = 'å…ƒå¬°è€ç¥–'; desc = 'é€é™è‡ªåœ¨ï¼Œå£½å…ƒç¶¿é•·ã€‚'; }
        else if (totalScore > 200) { rank = 'B'; title = 'çµä¸¹ä¿®å£«'; desc = 'æ¯”ä¸Šä¸è¶³ï¼Œæ¯”ä¸‹æœ‰é¤˜ã€‚'; }
    }

    display.endRank.innerText = rank;
    display.endTitle.innerText = title;
    display.endDesc.innerText = desc;
}

function resetGame() {
    screens.end.classList.remove('active');
    screens.start.classList.add('active');
}
</script>
</body>
</html>

