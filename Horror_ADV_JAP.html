<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 關鍵：viewport 設定，禁止縮放，適配安全區域 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>鳴神村異聞：黃泉之際</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 配色與基礎設定 --- */
        :root {
            --bg-color: #1a1510;
            --text-color: #d0c0a8;
            --accent-color: #a83232;
            --san-color: #aed6f1;
            --hp-color: #c0392b;
            --courage-color: #d35400;
            --insight-color: #8e44ad;
            --item-color: #f7dc6f;
            --ui-bg: #241c14;
            --border-color: #544a3d;
            --success-color: #27ae60;
            --fail-color: #c0392b;
            --fuel-color: #e67e22;
            --event-color: #e74c3c;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* 全螢幕鎖定，防止捲動 */
        body { 
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: "Yu Mincho", "Hiragino Mincho ProN", "Microsoft JhengHei", "serif"; 
            height: 100vh; 
            height: 100dvh; /* Mobile fix */
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        #app-container { 
            width: 100%; 
            max-width: 900px; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            background: var(--ui-bg); 
            position: relative; 
            z-index: 5; 
            box-shadow: 0 0 40px rgba(0,0,0,0.95);
            /* 電腦版加邊框，手機版滿版 */
            border-left: 1px solid var(--border-color); 
            border-right: 1px solid var(--border-color); 
        }
        
        /* 視覺特效層 */
        #vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; box-shadow: inset 0 0 100px rgba(0,0,0,0.9); z-index: 10; transition: box-shadow 0.5s ease; }
        .pulse-fast { animation: heartbeat 0.8s infinite; }
        .pulse-slow { animation: heartbeat 2s infinite; }
        @keyframes heartbeat { 0% { box-shadow: inset 0 0 50px rgba(168, 50, 50, 0.3); } 50% { box-shadow: inset 0 0 150px rgba(168, 50, 50, 0.7); } 100% { box-shadow: inset 0 0 50px rgba(168, 50, 50, 0.3); } }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .text-distort { text-shadow: 2px 0 var(--hp-color), -2px 0 var(--san-color); animation: glitch-text 0.2s infinite; }
        @keyframes glitch-text { 0% { transform: translate(0); opacity: 1; } 20% { transform: translate(-1px, 1px); opacity: 0.8; } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, -1px); opacity: 0.9; } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0); opacity: 1; } }
        .hallucination { filter: blur(1px) sepia(0.4) hue-rotate(-10deg) contrast(1.1); transition: filter 1s; }

        @keyframes item-glow { 0% { box-shadow: 0 0 5px var(--item-color); background: #332; } 50% { box-shadow: 0 0 30px var(--item-color), inset 0 0 20px var(--item-color); background: #553; } 100% { box-shadow: 0 0 5px var(--item-color); background: #221; } }
        .item-get-anim { animation: item-glow 0.8s ease-out; }

        /* --- 封面/結束畫面優化 --- */
        #start-screen, #end-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(20, 15, 10, 0.98); 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            z-index: 30; text-align: center; 
            padding: 20px; 
            /* 確保內容不會溢出，使用 Flex 分配空間 */
        }

        h1 { 
            color: var(--accent-color); 
            font-size: 2.2rem; 
            text-shadow: 0 0 15px rgba(168, 50, 50, 0.8); 
            margin: 0 0 10px 0; 
            letter-spacing: 5px; 
            font-weight: bold; 
            flex-shrink: 0; /* 標題不壓縮 */
        }
        
        .subtitle {
            color: #887; 
            margin-bottom: 20px; 
            font-size: 1rem; 
            letter-spacing: 3px; 
            flex-shrink: 0;
        }

        .manual-box {
            width: 100%;
            max-width: 500px;
            background: #241c14; 
            padding: 20px; 
            border: 1px solid #3a2f24; 
            border-radius: 2px; 
            font-size: 0.95rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: left;
            overflow-y: auto; /* 如果內容真的太多，只讓盒子內部捲動 */
            max-height: 60vh; /* 限制最大高度 */
            flex-shrink: 1; /* 允許壓縮 */
        }

        .manual-box ul {
            padding-left: 18px; 
            margin: 5px 0;
            color: #c0b098;
        }
        
        .manual-box li {
            margin-bottom: 6px;
            line-height: 1.5; /* 手機版行高縮小 */
        }

        .start-btn { 
            background: rgba(40, 30, 20, 0.9); 
            color: #d0c0a8; 
            border: 1px solid var(--accent-color); 
            padding: 12px 30px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            margin-top: 25px; 
            flex-shrink: 0;
            transition: all 0.3s; 
            letter-spacing: 3px; 
            box-shadow: 0 0 15px rgba(168, 50, 50, 0.3); 
            border-radius: 2px; 
        }
        .start-btn:hover { background: var(--accent-color); color: #fff; box-shadow: 0 0 30px var(--accent-color); transform: scale(1.05); }

        /* --- 遊戲介面配置 --- */
        header { 
            padding: 8px 12px; 
            border-bottom: 1px solid var(--border-color); 
            background: #1e1610; 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.85rem; 
            letter-spacing: 1px; 
            flex-shrink: 0; /* 絕不壓縮 */
        }
        
        #status-bar { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; 
            background: var(--border-color); padding-bottom: 1px; 
            flex-shrink: 0; 
        }
        .stat-box { display: flex; flex-direction: column; align-items: center; padding: 4px 2px; background: #2a2218; }
        .stat-label { font-size: 0.65rem; color: #887; margin-bottom: 1px; }
        .stat-value { font-weight: bold; font-size: 0.95rem; font-family: monospace; }
        .hp-val { color: var(--hp-color); }
        .san-val { color: var(--san-color); }
        .courage-val { color: var(--courage-color); }
        .ins-val { color: var(--insight-color); }
        .fuel-val { color: var(--fuel-color); }

        #inventory-bar { 
            padding: 4px 10px; 
            background: #1a120a; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; gap: 8px; 
            min-height: 32px; 
            align-items: center; 
            overflow-x: auto; 
            flex-shrink: 0; 
        }
        .inv-item { background: #33281d; border: 1px solid #544a3d; padding: 2px 6px; font-size: 0.7rem; border-radius: 2px; color: var(--item-color); display: flex; align-items: center; gap: 5px; white-space: nowrap; }

        /* 核心調整：故事區域 */
        #story-area { 
            flex: 1 1 auto; /* 佔據所有剩餘空間，是畫面最大的部分 */
            padding: 20px 25px; 
            overflow-y: auto; 
            line-height: 1.8; 
            font-size: 1.1rem; 
            color: #d0c0a8; 
            border-bottom: 1px solid var(--border-color); 
            background-image: radial-gradient(circle at center, #2e241a 0%, #241c14 100%); 
            min-height: 0; /* 允許壓縮，避免撐開容器 */
        }
        .story-text { margin-bottom: 10px; opacity: 0; animation: fadeIn 1s forwards; text-align: justify; word-wrap: break-word; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
        .story-icon { color: var(--accent-color); margin-right: 8px; font-size: 1.2rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* 選項區域調整 */
        #choice-area { 
            padding: 8px 12px; 
            display: grid; 
            grid-template-columns: 1fr; /* 手機單列 */
            gap: 8px; 
            background: #2a2218; 
            flex-shrink: 0; /* 盡量不壓縮選項，因為需要點擊 */
            max-height: 40vh; /* 防止選項太多蓋過故事 */
            overflow-y: auto;
        }
        @media (min-width: 700px) { #choice-area { grid-template-columns: 1fr 1fr; gap: 12px; } }

        .choice-btn { 
            background: linear-gradient(145deg, #362c22, #2e241a); 
            border: 1px solid #4a3f33; 
            color: #c0b098; 
            padding: 10px 10px; /* 緊湊一點 */
            cursor: pointer; 
            font-family: inherit; font-size: 0.9rem; text-align: left; 
            display: flex; flex-direction: column; justify-content: center; 
            border-radius: 2px; position: relative; 
            min-height: 50px; /* 稍微降低最小高度 */
        }
        .choice-title { font-weight: bold; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; color: #e0d0b8; font-size: 0.95rem; }
        .choice-desc { font-size: 0.7rem; color: #998; line-height: 1.25; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .choice-btn:hover { background: #43362a; color: #fff; transform: translateY(-1px); }
        .chance-tag { position: absolute; top: 6px; right: 6px; font-size: 0.65rem; background: #3a2f24; padding: 1px 4px; border-radius: 2px; color: #aaa; border: 1px solid #4a3f33; }
        
        .madness-choice { border-color: var(--accent-color) !important; color: var(--hp-color) !important; animation: shake 2s infinite; background: #2a0f0f; }
        .phantom-choice { border: 1px dashed #544a3d; opacity: 0.9; font-style: italic; }

        /* Log 視窗調整 */
        #log-window { 
            height: 110px; /* 預設高度縮小 */
            background: #100c08; 
            border-top: 2px solid var(--border-color); 
            padding: 8px 10px; 
            font-size: 0.8rem; 
            font-family: monospace; 
            color: #a8a090; 
            overflow-y: scroll; 
            flex-shrink: 0; 
        }
        .log-entry { margin-bottom: 3px; border-bottom: 1px dashed #332; padding-bottom: 2px; line-height: 1.3; }
        .log-new { color: #d0c0a8; border-left: 3px solid var(--insight-color); padding-left: 5px; }
        .log-negative { color: var(--hp-color); border-left-color: var(--hp-color); }
        .log-positive { color: var(--success-color); border-left-color: var(--success-color); }
        .log-info { color: var(--courage-color); border-left-color: var(--courage-color); }
        .log-item { color: var(--item-color); font-weight: bold; border-left-color: var(--item-color); }
        .log-event { color: var(--event-color); font-weight: bold; border-left-color: var(--event-color); }
        .log-phantom { color: #776; font-style: italic; text-decoration: line-through; }

        /* 手機版特別優化 (螢幕高度小於 800px 或 寬度小於 600px) */
        @media (max-height: 850px), (max-width: 600px) {
            h1 { font-size: 1.8rem; margin-bottom: 5px; }
            .subtitle { font-size: 0.9rem; margin-bottom: 15px; }
            
            .manual-box { padding: 15px; font-size: 0.85rem; max-height: 55vh; }
            .manual-box p { margin-bottom: 8px; font-size: 1rem; }
            .manual-box li { margin-bottom: 4px; }
            
            .start-btn { padding: 10px 25px; font-size: 1rem; margin-top: 15px; }
            
            /* 遊戲內介面壓縮 */
            #log-window { height: 90px; } /* Log 變矮 */
            #story-area { padding: 15px 15px; font-size: 1.05rem; }
        }

        /* 骰子動畫層 */
        #dice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20,15,10,0.95); z-index: 25; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #dice-visual { width: 100px; height: 100px; border: 4px solid #d0c0a8; display: flex; justify-content: center; align-items: center; font-size: 3.5rem; font-weight: bold; color: #d0c0a8; background: #2a2218; border-radius: 50%; margin-bottom: 15px; font-family: monospace; }
        .dice-rolling { animation: roll 0.05s infinite; }
        @keyframes roll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(8deg) scale(1.02); } 50% { transform: rotate(0deg) scale(1); } 75% { transform: rotate(-8deg) scale(1.02); } 100% { transform: rotate(0deg) scale(1); } }
        .dice-success { border-color: var(--success-color) !important; color: var(--success-color) !important; box-shadow: 0 0 50px var(--success-color) !important; transform: scale(1.1); }
        .dice-fail { border-color: var(--fail-color) !important; color: var(--fail-color) !important; box-shadow: 0 0 50px var(--fail-color) !important; transform: scale(0.9); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1a1510; }
        ::-webkit-scrollbar-thumb { background: #3a2f24; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="vignette"></div>
    <div id="dice-overlay"><div id="dice-visual">?</div><div id="dice-msg" style="font-size: 1.3rem; color: #d0c0a8; margin-bottom: 8px; font-weight: bold; letter-spacing: 2px;">命運判定...</div><div id="dice-detail" style="font-size: 0.9rem; color: #887;"></div></div>

    <div id="app-container">
        <!-- 封面：文字已精簡，並使用彈性盒模型避免溢出 -->
        <div id="start-screen">
            <h1><i class="fas fa-torii-gate"></i> 鳴神村異聞</h1>
            <p class="subtitle">黃泉之際 - 沉浸怪談版</p>
            <div class="manual-box">
                <p style="color: var(--item-color); font-weight: bold; font-family: 'Yu Mincho', serif;"><i class="fas fa-scroll"></i> 探索手冊</p>
                <ul style="list-style-type: circle;">
                    <li><b>怪異談</b>：追查廢村「鳴神村」慘劇真相的日式恐怖ADV。</li>
                    <li><b>心魂與膽量</b>：歸零即死。心魂抗靈異，膽量抗物理。</li>
                    <li><b>勿熄燈火</b>：黑暗侵蝕精神。請管理「燈油」維持光源。</li>
                    <li><b>民俗智慧</b>：村中傳承與記錄將成為助力。</li>
                </ul>
            </div>
            <button class="start-btn" onclick="game.start()"><i class="fas fa-walking"></i> 踏入廢村</button>
        </div>

        <header>
            <div><i class="fas fa-user-ninja"></i> 探索者：民俗學者 <span id="phobia-display" class="phobia-tag"></span></div>
            <div class="turn-indicator"><i class="far fa-clock"></i> <span id="turn-display">1</span>/18</div>
        </header>

        <section id="status-bar">
            <div class="stat-box"><i class="fas fa-heart hp-val"></i><span class="stat-label">生命</span><span class="stat-value hp-val" id="hp-val">100</span></div>
            <div class="stat-box"><i class="fas fa-ghost san-val"></i><span class="stat-label">心魂</span><span class="stat-value san-val" id="san-val">80</span></div>
            <div class="stat-box"><i class="fas fa-fist-raised courage-val"></i><span class="stat-label">膽量</span><span class="stat-value courage-val" id="courage-val">50</span></div>
            <div class="stat-box"><i class="fas fa-scroll ins-val"></i><span class="stat-label">民俗</span><span class="stat-value ins-val" id="insight-val">10</span></div>
            <div class="stat-box"><i class="fas fa-oil-can fuel-val"></i><span class="stat-label">燈油</span><span class="stat-value fuel-val" id="fuel-val">25</span></div>
        </section>

        <section id="inventory-bar">
            <span style="color:#887; font-size:0.7rem; margin-right: 5px;"><i class="fas fa-briefcase"></i> 持有:</span>
            <div id="inventory-list" style="display:flex; gap:8px;"></div>
        </section>

        <section id="story-area">
            <div id="story-content" class="story-text"></div>
        </section>

        <section id="choice-area"></section>

        <section id="log-window">
            <div id="log-content"></div>
        </section>

        <div id="end-screen" style="display: none;">
            <h1 id="end-title" style="font-family: 'Yu Mincho', serif; letter-spacing: 3px; font-size: 1.8rem;">結局</h1>
            <div id="end-icon" style="font-size: 4rem; margin: 20px 0; color: #554;"></div>
            <p id="end-desc" style="max-width: 600px; margin: 10px 0; line-height: 1.6; font-size: 1rem; color: #c0b098; padding: 0 20px;"></p>
            <div id="end-stats" style="color: #887; font-size: 0.9rem; margin-bottom: 20px; font-family: monospace;"></div>
            
            <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content: center;">
                <button class="start-btn" style="padding:10px 20px; font-size:0.9rem; margin-top:5px;" onclick="game.copyHistory()"><i class="fas fa-copy"></i> 複製記錄</button>
                <button class="start-btn reset-btn" style="padding:10px 20px; font-size:0.9rem; margin-top:5px;" onclick="game.reset()"><i class="fas fa-redo"></i> 再次挑戰</button>
            </div>
        </div>
    </div>

    <script>
        /* --- 遊戲資料與邏輯 --- */
        const PHOBIAS = [
            { id: 'dark', name: '暗恐', desc: '黑暗心魂損耗加倍', icon: 'fa-moon' },
            { id: 'blood', name: '潔癖', desc: '不潔處心魂損耗加倍', icon: 'fa-biohazard' },
            { id: 'noise', name: '聲恐', desc: '突發聲響心魂損耗加倍', icon: 'fa-bell-slash' }
        ];

        const ITEMS = {
            key: { name: "倉庫鑰匙", icon: "fa-key", desc: "打開生鏽倉庫。" },
            crowbar: { name: "柴刀", icon: "fa-hammer", desc: "破壞障礙。膽量+10%。" }, 
            amulet: { name: "淨化鹽", icon: "fa-seedling", desc: "驅除不潔。儀式用。" }, 
            lighter: { name: "和蠟燭", icon: "fa-fire", desc: "手持光源。緩和恐懼。" },
            journal: { name: "祖父手記", icon: "fa-book", desc: "民俗學記錄。民俗+10%。" },
            gun: { name: "火繩槍", icon: "fa-gun", desc: "僅一發子彈。物理驅魔。" },
            medkit: { name: "藥草包", icon: "fa-leaf", desc: "治療傷口。" }, 
            mirror_shard: { name: "手鏡", icon: "fa-mirror", desc: "映照真實。" }
        };

        const FORCED_EVENTS = [
            { msg: "【怪異】背後傳來了「喀啦」的木屐聲...", effect: { san: -5 } },
            { msg: "【怪異】一股生溫的風伴隨線香撲鼻而來。", effect: { courage: -5 } },
            { msg: "【發現】石牆縫隙中發現古老寬永通寶。", effect: { insight: 5 } },
            { msg: "【怪異】天花板垂下了一束黑髮。", effect: { san: -3, hp: -2 } },
            { msg: "【想起】想起了祖父說過的村子習俗。", effect: { insight: 10, san: 2 } },
            { msg: "【發現】倒塌燈籠旁掉落著燈油罐。", effect: { fuel: 5 } },
            { msg: "【怪異】視野角落有白衣一閃而過。", effect: { san: -8 } },
            { msg: "【進食】啃了一口無味的乾飯。", effect: { hp: 5, san: -2 } }
        ];

        const MODULES = {
            A: [
                { text: "穿過霧氣，你抵達了「鳴神村」入口。腐朽的巨大鳥居聳立，前方被濃霧遮蔽。空氣混雜著霉味與血腥味。這是祖父最後失蹤之地。死寂壓迫著你的耳膜。", type: "dark", choices: [
                    { text: "調查鳥居", desc: "柱子根部似乎藏著東西。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'lighter', msg: "在陰影處發現桐木盒，內有未使用的和蠟燭。" }, fail: { hp: -5, msg: "伸手時爬出大量蜈蚣！嚇得縮手跌倒。" } },
                    { text: "尋找足跡", desc: "觀察地面是否有進村痕跡。", icon: "fa-eye", effect: { insight: 5 }, msg: "泥濘地上有無數赤腳小腳印延伸進村。" },
                    { text: "強行突破", desc: "無法忍受詭異氣氛，衝進霧中。", icon: "fa-running", effect: { hp: -10, san: -10 }, msg: "視野不清撞上石碑。肩膀受擊，不安侵蝕內心。", reckless: true }
                ]},
                { text: "來到村子大道。兩旁木造房屋破損嚴重，且每戶屋簷下都掛著臉被塗黑的稻草人。風吹過，人偶齊刷刷搖晃發出聲響。", type: "noise", choices: [
                    { text: "觀察人偶", desc: "雖不舒服，但應有其意義。", icon: "fa-image", effect: { insight: 10, san: -5 }, msg: "人偶背後寫著「替身」。似是為了逃避某物的護身符。" },
                    { text: "搜索廢屋", desc: "進入廢屋尋找工具。", icon: "fa-home", type: "check", checkType: "insight", chance: 70, success: { item: 'key', msg: "在佛壇抽屜發現舊倉庫鑰匙。" }, fail: { hp: -5, san: -5, msg: "踩穿腐爛地板！腳拔不出來倍感焦慮。" }, tag: "noise" },
                    { text: "快步通過", desc: "感覺人偶在看你。不想久留。", icon: "fa-walking", effect: { courage: -2 }, msg: "快步穿過。雖感覺背後有人偶掉落聲，但沒回頭。" }
                ]},
                { text: "村中央集會所遺跡。唯此處霧薄有月光。中央有焚火痕跡，周圍圍繞著數十尊頭部被敲碎的地藏像。", type: "blood", choices: [
                    { text: "調查焚火", desc: "像是新的灰燼。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'crowbar', msg: "灰燼中發現生鏽柴刀。可防身。" }, fail: { san: -5, msg: "撥弄灰燼，露出了燒焦的人類指骨。" } },
                    { text: "雙手合十", desc: "憐憫無頭地藏，合十供養。", icon: "fa-praying-hands", effect: { san: 5 }, msg: "靜心祈禱後，風停了。" },
                    { text: "側耳傾聽", desc: "確認是否有聲音。", icon: "fa-ear-listen", effect: { insight: 15, san: -15 }, msg: "風中混雜著像是複數人類唸經的低沉聲音...非人世之聲。" }
                ]},
                { text: "進入村長大宅。大廳擺放著積灰的豪華七段女兒節人偶。但男雛女雛位置顛倒，雙眼被挖空流著血淚。", type: "dark", choices: [
                    { text: "觸摸人偶", desc: "確認質感。", icon: "fa-hand-paper", type: "check", checkType: "courage", chance: 70, success: { insight: 15, item: "mirror_shard", msg: "女雛懷中藏著手鏡。似能映照真實。" }, fail: { san: -20, msg: "人偶頭顱滾落！斷面湧出黑髮纏繞手臂！" } },
                    { text: "尋找書籍", desc: "文桌上可能有記錄。", icon: "fa-book-open", type: "check", checkType: "insight", chance: 80, success: { insight: 10, msg: "發現為了鎮壓「鳴神大人」而進行活人獻祭的記錄。" }, fail: { san: -5, msg: "書上文字像蚯蚓般蠕動無法閱讀。" } },
                    { text: "點火", desc: "用和蠟燭燒掉不潔人偶。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "人偶燃燒中，彷彿發出臨死慘叫。" }
                ]},
                { text: "宅邸後方通往「不入之森」的石板路。竹子隨風發出沙沙聲，深處完全黑暗。", type: "dark", choices: [
                    { text: "點亮燈火", desc: "消耗燈油照亮。", icon: "fa-lightbulb", req: "fuel", effect: { fuel: -3, san: 5 }, msg: "燭光照亮小徑。確保視野稍微安心。" },
                    { text: "黑暗前進", desc: "依靠直覺慎重前進。", icon: "fa-walking", type: "check", checkType: "courage", chance: 60, success: { courage: 15 }, fail: { hp: -10, san: -10, msg: "被竹根絆倒滾落斜坡。腳上有被抓住的觸感。" } },
                    { text: "投石問路", desc: "丟石頭試探。", icon: "fa-cube", effect: { insight: 5 }, msg: "石頭落地聲後，稍遲傳來「嘻嘻」微小笑聲。" }
                ]}
            ],
            B: [
                { text: "【探索：廢屋群】踏入崩塌民宅。牆上有茶色手印。裡間傳來指甲抓榻榻米的「喀哩喀哩」聲。", type: "blood", choices: [
                    { text: "確認聲音", desc: "架起柴刀窺視。", icon: "fa-search", req: "crowbar", type: "check", checkType: "courage", chance: 75, success: { item: 'journal', msg: "榻榻米下藏著祖父手記！聲音只是老鼠。" }, fail: { san: -15, msg: "角落無臉長髮女子正抓著榻榻米。緩緩回頭..." } },
                    { text: "調查壁櫥", desc: "調查沒聲音的壁櫥。", icon: "fa-box-open", type: "check", checkType: "insight", chance: 70, success: { item: 'medkit', msg: "發現保存良好的藥草包。" }, fail: { san: -10, msg: "裡面塞滿大量盯著你看的日本人偶。" } },
                    { text: "逃離屋子", desc: "本能警告危險。", icon: "fa-door-open", effect: { courage: -5 }, msg: "衝出屋子。背後傳來拉門用力關上聲。" }
                ]},
                { text: "庭院池塘積滿濁水。水面漂浮白色和服，周圍有黑魚游動。和服正緩緩靠近。", type: "blood", choices: [
                    { text: "屏息不動", desc: "消除氣息等待。", icon: "fa-stop", type: "check", checkType: "courage", chance: 60, success: { san: 5, msg: "和服漂浮一會後離開。" }, fail: { san: -15, msg: "腿軟踢到石子。水面衝出蒼白之手抓腳踝！" } },
                    { text: "丟東西", desc: "丟石頭轉移注意。", icon: "fa-share", effect: { insight: 5 }, msg: "和服游向石頭落點。趁機離開。" },
                    { text: "用柴刀攻擊", desc: "揮舞柴刀。", icon: "fa-hammer", req: "crowbar", effect: { hp: -15, courage: 20 }, msg: "劈向和服。發出悲鳴沉下，但手臂因反作用力受傷。", reckless: true }
                ]},
                { text: "土間樑上掛著由泥土、稻草及頭髮凝固成的巨大蜂巢狀物。傳來微弱嬰兒哭聲。", type: "blood", choices: [
                    { text: "確認內容", desc: "慎重窺視內部。", icon: "fa-eye", type: "check", checkType: "insight", chance: 60, success: { insight: 15, msg: "是土著信仰的依代。貴重資料。" }, fail: { san: -20, msg: "衝出腐爛小手抓你的臉！" } },
                    { text: "燒毀", desc: "用火淨化。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "燒焦臭味四溢。哭聲變成慘叫。" },
                    { text: "無視前進", desc: "當作沒看到。", icon: "fa-walking", effect: { san: -5 }, msg: "哭聲變成耳邊竊竊私語。" }
                ]}
            ],
            C: [
                { text: "【探索：山路】攀登通往神社的青苔石階。兩側是無頭地藏，雨開始下。遠處傳來無人鐘樓的鐘聲。", type: "noise", choices: [
                    { text: "趕路", desc: "快速爬完石階。", icon: "fa-running", type: "check", checkType: "courage", chance: 70, success: { courage: 5 }, fail: { hp: -10, msg: "在濕滑青苔滑倒，跌落好幾階受傷。" } },
                    { text: "尋找小路", desc: "尋找獸徑。", icon: "fa-route", type: "check", checkType: "insight", chance: 60, success: { insight: 10, item: "gun" }, fail: { hp: -15, san: -5, msg: "被荊棘包圍，感覺到視線。" } },
                    { text: "原地待命", desc: "躲在石燈籠後觀察。", icon: "fa-hide", effect: { fuel: -2, san: 5 }, msg: "鐘聲停止了。但浪費了時間與燈油。" }
                ]},
                { text: "石階途中的小祠堂。門微開飄出鐵鏽味，風吹發出摩擦聲。", type: "noise", choices: [
                    { text: "打開祠堂", desc: "確認供奉物。", icon: "fa-door-open", type: "check", checkType: "insight", chance: 70, success: { item: 'amulet', msg: "發現刺滿釘子的人偶與「淨化之鹽」。" }, fail: { san: -15, msg: "裡面放著寫有你名字的紅色牌位。" } },
                    { text: "撒鹽", desc: "淨化不潔。", icon: "fa-seedling", req: "amulet", effect: { san: 15, itemLost: "amulet" }, msg: "冒出黑煙摩擦聲停止。空氣變清淨。" },
                    { text: "雙手合十", desc: "敬鬼神而遠之。", icon: "fa-praying-hands", effect: { courage: -2 }, msg: "靜靜離開現場。" }
                ]},
                { text: "周圍樹木劇烈搖晃，整座山都在鳴動。地面出現裂痕。", type: "noise", choices: [
                    { text: "往高處跑", desc: "跑向岩場。", icon: "fa-running", type: "check", checkType: "courage", chance: 65, success: { courage: 10 }, fail: { hp: -20, msg: "被捲入土石流，全身挫傷。" } },
                    { text: "抓住樹根", desc: "緊抓樹根等待。", icon: "fa-tree", type: "check", checkType: "courage", chance: 80, success: { hp: -5, san: -5, msg: "承受住搖晃，但被樹枝擦傷。" }, fail: { hp: -25, msg: "樹根斷裂滑落斜坡。" } },
                    { text: "照鏡子", desc: "這可能不是現實。", icon: "fa-mirror", req: "mirror_shard", effect: { insight: 20, san: -10 }, msg: "鏡中映出巨大黑影正搖晃山體。理解是幻覺後搖晃停止。" }
                ]}
            ],
            D: [
                { text: "【探索：神社地下】下到地下洞窟。黑暗與腐臭。牆壁有著肉塊質感。", type: "dark", choices: [
                    { text: "增強照明", desc: "多用燈油確保視野。", icon: "fa-fire", req: "fuel", effect: { fuel: -5, san: 5 }, msg: "看清牆壁是無數舊和服與棉被堆疊而成。" },
                    { text: "摸索前進", desc: "沿牆慎重前進。", icon: "fa-walking", type: "check", checkType: "courage", chance: 50, success: { courage: 15, insight: 5 }, fail: { hp: -15, san: -15, msg: "牆壁脈動試圖吞噬你！拚命掙脫。" } },
                    { text: "用柴刀刻牆", desc: "劈開噁心牆壁。", icon: "fa-hammer", req: "crowbar", type: "check", checkType: "courage", chance: 70, success: { courage: 10, msg: "牆壁滲出黑液，道路打開。" }, fail: { san: -20, msg: "切開牆壁湧出大量頭髮纏腳。" } }
                ]},
                { text: "洞窟深處祭壇，站著高八尺的白衣無臉巨女「鳴神大人」，背對著你發出「波波波」機械聲。", type: "dark", choices: [
                    { text: "屏住氣息", desc: "躲岩石後等待。", icon: "fa-hide", type: "check", checkType: "courage", chance: 60, success: { insight: 20, msg: "巨女消失。獲得調查機會。", flag: "saw_ritual" }, fail: { san: -30, msg: "心跳聲太大。巨女頭旋轉180度看向你！" } },
                    { text: "開火繩槍", desc: "射出珍貴一發。", icon: "fa-gun", req: "gun", effect: { courage: 20, itemLost: "gun", flag: "entity_damaged" }, msg: "擊中背部！巨女慘叫霧散。結束了嗎？", reckless: true },
                    { text: "用鏡子照", desc: "映照真面目。", icon: "fa-mirror", req: "mirror_shard", effect: { san: -25, insight: 25 }, msg: "鏡中映出詛咒黑洞。精神被削弱。" }
                ]},
                { text: "祭壇旁發現倒地的祖父！意識朦朧說著「鹽...必須用鹽...」。", type: "blood", choices: [
                    { text: "照顧祖父", desc: "使用藥草。", icon: "fa-leaf", req: "medkit", type: "check", checkType: "insight", chance: 80, success: { insight: 20, msg: "祖父恢復，教導封印「神樂」步驟。", flag: "mentor_hint" }, fail: { san: -15, msg: "祖父發狂大叫「你也會被帶走的！」" } },
                    { text: "尋找鹽", desc: "尋找淨化之鹽。", icon: "fa-search", type: "check", checkType: "insight", chance: 70, success: { item: 'amulet', msg: "在祭壇角落發現淨化之鹽！" }, fail: { hp: -10, msg: "被鹽罐裡的毒蛇咬傷。" } },
                    { text: "揹起逃跑", desc: "揹祖父逃跑。", icon: "fa-running", type: "check", checkType: "courage", chance: 50, success: { courage: 10, msg: "總算逃出地下。", flag: "mentor_saved" }, fail: { hp: -20, msg: "與祖父一起跌落受傷。" } }
                ]}
            ],
            E: [
                { text: "【終局：神樂殿】暴風雨肆虐。這裡是封印「鳴神大人」的最後場所。", type: "noise", choices: [
                    { text: "奉納神樂", desc: "跳起封印神樂。", icon: "fa-fan", req: "journal", type: "check", checkType: "insight", chance: 100, success: { insight: 30, san: -10, msg: "暴風雨加劇，儀式開始。", flag: "kagura_performed" }, fail: { san: -20, msg: "..." } },
                    { text: "張掛注連繩", desc: "強化結界。", icon: "fa-rope", type: "check", checkType: "courage", chance: 80, success: { courage: 20, hp: -10, msg: "掛好注連繩，結界強化。", flag: "barrier_strengthened" }, fail: { hp: -30, msg: "被瓦片擊中。" } },
                    { text: "成為替身", desc: "自願成為依代。", icon: "fa-skull", effect: { hp: -99, san: 0 }, msg: "短刀刺喉。村子恢復平靜..." }
                ]},
                { text: "儀式途中，「鳴神大人」現出真身。黑霧中伸出無數手臂與紅眼。", type: "dark", choices: [
                    { text: "火繩槍射擊", desc: "射擊眼珠。", icon: "fa-gun", req: "gun", effect: { itemLost: "gun", courage: 20 }, msg: "子彈貫穿眼珠，怪物霧散。" },
                    { text: "潑油放火", desc: "全部燈油燒盡。", icon: "fa-fire", req: "fuel", effect: { fuel: -10, hp: -15 }, msg: "怪物燃燒翻滾。你也受傷。" },
                    { text: "繼續神樂", desc: "忍耐恐懼繼續跳。", icon: "fa-fan", type: "check", checkType: "courage", chance: 70, success: { san: -10, msg: "結界彈開手臂。儀式進入佳境。" }, fail: { hp: -40, msg: "手臂纏上身體勒緊。" } }
                ]},
                { text: "怪物的精神攻擊。用親友聲音說「...過來...混合吧...」。", type: "noise", choices: [
                    { text: "咬舌保持意識", desc: "用疼痛甩開干涉。", icon: "fa-tooth", effect: { hp: -10, san: 10, courage: 20 }, msg: "劇痛讓意識鮮明。" },
                    { text: "傾聽聲音", desc: "懷念的聲音...", icon: "fa-question", effect: { san: -30, insight: 20 }, msg: "自我開始崩壞。" },
                    { text: "用鏡子反射", desc: "反射精神攻擊。", icon: "fa-mirror", req: "mirror_shard", effect: { san: 15 }, msg: "怪物被自己詛咒反噬。" }
                ]},
                { text: "最終階段。雷電交加。完成封印，還是結束這一切。", type: "dark", choices: [
                    { text: "封印 (需：鹽+神樂)", desc: "用鹽封印鳴神。", icon: "fa-seedling", req: "amulet", effect: { final: "seal" }, msg: "高舉鹽巴大喊祝詞！" },
                    { text: "燒毀村子", desc: "用火淨化詛咒。", icon: "fa-bomb", req: "fuel", effect: { final: "boom" }, msg: "點燃燈油。一切化為灰燼。" },
                    { text: "逃離村子", desc: "放棄儀式逃跑。", icon: "fa-running", effect: { final: "escape" }, msg: "連滾帶爬逃出村子。" }
                ]}
            ]
        };

        const game = {
            turn: 1,
            maxTurns: 25,
            stats: {},
            inventory: [],
            flags: [],
            phobia: null,
            isGameOver: false,
            finalChoice: null,
            scenarioTimeline: [], 
            historyLog: [], 

            start: function() {
                this.turn = 1;
                this.stats = { hp: 100, san: 80, courage: 50, insight: 10, fuel: 25 };
                this.inventory = [];
                this.flags = [];
                this.historyLog = [];
                this.isGameOver = false;
                this.phobia = PHOBIAS[Math.floor(Math.random() * PHOBIAS.length)];
                
                const midModules = ['B', 'C', 'D'].sort(() => Math.random() - 0.5);
                this.scenarioTimeline = [...MODULES.A, ...MODULES[midModules[0]], ...MODULES[midModules[1]], ...MODULES[midModules[2]], ...MODULES.E];

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('end-screen').style.display = 'none';
                document.getElementById('log-content').innerHTML = '';
                this.updateUI();
                this.log(`入村。弱點：${this.phobia.name}`, "log-info");
                this.loadScenario();
                this.checkAtmosphere();
            },

            reset: function() {
                document.getElementById('start-screen').style.display = 'flex';
                document.getElementById('end-screen').style.display = 'none';
            },

            loadScenario: function() {
                if (this.turn > this.scenarioTimeline.length) { this.triggerEnding(); return; }
                let data = this.scenarioTimeline[this.turn - 1];
                let text = `[${this.turn}刻] ${data.text}`;
                let choices = [...data.choices];
                this.historyLog.push(`${this.turn}刻: ${data.text}`);

                if (this.turn < 24 && this.stats.san < 70 && Math.random() < 0.3) {
                    const rnd = ["聽見聲音", "腳邊有錢", "看見人影", "牆上有臉", "聽見水聲"][Math.floor(Math.random()*5)];
                    choices.splice(Math.floor(Math.random() * (choices.length + 1)), 0, {
                        text: rnd, desc: "這是現實嗎...", icon: "fa-question", isPhantom: true, chance: 80, type: 'check'
                    });
                }

                if (this.stats.san < 30) {
                    text += " <span class='text-distort' style='display:block; margin-top:5px; color:#c0392b;'>[幻聽] " + this.getMadnessText() + "</span>";
                    if (Math.random() < 0.4) choices.push({ text: "戳瞎雙眼", desc: "看不見就不怕了...", icon: "fa-eye-slash", effect: { hp: -50, san: -50 }, msg: "陷入瘋狂。", reckless: true, isMadness: true });
                }

                const storyContent = document.getElementById('story-content');
                storyContent.innerHTML = `<i class="fas ${this.getScenarioIcon(this.turn)} story-icon"></i>` + text;
                storyContent.className = 'story-text';
                void storyContent.offsetWidth; 
                storyContent.classList.add(this.stats.san < 60 ? 'hallucination' : 'fade-in');

                const choiceArea = document.getElementById('choice-area');
                choiceArea.innerHTML = '';

                choices.forEach(choice => {
                    if (choice.effect && choice.effect.final === 'seal') {
                        if (!(this.hasItem('amulet') && this.flags.includes('kagura_performed'))) choice.desc += " <span style='color:#c0392b'>(未達成)</span>";
                        else choice.desc = "<span style='color:#27ae60;'>(可封印)</span> " + choice.desc;
                    }
                    if (choice.req && !this.hasItem(choice.req)) return;
                    if (choice.req === 'fuel' && this.stats.fuel <= 0) return;

                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    if (choice.isMadness) btn.classList.add('madness-choice');
                    if (choice.isPhantom) btn.classList.add('phantom-choice');
                    
                    let iconHtml = `<i class="fas ${choice.icon || 'fa-circle'}"></i>`;
                    let chanceHtml = choice.type === 'check' ? `<span class="chance-tag">${this.calculateChance(choice)}%</span>` : '';
                    
                    btn.innerHTML = `<div class="choice-title">${iconHtml} ${choice.text} ${chanceHtml}</div><div class="choice-desc">${choice.desc || ''}</div>`;
                    btn.onclick = (e) => choice.isPhantom ? this.triggerPhantom(e.currentTarget) : this.handleInput(choice);
                    choiceArea.appendChild(btn);
                });
                document.getElementById('turn-display').innerText = this.turn;
            },

            triggerPhantom: function(btn) {
                btn.style.opacity = "0"; setTimeout(() => btn.style.display = "none", 200);
                this.log("幻覺！什麼也沒有。", "log-phantom");
                this.stats.san -= 2; this.updateUI();
            },

            calculateChance: function(choice) {
                if (choice.isPhantom) return choice.chance;
                let base = choice.chance;
                if (choice.checkType === 'insight' && this.hasItem('journal')) base += 10;
                if (choice.checkType === 'courage' && this.hasItem('crowbar')) base += 10;
                return Math.min(100, base);
            },

            handleInput: async function(choice) {
                if (this.isGameOver) return;
                if (choice.effect && choice.effect.final) this.finalChoice = choice.effect.final;
                this.historyLog.push(`選: ${choice.text}`);

                if (choice.type === 'check') {
                    const result = await this.rollDice(this.calculateChance(choice));
                    this.applyEffect(result ? choice.success : choice.fail);
                } else {
                    this.applyEffect(choice.effect || choice);
                    if (choice.effect && choice.effect.final) { setTimeout(() => this.triggerEnding(), 800); return; }
                }

                if (choice.reckless) { this.stats.san -= 30; this.log("魯莽！心魂-30", "log-negative"); }
                const currentData = this.scenarioTimeline[this.turn - 1];
                if (currentData && currentData.type === this.phobia.id && this.stats.san < 60) {
                    this.stats.san -= 10; this.log(`恐懼症發作！心魂-10`, "log-negative");
                }
                this.postTurnProcess();
            },

            applyEffect: function(effect) {
                if (!effect) return;
                if (effect.hp) this.stats.hp += effect.hp;
                if (effect.san) this.stats.san += effect.san;
                if (effect.courage) this.stats.courage += effect.courage;
                if (effect.insight) this.stats.insight += effect.insight;
                if (effect.fuel) this.stats.fuel += effect.fuel;
                if (effect.item) { this.addItem(effect.item); document.getElementById('inventory-bar').classList.add('item-get-anim'); setTimeout(()=>document.getElementById('inventory-bar').classList.remove('item-get-anim'), 1000); }
                if (effect.itemLost) this.removeItem(effect.itemLost);
                if (effect.flag) this.flags.push(effect.flag);
                if (effect.msg) this.log(effect.msg, (effect.hp < 0 || effect.san < 0) ? "log-negative" : "log-positive");
                this.updateUI();
            },

            postTurnProcess: function() {
                this.stats.hp = Math.min(100, Math.max(0, this.stats.hp));
                this.stats.san = Math.min(100, Math.max(0, this.stats.san));
                this.stats.fuel = Math.min(50, Math.max(0, this.stats.fuel));
                if (this.hasItem('lighter')) { this.stats.fuel -= 1; if (this.stats.fuel <= 0) this.log("蠟燭燃盡！", "log-negative"); }
                this.updateUI();
                this.checkAtmosphere();

                if (this.stats.hp <= 0) { this.endGame("死亡END：土塊", "fa-skull", "肉體化為村中泥土。"); return; }
                if (this.stats.san <= 0) { this.endGame("發狂END：神隱", "fa-face-dizzy", "心魂破碎，成為眷屬徘徊村中。"); return; }

                if (Math.random() < 0.20 && this.turn < 24) {
                    const evt = FORCED_EVENTS[Math.floor(Math.random() * FORCED_EVENTS.length)];
                    this.log(evt.msg, "log-event"); this.applyEffect(evt.effect);
                }
                this.turn++;
                setTimeout(() => this.loadScenario(), 500);
            },

            rollDice: function(chance) {
                return new Promise(resolve => {
                    const overlay = document.getElementById('dice-overlay');
                    const diceVisual = document.getElementById('dice-visual');
                    const diceMsg = document.getElementById('dice-msg');
                    const diceDetail = document.getElementById('dice-detail');
                    overlay.style.display = 'flex';
                    diceVisual.className = 'dice-rolling'; diceVisual.innerText = '';
                    diceMsg.innerText = "命運判定..."; diceMsg.style.color = "#d0c0a8";
                    diceDetail.innerText = `成功率: ${chance}%`;
                    setTimeout(() => {
                        const roll = Math.floor(Math.random() * 100) + 1;
                        const isSuccess = roll <= chance;
                        diceVisual.className = ''; diceVisual.innerText = roll;
                        if (isSuccess) { diceVisual.classList.add('dice-success'); diceMsg.innerText = "成功！"; diceMsg.style.color = "#27ae60"; } 
                        else { diceVisual.classList.add('dice-fail'); diceMsg.innerText = "失敗..."; diceMsg.style.color = "#c0392b"; }
                        setTimeout(() => { overlay.style.display = 'none'; diceVisual.classList.remove('dice-success', 'dice-fail'); resolve(isSuccess); }, 600);
                    }, 600);
                });
            },

            triggerEnding: function() {
                let title, desc, icon;
                const { hasAmulet, mentorSaved, ritualStarted } = { hasAmulet: this.hasItem('amulet'), mentorSaved: this.flags.includes('mentor_saved'), ritualStarted: this.flags.includes('kagura_performed') };
                
                if (this.finalChoice === 'seal') {
                    if (hasAmulet && ritualStarted) { title = "真END：鳴神封印"; desc = "封印完成。霧氣消散，你活了下來並傳承真相。"; icon = "fa-sun"; } 
                    else { title = "壞END：儀式失敗"; desc = "缺少條件封印失敗。成為鳴神大人的依代。"; icon = "fa-cloud-bolt"; }
                }
                else if (this.finalChoice === 'boom') { title = "業火END：淨化"; desc = "火焰燒盡一切。詛咒連鎖或許被斬斷了。"; icon = "fa-fire"; }
                else if (this.finalChoice === 'escape' && mentorSaved) { title = "生還END：繼承者"; desc = "與祖父九死一生逃出。繼承遺志。"; icon = "fa-user-group"; }
                else if (this.finalChoice === 'escape') { title = "通常END：唯一倖存者"; desc = "獨自逃離。眼瞼深處仍留有村中光景。"; icon = "fa-person-running"; }
                else { title = "壞END：行蹤不明"; desc = "斷了音訊。地藏又增加了一尊。"; icon = "fa-question"; }
                this.endGame(title, icon, desc);
            },

            addItem: function(itemId) { if (!this.inventory.includes(itemId)) { this.inventory.push(itemId); this.log(`入手: ${ITEMS[itemId].name}`, "log-item"); } },
            hasItem: function(id) { return this.inventory.includes(id); },
            removeItem: function(id) { this.inventory = this.inventory.filter(i => i !== id); this.log(`遺失: ${ITEMS[id].name}`, "log-negative"); },
            
            updateUI: function() {
                document.getElementById('hp-val').innerText = this.stats.hp;
                document.getElementById('san-val').innerText = this.stats.san;
                document.getElementById('courage-val').innerText = this.stats.courage;
                document.getElementById('insight-val').innerText = this.stats.insight;
                document.getElementById('fuel-val').innerText = this.stats.fuel;
                document.getElementById('phobia-display').innerText = `(${this.phobia.name})`;
                const invList = document.getElementById('inventory-list');
                invList.innerHTML = this.inventory.map(id => `<div class="inv-item"><i class="fas ${ITEMS[id].icon}"></i> ${ITEMS[id].name}</div>`).join('');
            },

            checkAtmosphere: function() {
                const vignette = document.getElementById('vignette');
                const storyContent = document.getElementById('story-content');
                vignette.className = '';
                if (this.stats.hp < 30) vignette.classList.add('pulse-fast'); else if (this.stats.hp < 60) vignette.classList.add('pulse-slow');
                if (this.stats.san < 60) storyContent.classList.add('text-distort'); else storyContent.classList.remove('text-distort');
                if (this.stats.san < 30) storyContent.classList.add('hallucination'); else storyContent.classList.remove('hallucination');
            },

            log: function(msg, cls) { 
                const win = document.getElementById('log-content'); 
                const entry = document.createElement('div');
                entry.className = `log-entry ${cls} log-new`;
                entry.innerHTML = `> ${msg}`;
                win.prepend(entry);
                if (win.children.length > 20) win.lastElementChild.remove();
            },
            getScenarioIcon: function(turn) { if(turn<=5)return"fa-torii-gate"; if(turn<=15)return"fa-house-chimney-crack"; if(turn<=20)return"fa-dungeon"; return"fa-cloud-bolt"; },
            getMadnessText: function() { const t=["在後面...","過來...","找到了...","逃不掉的...","那邊不行..."]; return t[Math.floor(Math.random()*t.length)]; },

            endGame: function(title, iconClass, desc) {
                this.isGameOver = true;
                const screen = document.getElementById('end-screen');
                document.getElementById('end-title').innerText = title;
                document.getElementById('end-desc').innerText = desc;
                document.getElementById('end-icon').innerHTML = `<i class="fas ${iconClass}"></i>`;
                document.getElementById('end-stats').innerText = `狀態: 生命${this.stats.hp} 心魂${this.stats.san}`;
                screen.style.display = 'flex';
            },

            copyHistory: function() {
                const text = this.historyLog.join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); alert("已複製記錄"); } catch (err) {}
                document.body.removeChild(textArea);
            }
        };
        window.onload = () => game.reset();
    </script>
</body>
</html>
