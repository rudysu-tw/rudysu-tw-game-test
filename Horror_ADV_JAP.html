<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鳴神村異聞：黃泉之際</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 配色調整：日式鄉野恐怖風格 - 深色、木質、血與靈火 */
        :root {
            --bg-color: #1a1510; /* 深棕黑色背景 */
            --text-color: #d0c0a8; /* 米灰色文字 */
            --accent-color: #a83232; /* 鳥居/血紅色強調 */
            --san-color: #aed6f1; /* 心魂（靈力）- 幽藍色 */
            --hp-color: #c0392b; /* 生命 - 深紅色 */
            --courage-color: #d35400; /* 膽量 - 土橘色 */
            --insight-color: #8e44ad; /* 民俗 - 深紫色 */
            --item-color: #f7dc6f; /* 物品 - 金黃色 */
            --ui-bg: #241c14; /* UI背景 - 深木色 */
            --border-color: #544a3d; /* 邊框 - 舊木色 */
            --success-color: #27ae60; /* 成功 - 深綠色 */
            --fail-color: #c0392b; /* 失敗 - 深紅色 */
            --fuel-color: #e67e22; /* 燈油 - 火橙色 */
            --event-color: #e74c3c; /* 突發事件 - 紅色 */
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-family: "Yu Mincho", "Hiragino Mincho ProN", "serif"; /* 改為襯線體增加日式感 */ height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        #app-container { width: 100%; max-width: 900px; height: 100%; display: flex; flex-direction: column; background: var(--ui-bg); border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); position: relative; z-index: 5; box-shadow: 0 0 40px rgba(0,0,0,0.95); }
        
        #vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; box-shadow: inset 0 0 100px rgba(0,0,0,0.9); z-index: 10; transition: box-shadow 0.5s ease; }
        .pulse-fast { animation: heartbeat 0.8s infinite; }
        .pulse-slow { animation: heartbeat 2s infinite; }
        @keyframes heartbeat { 0% { box-shadow: inset 0 0 50px rgba(168, 50, 50, 0.3); } 50% { box-shadow: inset 0 0 150px rgba(168, 50, 50, 0.7); } 100% { box-shadow: inset 0 0 50px rgba(168, 50, 50, 0.3); } }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .text-distort { text-shadow: 2px 0 var(--hp-color), -2px 0 var(--san-color); animation: glitch-text 0.2s infinite; }
        @keyframes glitch-text { 0% { transform: translate(0); opacity: 1; } 20% { transform: translate(-1px, 1px); opacity: 0.8; } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, -1px); opacity: 0.9; } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0); opacity: 1; } }
        .hallucination { filter: blur(1px) sepia(0.4) hue-rotate(-10deg) contrast(1.1); transition: filter 1s; } /* 調整為泛黃舊照片感 */

        @keyframes item-glow { 0% { box-shadow: 0 0 5px var(--item-color); background: #332; } 50% { box-shadow: 0 0 30px var(--item-color), inset 0 0 20px var(--item-color); background: #553; } 100% { box-shadow: 0 0 5px var(--item-color); background: #221; } }
        .item-get-anim { animation: item-glow 0.8s ease-out; }

        #start-screen, #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 15, 10, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 30; text-align: center; padding: 30px; }
        h1 { color: var(--accent-color); font-size: 2.5rem; text-shadow: 0 0 15px rgba(168, 50, 50, 0.8); margin-bottom: 10px; letter-spacing: 5px; font-weight: bold; font-family: "Yu Mincho", serif; }
        .start-btn { background: rgba(40, 30, 20, 0.9); color: #d0c0a8; border: 1px solid var(--accent-color); padding: 12px 40px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; transition: all 0.3s; font-family: inherit; letter-spacing: 3px; box-shadow: 0 0 15px rgba(168, 50, 50, 0.3); border-radius: 2px; }
        .start-btn:hover { background: var(--accent-color); color: #fff; box-shadow: 0 0 30px var(--accent-color); transform: scale(1.05); }

        header { padding: 8px 15px; border-bottom: 1px solid var(--border-color); background: #1e1610; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; letter-spacing: 1px; flex-shrink: 0; }
        
        #status-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border-color); padding-bottom: 1px; flex-shrink: 0; }
        .stat-box { display: flex; flex-direction: column; align-items: center; padding: 6px 2px; background: #2a2218; transition: background 0.3s; }
        .stat-label { font-size: 0.7rem; color: #887; margin-bottom: 2px; letter-spacing: 1px; font-family: "Yu Mincho", serif; }
        .stat-value { font-weight: bold; font-size: 1rem; font-family: monospace; }
        .hp-val { color: var(--hp-color); }
        .san-val { color: var(--san-color); }
        .courage-val { color: var(--courage-color); }
        .ins-val { color: var(--insight-color); }
        .fuel-val { color: var(--fuel-color); }

        #inventory-bar { padding: 5px 15px; background: #1a120a; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; min-height: 35px; align-items: center; overflow-x: auto; flex-shrink: 0; }
        .inv-item { background: #33281d; border: 1px solid #544a3d; padding: 2px 8px; font-size: 0.75rem; border-radius: 2px; color: var(--item-color); display: flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        #story-area { flex: 2 1 auto; padding: 25px 30px; overflow-y: auto; line-height: 2; font-size: 1.15rem; color: #d0c0a8; border-bottom: 1px solid var(--border-color); background-image: radial-gradient(circle at center, #2e241a 0%, #241c14 100%); position: relative; min-height: 280px; }
        .story-text { margin-bottom: 15px; opacity: 0; animation: fadeIn 1s forwards; text-align: justify; word-wrap: break-word; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
        .story-icon { color: var(--accent-color); margin-right: 10px; font-size: 1.3rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        #choice-area { padding: 10px 15px; display: grid; grid-template-columns: 1fr; gap: 8px; background: #2a2218; flex-shrink: 0; }
        @media (min-width: 700px) { #choice-area { grid-template-columns: 1fr 1fr; gap: 12px; } }

        .choice-btn { background: linear-gradient(145deg, #362c22, #2e241a); border: 1px solid #4a3f33; color: #c0b098; padding: 10px 12px; cursor: pointer; font-family: inherit; font-size: 0.9rem; text-align: left; transition: all 0.2s; display: flex; flex-direction: column; justify-content: center; border-radius: 2px; position: relative; min-height: 55px; }
        .choice-title { font-weight: bold; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; color: #e0d0b8; font-size: 1rem; }
        .choice-desc { font-size: 0.75rem; color: #998; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .choice-btn i { font-size: 0.9rem; color: #776; width: 18px; text-align: center; }
        .choice-btn:hover { background: #43362a; color: #fff; border-color: #776; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        .choice-btn:hover i { color: var(--item-color); }
        .choice-btn:hover .choice-desc { color: #bba; }
        .chance-tag { position: absolute; top: 6px; right: 6px; font-size: 0.65rem; background: #3a2f24; padding: 1px 4px; border-radius: 2px; color: #aaa; border: 1px solid #4a3f33; }
        
        .madness-choice { border-color: var(--accent-color) !important; color: var(--hp-color) !important; font-family: "Yu Mincho", monospace; letter-spacing: 1px; animation: shake 2s infinite; background: #2a0f0f; }
        .phantom-choice { border: 1px dashed #544a3d; opacity: 0.9; font-style: italic; }

        #log-window { height: 140px; background: #100c08; border-top: 2px solid var(--border-color); padding: 10px 12px; font-size: 0.85rem; font-family: monospace; color: #a8a090; overflow-y: scroll; display: flex; flex-direction: column; flex-shrink: 0; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #332; padding-bottom: 2px; line-height: 1.4; animation: fadeIn 0.3s; }
        .log-new { color: #d0c0a8; text-shadow: 0 0 5px #a8a090; border-left: 3px solid var(--insight-color); padding-left: 5px; }
        .log-negative { color: var(--hp-color); border-left-color: var(--hp-color); }
        .log-positive { color: var(--success-color); border-left-color: var(--success-color); }
        .log-info { color: var(--courage-color); border-left-color: var(--courage-color); }
        .log-item { color: var(--item-color); font-weight: bold; border-left-color: var(--item-color); }
        .log-event { color: var(--event-color); font-weight: bold; border-left-color: var(--event-color); }
        .log-phantom { color: #776; font-style: italic; text-decoration: line-through; }

        #dice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20,15,10,0.95); z-index: 25; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #dice-visual { width: 120px; height: 120px; border: 5px solid #d0c0a8; display: flex; justify-content: center; align-items: center; font-size: 4rem; font-weight: bold; color: #d0c0a8; background: #2a2218; box-shadow: 0 0 40px rgba(208,192,168,0.1); border-radius: 50%; margin-bottom: 20px; transition: all 0.1s; font-family: monospace; }
        .dice-rolling { animation: roll 0.05s infinite; }
        @keyframes roll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(8deg) scale(1.02); } 50% { transform: rotate(0deg) scale(1); } 75% { transform: rotate(-8deg) scale(1.02); } 100% { transform: rotate(0deg) scale(1); } }
        .dice-success { border-color: var(--success-color) !important; color: var(--success-color) !important; box-shadow: 0 0 50px var(--success-color) !important; transform: scale(1.1); }
        .dice-fail { border-color: var(--fail-color) !important; color: var(--fail-color) !important; box-shadow: 0 0 50px var(--fail-color) !important; transform: scale(0.9); }

		/* 針對小螢幕（手機）的調整 */
		@media (max-width: 768px) {
			#app {
				height: 100dvh; /* 使用 d.v.h. (Dynamic Viewport Height) 以獲得更準確的手機高度 */
				padding-bottom: 0; /* 移除可能的底部填充 */
			}
			
			/* 讓遊戲日誌或內容區塊可以滾動，確保即使被切到也能看到 */
			#history-log { /* 假設這是您的日誌區域 */
				flex-grow: 1; /* 讓日誌區塊佔滿剩餘空間 */
				overflow-y: auto; /* 允許垂直滾動 */
			}

			/* 如果底部有固定的 UI (例如按鈕/狀態列)，確保它緊貼底部 */
			#controls { /* 假設這是您的操作按鈕區域 */
				flex-shrink: 0; /* 防止按鈕區域被壓縮 */
			}
		}

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #1a1510; }
        ::-webkit-scrollbar-thumb { background: #3a2f24; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #544a3d; }
    </style>
</head>
<body>
    <div id="vignette"></div>
    <div id="dice-overlay"><div id="dice-visual">?</div><div id="dice-msg" style="font-size: 1.5rem; color: #d0c0a8; margin-bottom: 10px; font-weight: bold; letter-spacing: 3px; font-family: 'Yu Mincho', serif;">運命の判定...</div><div id="dice-detail" style="font-size: 1rem; color: #887;"></div></div>

    <div id="app-container">
        <div id="start-screen">
            <h1><i class="fas fa-torii-gate"></i> 鳴神村異聞</h1>
            <p style="color: #887; margin-bottom: 25px; font-size: 1.1rem; letter-spacing: 5px; font-family: 'Yu Mincho', serif;">黄泉の際 - 没入怪談版</p>
            <div style="max-width: 500px; line-height: 2; text-align: left; background: #241c14; padding: 25px; border: 1px solid #3a2f24; border-radius: 2px; font-size: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <p style="color: var(--item-color); font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; font-family: 'Yu Mincho', serif;"><i class="fas fa-scroll"></i> 探索の手引き</p>
                <ul style="padding-left: 20px; list-style-type: circle; color: #c0b098;">
                    <li><b>怪異譚</b>：霧に包まれた廃村「鳴神村」で起きた惨劇の真相を追う、和風ホラーテキストアドベンチャー。</li>
                    <li><b>心魂と膽量</b>：「心魂」は霊的な耐性、「膽量」は物理的な恐怖への耐性を表します。どちらが尽きても破滅が待っています。</li>
                    <li><b>灯りを絶やすな</b>：暗闇は精神を蝕みます。貴重な「灯油」を管理し、手元の明かりを維持してください。</li>
                    <li><b>民俗の知恵</b>：村に残された伝承や記録が、あなたを助けるでしょう。</li>
                </ul>
            </div>
            <button class="start-btn" onclick="game.start()"><i class="fas fa-walking"></i> 廃村へ足を踏み入れる</button>
        </div>

        <header>
            <div><i class="fas fa-user-ninja"></i> 探索者：民俗学者 <span id="phobia-display" class="phobia-tag"></span></div>
            <div class="turn-indicator"><i class="far fa-clock"></i> 刻(とき): <span id="turn-display">1</span>/18</div>
        </header>

        <section id="status-bar">
            <div class="stat-box"><i class="fas fa-heart hp-val"></i><span class="stat-label">生命</span><span class="stat-value hp-val" id="hp-val">100</span></div>
            <div class="stat-box"><i class="fas fa-ghost san-val"></i><span class="stat-label">心魂</span><span class="stat-value san-val" id="san-val">80</span></div>
            <div class="stat-box"><i class="fas fa-fist-raised courage-val"></i><span class="stat-label">膽量</span><span class="stat-value courage-val" id="courage-val">50</span></div>
            <div class="stat-box"><i class="fas fa-scroll ins-val"></i><span class="stat-label">民俗</span><span class="stat-value ins-val" id="insight-val">10</span></div>
            <div class="stat-box"><i class="fas fa-oil-can fuel-val"></i><span class="stat-label">燈油</span><span class="stat-value fuel-val" id="fuel-val">25</span></div>
        </section>

        <section id="inventory-bar">
            <span style="color:#887; font-size:0.8rem; margin-right: 10px;"><i class="fas fa-briefcase"></i> 所持品:</span>
            <div id="inventory-list" style="display:flex; gap:10px;"></div>
        </section>

        <section id="story-area">
            <div id="story-content" class="story-text"></div>
        </section>

        <section id="choice-area"></section>

        <section id="log-window">
            <div id="log-content"></div>
        </section>

        <div id="end-screen" style="display: none;">
            <h1 id="end-title" style="font-family: 'Yu Mincho', serif; letter-spacing: 5px;">結末</h1>
            <div id="end-icon" style="font-size: 5rem; margin: 30px 0; color: #554;"></div>
            <p id="end-desc" style="max-width: 600px; margin: 10px 0; line-height: 2; font-size: 1.1rem; color: #c0b098; font-family: 'Yu Mincho', serif;"></p>
            <div id="end-stats" style="color: #887; font-size: 1rem; margin-bottom: 20px; font-family: monospace;"></div>
            
            <div style="display:flex; gap:10px;">
                <button class="start-btn" style="padding:10px 20px; font-size:1rem; margin-top:0;" onclick="game.copyHistory()"><i class="fas fa-copy"></i> 記録を複写</button>
                <button class="start-btn reset-btn" style="padding:10px 20px; font-size:1rem; margin-top:0;" onclick="game.reset()"><i class="fas fa-redo"></i> 再挑戦</button>
            </div>
        </div>
    </div>

    <script>
        /* --- 日式恐怖設定改寫 --- */
        // 重新定義恐懼症 (Phobias)
        const PHOBIAS = [
            { id: 'dark', name: '闇への恐怖', desc: '暗闇での心魂減少が倍増', icon: 'fa-moon' },
            { id: 'blood', name: '穢れへの恐怖', desc: '不浄な場での心魂減少が倍増', icon: 'fa-biohazard' },
            { id: 'noise', name: '物音への恐怖', desc: '突然の音で心魂減少が倍増', icon: 'fa-bell-slash' }
        ];

        // 重新定義物品 (Items) - 保持原有ID但改變名稱與描述
        const ITEMS = {
            key: { name: "古びた蔵の鍵", icon: "fa-key", desc: "村外れの蔵を開けるための錆びた鍵。" },
            crowbar: { name: "鉈 (ナタ)", icon: "fa-hammer", desc: "錆びているが鋭い。物理的な障害を破壊できる。膽量判定+10%。" }, // 使用 hammer 圖示代替
            amulet: { name: "清めの塩", icon: "fa-seedling", desc: "不浄を払う強力なアイテム。最後の儀式に必要。" }, // 使用 seedling 代替米/鹽
            lighter: { name: "和ろうそく", icon: "fa-fire", desc: "手持ちの光源。暗闇の恐怖を和らげる。" },
            journal: { name: "祖父の手帳", icon: "fa-book", desc: "民俗学者だった祖父の調査記録。民俗判定+10%。" },
            gun: { name: "古びた種子島", icon: "fa-gun", desc: "火縄銃。弾は一発のみ。強力な霊障を物理的に退ける。" },
            medkit: { name: "薬草包み", icon: "fa-leaf", desc: "傷を癒やす伝統的な薬草。" }, // 使用 leaf 代替急救包
            mirror_shard: { name: "手鏡", icon: "fa-mirror", desc: "真実の姿を映し出すと言われる古い鏡。" }
        };

        // 重新定義突發事件 (Forced Events) - 日式風味
        const FORCED_EVENTS = [
            { msg: "【怪異】背後で「カラコロ」と下駄の音がした気がした...", effect: { san: -5 } },
            { msg: "【怪異】突然、生温かい風と共に線香の匂いが鼻をついた。", effect: { courage: -5 } },
            { msg: "【発見】崩れた石垣の隙間に、古い寛永通宝を見つけた。", effect: { insight: 5 } },
            { msg: "【怪異】天井から黒い髪の毛の束が垂れ下がってきた。", effect: { san: -3, hp: -2 } },
            { msg: "【想起】祖父が語っていた村の奇妙な風習を思い出した。", effect: { insight: 10, san: 2 } },
            { msg: "【発見】倒れた灯籠のそばに、まだ使える灯油缶が落ちていた。", effect: { fuel: 5 } },
            { msg: "【怪異】視界の隅を、白い着物を着た何かが横切った。", effect: { san: -8 } },
            { msg: "【食事】保存食の干し飯をかじった。味がしない。", effect: { hp: 5, san: -2 } }
        ];

        /* --- 模組化場景資料庫 (Japanese Horror Text) --- */
        // A: 導入 - 村の入り口
        // B: 探索 - 廃屋群 (穢れ theme)
        // C: 探索 - 神社への道 (物音 theme)
        // D: 探索 - 地下祭壇 (闇 theme)
        // E: 終局 - 本殿
        const MODULES = {
            A: [
                { text: "霧が立ち込める山道を抜け、あなたは「鳴神村」の入り口に辿り着いた。目の前には朽ち果てた巨大な鳥居がそびえ立ち、その先は濃い霧で視界が遮られている。湿った空気にはカビと、微かに血の混じった土の匂いが漂う。ここが、あなたの祖父が最後に目撃された場所だ。完全な静寂が、耳を圧迫する。", type: "dark", choices: [
                    { text: "鳥居を調べる", desc: "注連縄（しめなわ）が切れかかっている。柱の根元に何か挟まっているかもしれない。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'lighter', msg: "鳥居の陰に、誰かが隠したような桐箱を見つけた。中には未使用の和ろうそくが入っていた。" }, fail: { hp: -5, msg: "柱の裏に手を回した瞬間、大量のムカデが這い出してきた！思わず手を引っ込め、転倒して擦りむいた。" } },
                    { text: "足跡を探す", desc: "最近誰かが村に入った形跡はないか、湿った地面を観察する。", icon: "fa-eye", effect: { insight: 5 }, msg: "ぬかるんだ地面に、裸足の小さな足跡が無数についているのを見つけた...村の中へと続いている。" },
                    { text: "強行突破", desc: "不気味な雰囲気に耐えられない。一刻も早く祖父の手がかりを見つけるため、霧の中へ走り出す。", icon: "fa-running", effect: { hp: -10, san: -10 }, msg: "視界が効かず、隠れていた石碑に激突した。肩を強く打ち、言い知れぬ不安が心を蝕む。", reckless: true }
                ]},
                { text: "村の大通りに出た。両脇にはかつて人が住んでいた木造の家屋が並んでいるが、どれも障子は破れ、壁は崩れかけている。異様なのは、どの家の軒先にも、顔の部分が黒く塗りつぶされた藁人形が吊るされていることだ。風が吹くと、人形たちが一斉に揺れ、乾いた音を立てる。", type: "noise", choices: [
                    { text: "人形を観察", desc: "気味は悪いが、この奇妙な風習に何か意味があるはずだ。近づいて観察する。", icon: "fa-image", effect: { insight: 10, san: -5 }, msg: "人形の背中に、墨で「身代わり」と書かれているのを見つけた。これは呪いではなく、何かから逃れるための魔除けだったのか？" },
                    { text: "廃屋を捜索", desc: "手近な廃屋に入り、使えそうな道具がないか探す。", icon: "fa-home", type: "check", checkType: "insight", chance: 70, success: { item: 'key', msg: "崩れた仏壇の引き出しから、古びた蔵の鍵を見つけた。どこかの鍵だろう。" }, fail: { hp: -5, san: -5, msg: "腐った床板を踏み抜いた！足が抜けなくなり、焦りで心臓が早鐘を打つ。" }, tag: "noise" },
                    { text: "早足で通り過ぎる", desc: "人形たちの視線を感じる（顔はないのに）。ここには長居したくない。", icon: "fa-walking", effect: { courage: -2 }, msg: "あなたは視線を逸らし、足早に通りを抜けた。背後で人形が落ちる音がした気がしたが、振り返らなかった。" }
                ]},
                { text: "村の中央にある集会所の跡地に来た。ここだけ霧が薄く、月明かりが差し込んでいる。中央には焚き火の跡があり、その周囲を囲むように、数十体の地蔵菩薩像が並んでいる。だが、すべての地蔵の首が、物理的に叩き割られて無い。", type: "blood", choices: [
                    { text: "焚き火跡を調べる", desc: "まだ新しい灰のように見える。誰かが最近ここにいたのだろうか。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'crowbar', msg: "灰の中から、錆びついた鉈（ナタ）を見つけた。護身用になりそうだ。" }, fail: { san: -5, msg: "灰をかき混ぜると、中から焼け焦げた動物の骨...いや、人の指の骨のようなものが出てきた。" } },
                    { text: "地蔵に手を合わせる", desc: "首のない地蔵たちに哀れみを感じ、供養のために手を合わせる。", icon: "fa-praying-hands", effect: { san: 5 }, msg: "静かに祈りを捧げると、心が少し落ち着いた気がした。風が止んだ。" },
                    { text: "耳を澄ます", desc: "静寂の中に、何か不自然な音が混じっていないか確認する。", icon: "fa-ear-listen", effect: { insight: 15, san: -15 }, msg: "風の音に混じって、複数の人間が念仏を唱えるような低い声が聞こえた...この世のものではない。" }
                ]},
                { text: "村長の家と思われる大きな屋敷に入った。カビ臭い玄関の先、広間には埃を被った豪華な雛人形が七段飾りで置かれている。だが、最上段の男雛と女雛の位置が逆で、しかも両方とも目がくり抜かれ、赤い涙のようなものが頬を伝っている。", type: "dark", choices: [
                    { text: "人形に触れる", desc: "ただの古い人形だと言い聞かせ、その質感を確認しようと手を伸ばす。", icon: "fa-hand-paper", type: "check", checkType: "courage", chance: 70, success: { insight: 15, item: "mirror_shard", msg: "女雛の懐に隠されていた手鏡を見つけた。鏡面は曇っているが、何かを映し出しそうだ。" }, fail: { san: -20, msg: "触れた瞬間、人形の首がゴロリと落ちた！断面から大量の黒い髪の毛が溢れ出し、あなたの腕にまとわりつく！" } },
                    { text: "書物を探す", desc: "部屋の隅に文机がある。村の記録が残っているかもしれない。", icon: "fa-book-open", type: "check", checkType: "insight", chance: 80, success: { insight: 10, msg: "「鳴神様」という存在を鎮めるための、人身御供の記録を見つけてしまった。" }, fail: { san: -5, msg: "書物の文字が、まるで生きているミミズのようにのたうち回り、読むことができない。" } },
                    { text: "火をつける", desc: "この不浄な空間を浄化すべきだ。和ろうそくの火で雛飾りを燃やす。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "乾燥した人形は瞬く間に燃え上がった。炎が踊る中、人形の断末魔のような音が聞こえた気がした。" }
                ]},
                { text: "屋敷の裏手、竹林へと続く小道に出た。ここから先は「入ラズの森」と呼ばれ、村人さえも恐れていた場所だ。竹が風に揺れて「ザワザワ」と音を立て、その奥は完全な闇に包まれている。", type: "dark", choices: [
                    { text: "明かりを灯す", desc: "この闇の中を進むには明かりが必要だ。灯油を消費して周囲を照らす。", icon: "fa-lightbulb", req: "fuel", effect: { fuel: -3, san: 5 }, msg: "和ろうそくの揺らめく光が、竹林の狭い道を照らし出した。視界が確保でき、少し安心する。" },
                    { text: "闇の中を進む", desc: "灯油は貴重だ。月明かりと勘を頼りに、慎重に進むことにする。", icon: "fa-walking", type: "check", checkType: "courage", chance: 60, success: { courage: 15 }, fail: { hp: -10, san: -10, msg: "暗闇で竹の根に足を取られ、斜面を転がり落ちた。泥だらけになり、何かが足を掴んだような感触が残る。" } },
                    { text: "石を投げる", desc: "森の奥に何かが潜んでいないか、石を投げて反応を伺う。", icon: "fa-cube", effect: { insight: 5 }, msg: "石は竹に当たってカコンと乾いた音を立てた。その後、少し遅れて「ヒヒッ」という小さな笑い声が聞こえた。" }
                ]}
            ],
            B: [ // 穢れ Theme: 廃屋、生活の痕跡
                { text: "【探索：廃屋群】あなたは崩れかけた民家の一軒に足を踏み入れた。床には破れた布団が散乱し、壁には茶色く変色した手形が無数に付着している。奥の部屋から、誰かが畳を爪で引っ掻くような「カリカリ」という音が聞こえる。", type: "blood", choices: [
                    { text: "音の源を確かめる", desc: "恐怖を押し殺し、鉈を構えて奥の部屋を覗き込む。", icon: "fa-search", req: "crowbar", type: "check", checkType: "courage", chance: 75, success: { item: 'journal', msg: "畳の下に隠されていた祖父の手帳を発見した！音の正体はネズミだったようだ...。" }, fail: { san: -15, msg: "部屋の隅で、髪の長い女が四つん這いで畳を引っ掻いていた。彼女がゆっくりと振り向く...顔がない！" } },
                    { text: "押し入れを調べる", desc: "音のしない押し入れの方を調べる。何か隠されているかもしれない。", icon: "fa-box-open", type: "check", checkType: "insight", chance: 70, success: { item: 'medkit', msg: "埃まみれの柳行李の中から、保存状態の良い薬草包みを見つけた。" }, fail: { san: -10, msg: "襖を開けると、中には大量の日本人形がぎっしりと詰め込まれており、全ての目があなたを見つめていた。" } },
                    { text: "家から逃げ出す", desc: "ここは危険だ。本能がそう告げている。", icon: "fa-door-open", effect: { courage: -5 }, msg: "あなたは慌てて家を飛び出した。背後で、襖が激しく閉まる音がした。" }
                ]},
                { text: "縁側に出ると、庭の池が濁った水で満たされている。水面には白い着物が浮かんでおり、その周囲を黒い魚のようなものが泳ぎ回っている。着物がゆっくりとこちらに近づいてくる。", type: "blood", choices: [
                    { text: "じっと動かない", desc: "気配を消してやり過ごす。動けば気づかれる。", icon: "fa-stop", type: "check", checkType: "courage", chance: 60, success: { san: 5, msg: "着物はあなたの目の前で止まり、しばらく漂った後、再び池の中央へと戻っていった。息を吐く。" }, fail: { san: -15, msg: "恐怖で足が震え、小石を蹴ってしまった。水面から真っ白な手が飛び出し、あなたの足首を掴もうとした！" } },
                    { text: "物を投げ込む", desc: "手近な石を池の遠くに投げ込み、注意をそちらに向ける。", icon: "fa-share", effect: { insight: 5 }, msg: "石が水音を立てると、着物と黒い魚たちは一斉にそちらへ向かっていった。今のうちに離れる。" },
                    { text: "鉈で攻撃する", desc: "近づいてくるなら、やるしかない。鉈を振りかざす。", icon: "fa-hammer", req: "crowbar", effect: { hp: -15, courage: 20 }, msg: "あなたは水面の着物に鉈を叩きつけた。水しぶきと共に悲鳴のような音が上がり、着物は沈んでいったが、反動で腕を負傷した。", reckless: true }
                ]},
                { text: "土間を通過中、梁から吊るされた巨大な蜂の巣のような物体を見つけた。よく見ると、それは泥と藁、そして人間の髪の毛で固められた何かだ。中から微かに赤子の泣き声のようなものが聞こえる。", type: "blood", choices: [
                    { text: "中を確かめる", desc: "民俗学的な好奇心が恐怖を上回る。慎重に中を覗き込む。", icon: "fa-eye", type: "check", checkType: "insight", chance: 60, success: { insight: 15, msg: "中には、村の土着信仰に使われたと思われる奇妙な形の依代（よりしろ）が入っていた。貴重な資料だ。" }, fail: { san: -20, msg: "中から腐敗した小さな手が飛び出し、あなたの顔を掴もうとした！" } },
                    { text: "焼き払う", desc: "これは穢れている。和ろうそくの火で浄化する。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "髪の毛が焦げる嫌な臭いと共に、それは燃え上がった。泣き声は断末魔の叫びに変わった。" },
                    { text: "無視して進む", desc: "関わってはいけない。見なかったことにして先を急ぐ。", icon: "fa-walking", effect: { san: -5 }, msg: "背後から泣き声が大きくなり、耳元で囁くような声に変わったが、あなたは足を止めなかった。" }
                ]}
            ],
            C: [ // 物音 Theme: 神社への道、自然の脅威
                { text: "【探索：山道】神社へと続く苔むした石段を登っている。両脇には首のない地蔵が延々と並び、雨がシトシトと降り始めた。遠くで「ゴーン...」と、誰もいないはずの鐘楼から鐘の音が響く。", type: "noise", choices: [
                    { text: "先を急ぐ", desc: "鐘の音が近づいてくる前に、この不気味な石段を登り切る。", icon: "fa-running", type: "check", checkType: "courage", chance: 70, success: { courage: 5 }, fail: { hp: -10, msg: "濡れた苔に足を滑らせ、数段落ちてしまった。膝を強く打ち、痛みが走る。" } },
                    { text: "脇道を探す", desc: "石段は危険だ。獣道のような脇道がないか探す。", icon: "fa-route", type: "check", checkType: "insight", chance: 60, success: { insight: 10, item: "gun" }, fail: { hp: -15, san: -5, msg: "藪の中に入り込んだが、鋭い茨に囲まれ、脱出するのに体力を消耗した。何かの視線を感じた。" } },
                    { text: "その場で待機", desc: "音の正体がわかるまで、石灯籠の陰に隠れて様子を伺う。", icon: "fa-hide", effect: { fuel: -2, san: 5 }, msg: "しばらく息を潜めていると、鐘の音は止んだ。だが、貴重な時間と灯油を浪費してしまった。" }
                ]},
                { text: "石段の途中、小さな祠（ほこら）の前を通りかかった。扉は少し開いており、中から錆びた鉄の臭いが漂ってくる。風が吹くたびに、扉が「ギィ...ギィ...」と軋む音を立てる。", type: "noise", choices: [
                    { text: "祠を開ける", desc: "中に何が祀られているのか確かめる。重要な手がかりかもしれない。", icon: "fa-door-open", type: "check", checkType: "insight", chance: 70, success: { item: 'amulet', msg: "祠の中には、大量の錆びた釘が突き刺さった人形と、その下に隠された「清めの塩」があった。" }, fail: { san: -15, msg: "扉を開けると、中には自分の名前が朱色で書かれた位牌（いはい）が置かれていた。心臓が凍りつく。" } },
                    { text: "塩を撒く", desc: "不浄な気配を感じる。手持ちの清めの塩を撒いて清める。", icon: "fa-seedling", req: "amulet", effect: { san: 15, itemLost: "amulet" }, msg: "塩を撒くと、祠の中から黒い煙が上がり、軋む音が止んだ。空気が清浄になった気がする。" },
                    { text: "手を合わせて去る", desc: "触らぬ神に祟りなし。軽く拝んで、そのまま通り過ぎる。", icon: "fa-praying-hands", effect: { courage: -2 }, msg: "あなたは祠を刺激しないよう、静かにその場を離れた。" }
                ]},
                { text: "突然、周囲の木々が激しく揺れ始め、山全体が鳴動した。土砂崩れの前兆か、それとも山の神の怒りか。足元の地面に亀裂が走り始めた。", type: "noise", choices: [
                    { text: "高台へ走る", desc: "崩れる地面を避け、近くの岩場へ全力で走る。", icon: "fa-running", type: "check", checkType: "courage", chance: 65, success: { courage: 10 }, fail: { hp: -20, msg: "間に合わなかった！崩れた土砂に巻き込まれ、身体中を打撲した。" } },
                    { text: "木の根に掴まる", desc: "近くの太い木の根にしがみつき、揺れが収まるのを待つ。", icon: "fa-tree", type: "check", checkType: "courage", chance: 80, success: { hp: -5, san: -5, msg: "激しい揺れに耐えたが、落ちてきた枝で擦り傷を負った。揺れが収まると、周囲の景色が変わっていた。" }, fail: { hp: -25, msg: "掴んでいた根が千切れ、あなたは斜面を滑落した。" } },
                    { text: "鏡を見る", desc: "これは現実ではないかもしれない。手鏡で真実を映そうと試みる。", icon: "fa-mirror", req: "mirror_shard", effect: { insight: 20, san: -10 }, msg: "鏡に映ったのは、揺れる山ではなく、巨大な黒い影が山を揺さぶっている姿だった。幻覚だと理解した瞬間、揺れは収まった。" }
                ]}
            ],
            D: [ // 闇 Theme: 地下、儀式の場
                { text: "【探索：神社の地下】本殿の床下に隠された階段を見つけ、地下へと降りた。そこは完全な闇と、鼻を突く腐臭が支配する洞窟だった。壁は湿った土ではなく、何か柔らかい肉のような質感がある。", type: "dark", choices: [
                    { text: "明かりを強める", desc: "この闇は危険だ。灯油を多めに使い、視界を確保する。", icon: "fa-fire", req: "fuel", effect: { fuel: -5, san: 5 }, msg: "炎が強まると、壁だと思っていたものが、無数の古い着物や布団が幾重にも押し固められたものだと分かった。" },
                    { text: "手探りで進む", desc: "灯油を節約するため、壁伝いに慎重に進む。", icon: "fa-walking", type: "check", checkType: "courage", chance: 50, success: { courage: 15, insight: 5 }, fail: { hp: -15, san: -15, msg: "壁に手を触れた瞬間、その「肉」が脈打ち、あなたを飲み込もうとした！必死で振りほどいた。" } },
                    { text: "鉈で壁を刻む", desc: "この気味の悪い壁を鉈で切り裂きながら進む。", icon: "fa-hammer", req: "crowbar", type: "check", checkType: "courage", chance: 70, success: { courage: 10, msg: "鉈を振るうたびに、壁から黒い液体が染み出したが、道は開けた。" }, fail: { san: -20, msg: "壁を切り裂くと、中から大量の人間の髪の毛が溢れ出し、足元に絡みついた。" } }
                ]},
                { text: "洞窟の奥で、巨大な祭壇を見つけた。そこには、村人たちが「鳴神様」と呼んでいた存在——身長八尺（約2.4m）はある、白い着物を着たのっぺらぼうの巨女が、あなたに背を向けて立っていた。「...ぽぽ、ぽぽぽ...」と、機械的な奇妙な音を発している。", type: "dark", choices: [
                    { text: "息を殺す", desc: "気づかれないように、岩陰に隠れて息を潜める。", icon: "fa-hide", type: "check", checkType: "courage", chance: 60, success: { insight: 20, msg: "巨女はしばらく奇妙な音を発していたが、やがて闇の中へと消えていった。祭壇を調べるチャンスだ。", flag: "saw_ritual" }, fail: { san: -30, msg: "心臓の音が大きすぎた。「ぽぽぽ...」という音が止まり、巨女の首が真後ろに180度回転してあなたを見た！" } },
                    { text: "火縄銃を撃つ", desc: "最大の脅威だ。ここで仕留めるしかない。貴重な一発を撃ち込む。", icon: "fa-gun", req: "gun", effect: { courage: 20, itemLost: "gun", flag: "entity_damaged" }, msg: "轟音と共に弾丸が巨女の背中に命中した！巨女は凄まじい悲鳴を上げ、黒い霧となって四散した。だが、これで終わりだろうか？", reckless: true },
                    { text: "鏡で照らす", desc: "手鏡を使い、巨女の真の姿を映し出す。", icon: "fa-mirror", req: "mirror_shard", effect: { san: -25, insight: 25 }, msg: "鏡に映ったのは、女の姿ではなく、無数の呪詛が渦巻く黒い穴そのものだった。その深淵を覗き見てしまい、精神が削られる。" }
                ]},
                { text: "祭壇の横に、祖父が倒れているのを見つけた！まだ息はあるようだが、意識は朦朧としており、うわ言のように「塩を...塩で清めねば...」と繰り返している。", type: "blood", choices: [
                    { text: "祖父を介抱する", desc: "薬草を使い、祖父の意識を回復させる。", icon: "fa-leaf", req: "medkit", type: "check", checkType: "insight", chance: 80, success: { insight: 20, msg: "祖父の意識が戻った！彼は震える手で、鳴神様を封じるための「神楽」の手順を教えてくれた。", flag: "mentor_hint" }, fail: { san: -15, msg: "祖父は突然目を見開き、「お前も連れていかれる！」と叫んで暴れ出した。" } },
                    { text: "塩を探す", desc: "祖父の言葉を信じ、周囲で清めの塩を探す。", icon: "fa-search", type: "check", checkType: "insight", chance: 70, success: { item: 'amulet', msg: "祭壇の隅に、まだ封が開けられていない清めの塩の袋を見つけた！" }, fail: { hp: -10, msg: "塩の壺に手を伸ばしたが、中に潜んでいた毒蛇に噛まれた。" } },
                    { text: "担いで逃げる", desc: "ここにいては危険だ。祖父を担いで地上へ脱出を試みる。", icon: "fa-running", type: "check", checkType: "courage", chance: 50, success: { courage: 10, msg: "重い祖父を担ぎ、必死で来た道を戻る。なんとか地下から脱出できた。", flag: "mentor_saved" }, fail: { hp: -20, msg: "足元が崩れ、祖父と共に転落した。全身を強打し、祖父の意識は再び遠のいた。" } }
                ]}
            ],
            // 終局 (21-25) - 本殿での決戦
            E: [
                { text: "【終局：神楽殿】あなたは祖父（またはその遺志）と共に、神社の神楽殿に辿り着いた。暴風雨が吹き荒れ、稲妻が空を裂く。ここが「鳴神様」を封じる最後の場所だ。儀式を始めなければならない。", type: "noise", choices: [
                    // 修復：100% 成功率
                    { text: "奉納神楽を舞う", desc: "祖父の手帳（または教え）に従い、封印のための神楽を舞う。", icon: "fa-fan", req: "journal", type: "check", checkType: "insight", chance: 100, success: { insight: 30, san: -10, msg: "あなたが舞い始めると、暴風雨がさらに激しさを増し、雷鳴が轟いた。儀式が始まった合図だ。", flag: "kagura_performed" }, fail: { san: -20, msg: "（此選項不應失敗）" } },
                    { text: "注連縄を張る", desc: "結界を強化するため、神楽殿の周囲に新しい注連縄を張り巡らせる。", icon: "fa-rope", type: "check", checkType: "courage", chance: 80, success: { courage: 20, hp: -10, msg: "強風に煽られながらも、なんとか注連縄を張り終えた。結界が一時的に強化された。", flag: "barrier_strengthened" }, fail: { hp: -30, msg: "突風で飛ばされた屋根瓦が直撃し、あなたは地面に叩きつけられた。" } },
                    { text: "身代わりとなる", desc: "儀式を完成させるため、自らを最後の「依代」として差し出す。", icon: "fa-skull", effect: { hp: -99, san: 0 }, msg: "あなたは祭壇の中央に座り、短刀を喉元に突き立てた。意識が遠のく中、村が静けさを取り戻していくのを感じた..." }
                ]},
                { text: "儀式の最中、ついに「鳴神様」がその真の姿を現した。それは黒い霧の塊であり、その中から無数の白い腕が伸び、赤い目玉がギョロギョロとあなたを見つめている。", type: "dark", choices: [
                    { text: "火縄銃で撃つ", desc: "残された最後の一発を、その中心にある目玉に撃ち込む。", icon: "fa-gun", req: "gun", effect: { itemLost: "gun", courage: 20 }, msg: "轟音一閃！弾丸は目玉を貫き、怪物は苦悶の声を上げて霧散した。だが、完全に消滅したわけではないようだ。" },
                    { text: "灯油を浴びせ火を放つ", desc: "残りの灯油を全て投げつけ、和ろうそくで点火する。", icon: "fa-fire", req: "fuel", effect: { fuel: -10, hp: -15 }, msg: "怪物は火だるまとなり、絶叫を上げながらのたうち回る。あなたも火の粉を浴びて火傷を負った。" },
                    { text: "神楽を続ける", desc: "何が起きても、舞を止めてはならない。恐怖に耐え、舞い続ける。", icon: "fa-fan", type: "check", checkType: "courage", chance: 70, success: { san: -10, msg: "無数の腕があなたを掴もうとするが、神楽の結界がそれを弾く。儀式は佳境に入った。" }, fail: { hp: -40, msg: "恐怖で足が止まってしまった瞬間、白い腕があなたの体にまとわりつき、締め上げた。骨が砕ける音がする。" } }
                ]},
                { text: "怪物の精神攻撃が始まった。あなたの脳内に、直接語りかけてくる。「...オイデ...コッチヘオイデ...マゼテアゲル...」それは、失った家族や友人の声色を使っていた。", type: "noise", choices: [
                    { text: "舌を噛み意識を保つ", desc: "肉体の痛みで精神への干渉を振り払う。", icon: "fa-tooth", effect: { hp: -10, san: 10, courage: 20 }, msg: "口の中に鉄の味が広がる。痛みで意識が鮮明になり、幻聴が遠のいた。" },
                    { text: "声に耳を傾ける", desc: "懐かしい声だ...そちらに行けば、楽になれるのだろうか？", icon: "fa-question", effect: { san: -30, insight: 20 }, msg: "あなたは取り込まれることを受け入れた。境界線が曖昧になり、自我が崩壊していく。" },
                    { text: "鏡で跳ね返す", desc: "手鏡を使い、精神攻撃をそのまま怪物に反射する。", icon: "fa-mirror", req: "mirror_shard", effect: { san: 15 }, msg: "鏡を向けると、怪物は自分の呪詛を浴びて怯んだ。その隙に体勢を立て直す。" }
                ]},
                { text: "儀式は最終段階に入った。天から雷が落ち、神楽殿が炎に包まれる。封印を完成させるか、それとも全てを終わらせるか。", type: "dark", choices: [
                    { text: "封印 (要：塩と神楽)", desc: "神楽を舞い終え、最後に清めの塩で「鳴神様」を封じる。", icon: "fa-seedling", req: "amulet", effect: { final: "seal" }, msg: "あなたは塩を高く掲げ、最後の祝詞（のりと）を叫んだ！稲妻が祭壇を直撃する！" },
                    { text: "村ごと焼き払う", desc: "灯油樽を倒し、この呪われた村を炎で浄化する。", icon: "fa-bomb", req: "fuel", effect: { final: "boom" }, msg: "あなたは火のついたろうそくを灯油樽に投げ込んだ。爆炎が上がり、全てが灰になっていく。" },
                    { text: "村から逃走する", desc: "もう限界だ。儀式を放棄し、山を降りて逃げ出す。", icon: "fa-running", effect: { final: "escape" }, msg: "あなたは全てを投げ出し、嵐の中を転がるようにして村から逃げ出した。背後で絶望的な咆哮が聞こえた。" }
                ]}
            ]
        };

        /* --- ゲームロジック (Core Game Logic - Do not modify structurally) --- */
        const game = {
            turn: 1,
            maxTurns: 25,
            stats: { hp: 100, san: 80, courage: 50, insight: 10, fuel: 25 },
            inventory: [],
            flags: [],
            phobia: null,
            isGameOver: false,
            finalChoice: null,
            scenarioTimeline: [], 
            historyLog: [], 

            start: function() {
                this.turn = 1;
                // 初期ステータス
                this.stats = { hp: 100, san: 80, courage: 50, insight: 10, fuel: 25 };
                this.inventory = [];
                this.flags = [];
                this.historyLog = [];
                this.isGameOver = false;
                this.phobia = PHOBIAS[Math.floor(Math.random() * PHOBIAS.length)];
                
                const midModules = ['B', 'C', 'D'].sort(() => Math.random() - 0.5);
                this.scenarioTimeline = [
                    ...MODULES.A,
                    ...MODULES[midModules[0]],
                    ...MODULES[midModules[1]],
                    ...MODULES[midModules[2]],
                    ...MODULES.E
                ];
                console.log("Map Order:", midModules);

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('end-screen').style.display = 'none';
                document.getElementById('log-content').innerHTML = '';
                this.updateUI();
                this.log(`鳴神村へ足を踏み入れた。あなたの弱点：${this.phobia.name} (${this.phobia.desc})`, "log-info");
                this.loadScenario();
                this.checkAtmosphere();
            },

            reset: function() {
                document.getElementById('start-screen').style.display = 'flex';
                document.getElementById('end-screen').style.display = 'none';
            },

            loadScenario: function() {
                if (this.turn > this.scenarioTimeline.length) { 
                    this.triggerEnding(); 
                    return; 
                }

                let data = this.scenarioTimeline[this.turn - 1];
                // 刻表示に変更
                let text = `[${this.turn}刻] ${data.text}`;
                let choices = [...data.choices];

                this.historyLog.push(`${this.turn}刻: ${data.text}`);

                // 幻覚イベント（日本語化）
                if (this.turn < 24 && this.stats.san < 70 && Math.random() < 0.3) {
                    const phantomText = ["誰かの声がした気がする", "足元に小銭が落ちている", "物陰に人影が見える", "壁のシミが顔に見える", "水音が聞こえる"];
                    const randomText = phantomText[Math.floor(Math.random() * phantomText.length)];
                    const randomIcon = ["fa-ear-listen", "fa-coins", "fa-user-ninja", "fa-face-dizzy", "fa-water"][Math.floor(Math.random() * 5)];
                    const insertIndex = Math.floor(Math.random() * (choices.length + 1));
                    choices.splice(insertIndex, 0, {
                        text: randomText, desc: "これは現実なのだろうか...", icon: randomIcon, isPhantom: true, chance: 80, type: 'check'
                    });
                }

                // 発狂モード（日本語化）
                if (this.stats.san < 30) {
                    text += " <span class='text-distort' style='display:block; margin-top:10px; color:#c0392b;'>[幻聴] " + this.getMadnessText() + "</span>";
                    if (Math.random() < 0.4) {
                        choices.push({ 
                            text: "幻聴に従う：目を潰す", desc: "見えなければ、怖くない...", icon: "fa-eye-slash", 
                            effect: { hp: -50, san: -50 }, msg: "あなたは狂気に陥った。視界が闇に包まれる。", reckless: true, isMadness: true 
                        });
                    }
                }

                const storyContent = document.getElementById('story-content');
                // アイコンを鳥居などに変更
                storyContent.innerHTML = `<i class="fas ${this.getScenarioIcon(this.turn)} story-icon"></i>` + text;
                storyContent.className = 'story-text';
                void storyContent.offsetWidth; 
                storyContent.classList.add(this.stats.san < 60 ? 'hallucination' : 'fade-in');

                const choiceArea = document.getElementById('choice-area');
                choiceArea.innerHTML = '';

                choices.forEach(choice => {
                    // 終局条件チェック（日本語化対応）
                    if (choice.effect && choice.effect.final === 'seal') {
                        // amulet は塩、ritual_started は kagura_performed に対応
                        const canSeal = this.hasItem('amulet') && this.flags.includes('kagura_performed');
                        if (!canSeal) choice.desc += " <span style='color:#c0392b'>(条件未達成：清めの塩と神楽が必要)</span>";
                        else choice.desc = "<span style='color:#27ae60; font-weight:bold;'>(条件達成 - 封印可能)</span> " + choice.desc;
                    }

                    if (choice.req && !this.hasItem(choice.req)) return;
                    if (choice.req === 'fuel' && this.stats.fuel <= 0) return;

                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    if (choice.isMadness) btn.classList.add('madness-choice');
                    if (choice.isPhantom) btn.classList.add('phantom-choice');
                    
                    let iconHtml = `<i class="fas ${choice.icon || 'fa-circle'}"></i>`;
                    let chanceHtml = choice.type === 'check' ? `<span class="chance-tag">${this.calculateChance(choice)}%</span>` : '';
                    
                    btn.innerHTML = `<div class="choice-title">${iconHtml} ${choice.text} ${chanceHtml}</div><div class="choice-desc">${choice.desc || ''}</div>`;
                    
                    btn.onclick = (e) => {
                        if (choice.isPhantom) {
                            this.triggerPhantom(e.currentTarget);
                        } else {
                            this.handleInput(choice);
                        }
                    };
                    choiceArea.appendChild(btn);
                });
                document.getElementById('turn-display').innerText = this.turn;
            },

            triggerPhantom: function(btnElement) {
                btnElement.style.transform = "scale(0.95)";
                setTimeout(() => { btnElement.style.opacity = "0"; setTimeout(() => { btnElement.style.display = "none"; }, 200); }, 100);
                document.getElementById('app-container').classList.add('shake');
                setTimeout(() => document.getElementById('app-container').classList.remove('shake'), 200);
                this.log("手を伸ばしたが、そこには何もなかった。幻覚だ！", "log-phantom");
                this.stats.san -= 2;
                this.updateUI();
            },

            calculateChance: function(choice) {
                if (choice.isPhantom) return choice.chance;
                let base = choice.chance;
                if (choice.checkType === 'insight' && this.hasItem('journal')) base += 10;
                if (choice.checkType === 'courage' && this.hasItem('crowbar')) base += 10;
                return Math.min(100, base);
            },

            handleInput: async function(choice) {
                if (this.isGameOver) return;
                document.getElementById('app-container').classList.add('shake');
                setTimeout(() => document.getElementById('app-container').classList.remove('shake'), 500);

                this.historyLog.push(`選択: ${choice.text}`);

                if (choice.effect && choice.effect.final) this.finalChoice = choice.effect.final;

                if (choice.type === 'check') {
                    const result = await this.rollDice(this.calculateChance(choice));
                    if (result) this.applyEffect(choice.success);
                    else this.applyEffect(choice.fail);
                } else {
                    this.applyEffect(choice.effect || choice);
					
					// 如果是最終選擇，直接結束（防止進到 turn 19）
					if (choice.effect && choice.effect.final) {
						setTimeout(() => this.triggerEnding(), 800);
						return;
					};
					
                    if (choice.msg) this.log(choice.msg, "log-info");
                }

                if (choice.reckless) { this.stats.san -= 30; this.log("【無謀な行動】心魂 -30", "log-negative"); }
                
                const currentData = this.scenarioTimeline[this.turn - 1];
                if (currentData && currentData.type === this.phobia.id && this.stats.san < 60) {
                    this.stats.san -= 10;
                    this.log(`【恐怖症発作】${this.phobia.name}！ 心魂 -10`, "log-negative");
                }
                this.postTurnProcess();
            },

            applyEffect: function(effect) {
                if (!effect) return;
                if (effect.hp) this.stats.hp += effect.hp;
                if (effect.san) this.stats.san += effect.san;
                if (effect.courage) this.stats.courage += effect.courage;
                if (effect.insight) this.stats.insight += effect.insight;
                if (effect.fuel) this.stats.fuel += effect.fuel;
                if (effect.item) { this.addItem(effect.item); document.getElementById('inventory-bar').classList.add('item-get-anim'); setTimeout(()=>document.getElementById('inventory-bar').classList.remove('item-get-anim'), 1000); }
                if (effect.itemLost) this.removeItem(effect.itemLost);
                if (effect.flag) {
                    this.flags.push(effect.flag);
                    console.log("Flag added:", effect.flag);
                }
                if (effect.msg) this.log(effect.msg, (effect.hp < 0 || effect.san < 0) ? "log-negative" : "log-positive");
                this.logStatsChange(effect);
            },

            postTurnProcess: function() {
                this.stats.hp = Math.min(100, Math.max(0, this.stats.hp));
                this.stats.san = Math.min(100, Math.max(0, this.stats.san));
                this.stats.fuel = Math.min(50, Math.max(0, this.stats.fuel));
                // ライター（和ろうそく）を持っていると燃料消費
                if (this.hasItem('lighter')) { this.stats.fuel -= 1; if (this.stats.fuel <= 0) this.log("和ろうそくが燃え尽きた！", "log-negative"); }
                this.updateUI();
                this.checkAtmosphere();

                if (this.stats.hp <= 0) { this.endGame("死亡END：土塊", "fa-skull", "肉体は限界を迎えた。あなたの体は村の土となり、苔生していくだろう。"); return; }
                if (this.stats.san <= 0) { this.endGame("発狂END：神隠し", "fa-face-dizzy", "心魂は砕け散った。あなたは人であることをやめ、鳴神様の眷属として永遠に村を彷徨うことになった。"); return; }

                if (Math.random() < 0.20 && this.turn < 24) {
                    const evt = FORCED_EVENTS[Math.floor(Math.random() * FORCED_EVENTS.length)];
                    if (!evt.condition || evt.condition(this)) {
                        this.log(evt.msg, "log-event"); this.applyEffect(evt.effect);
                    }
                }
                this.turn++;
                setTimeout(() => this.loadScenario(), 500);
            },

            rollDice: function(chance) {
                return new Promise(resolve => {
                    const overlay = document.getElementById('dice-overlay');
                    const diceVisual = document.getElementById('dice-visual');
                    const diceMsg = document.getElementById('dice-msg');
                    const diceDetail = document.getElementById('dice-detail');
                    overlay.style.display = 'flex';
                    diceVisual.className = 'dice-rolling';
                    diceVisual.innerText = '';
                    diceMsg.innerText = "運命の判定...";
                    diceMsg.style.color = "#d0c0a8";
                    diceDetail.innerText = `目標成功率: ${chance}%`;
                    setTimeout(() => {
                        const roll = Math.floor(Math.random() * 100) + 1;
                        const isSuccess = roll <= chance;
                        diceVisual.className = ''; diceVisual.innerText = roll;
                        if (isSuccess) { diceVisual.classList.add('dice-success'); diceMsg.innerText = "判定成功！"; diceMsg.style.color = "#27ae60"; } 
                        else { diceVisual.classList.add('dice-fail'); diceMsg.innerText = "判定失敗..."; diceMsg.style.color = "#c0392b"; }
                        setTimeout(() => { overlay.style.display = 'none'; diceVisual.classList.remove('dice-success', 'dice-fail'); resolve(isSuccess); }, 600);
                    }, 600);
                });
            },

            triggerEnding: function() {
                let title, desc, icon;
                // フラグ名を新しいシナリオに合わせて調整
                const { hasAmulet, mentorSaved, ritualStarted } = { 
                    hasAmulet: this.hasItem('amulet'), // 塩
                    mentorSaved: this.flags.includes('mentor_saved'), // 祖父救出
                    ritualStarted: this.flags.includes('kagura_performed') // 神楽奉納
                };
                
                console.log("Ending Check:", { finalChoice: this.finalChoice, hasAmulet, ritualStarted });

                if (this.finalChoice === 'seal') {
                    if (hasAmulet && ritualStarted) {
                        title = "真END：鳴神封印"; desc = "祖父の知識と清めの塩により、奉納神楽は成った。鳴神様は再び深い眠りにつき、村を覆っていた霧が晴れていく。あなたは生き延び、この真実を後世に伝える使命を得た。"; icon = "fa-sun";
                    } else {
                        title = "バッドEND：儀式失敗"; desc = "塩か神楽が不足していたため、封印は不完全に終わった。激怒した鳴神様の依代となり、あなたの意識は永遠の闇に飲まれた。"; icon = "fa-cloud-bolt";
                    }
                }
                else if (this.finalChoice === 'boom') { title = "業火END：浄化"; desc = "あなたが放った火は、瞬く間に村全体を包み込んだ。鳴神様もろとも、全ての穢れが焼き払われた。あなたの犠牲により、呪いの連鎖は断ち切られた...かもしれない。"; icon = "fa-fire"; }
                else if (this.finalChoice === 'escape' && mentorSaved) { title = "生還END：継承者"; desc = "傷ついた祖父を連れ、命からがら村を脱出した。村の謎は残されたままだが、二人で生きて帰れたことが何よりの救いだ。祖父の研究は、あなたが引き継ぐことになるだろう。"; icon = "fa-user-group"; }
                else if (this.finalChoice === 'escape') { title = "通常END：唯一の生存者"; desc = "あなた一人が村から逃げ延びた。体は無事だが、村で見た光景が瞼の裏に焼き付いて離れない。夜になると、遠くからあの「ぽぽぽ...」という音が聞こえる気がする。"; icon = "fa-person-running"; }
                else { title = "バッドEND：行方不明"; desc = "あなたの消息は途絶えた。霧深い村のどこかで、新たな地蔵が一体増えたのかもしれない。"; icon = "fa-question"; }
                this.endGame(title, icon, desc);
            },

            addItem: function(itemId) { if (!this.inventory.includes(itemId)) { this.inventory.push(itemId); this.log(`入手: ${ITEMS[itemId].name}`, "log-item"); } },
            hasItem: function(id) { return this.inventory.includes(id); },
            removeItem: function(id) { this.inventory = this.inventory.filter(i => i !== id); this.log(`喪失: ${ITEMS[id].name}`, "log-negative"); },
            
            updateUI: function() {
                document.getElementById('hp-val').innerText = this.stats.hp;
                document.getElementById('san-val').innerText = this.stats.san;
                document.getElementById('courage-val').innerText = this.stats.courage;
                document.getElementById('insight-val').innerText = this.stats.insight;
                document.getElementById('fuel-val').innerText = this.stats.fuel;
                document.getElementById('phobia-display').innerText = `(${this.phobia.name})`;
                const invList = document.getElementById('inventory-list');
                invList.innerHTML = this.inventory.map(id => `<div class="inv-item"><i class="fas ${ITEMS[id].icon}"></i> ${ITEMS[id].name}</div>`).join('');
            },

            checkAtmosphere: function() {
                const vignette = document.getElementById('vignette');
                const storyContent = document.getElementById('story-content');
                vignette.className = '';
                if (this.stats.hp < 30) vignette.classList.add('pulse-fast'); else if (this.stats.hp < 60) vignette.classList.add('pulse-slow');
                if (this.stats.san < 60) storyContent.classList.add('text-distort'); else storyContent.classList.remove('text-distort');
                if (this.stats.san < 30) storyContent.classList.add('hallucination'); else storyContent.classList.remove('hallucination');
            },

            log: function(msg, cls) { 
                const win = document.getElementById('log-content'); 
                const entry = document.createElement('div');
                entry.className = `log-entry ${cls} log-new`;
                entry.innerHTML = `> ${msg}`;
                win.prepend(entry);
                if (win.children.length > 20) win.lastElementChild.remove();
            },
            logStatsChange: function(effect) { let parts = []; if (effect.hp) parts.push(`生命${effect.hp}`); if (effect.san) parts.push(`心魂${effect.san}`); if (effect.courage) parts.push(`膽量${effect.courage}`); if (effect.insight) parts.push(`民俗${effect.insight}`); if (parts.length) this.log(`[${parts.join(' ')}]`, effect.hp<0||effect.san<0?"log-negative":"log-positive"); },
            // シナリオ進行度に応じたアイコン変更（日式）
            getScenarioIcon: function(turn) { if(turn<=5)return"fa-torii-gate"; if(turn<=15)return"fa-house-chimney-crack"; if(turn<=20)return"fa-dungeon"; return"fa-cloud-bolt"; },
            // 発狂時の幻聴（日式）
            getMadnessText: function() { const t=["後ろにいる...","オイデ...","見ツケタ...","逃ゲラレナイ...","ソッチハ駄目..."]; return t[Math.floor(Math.random()*t.length)]; },

            endGame: function(title, iconClass, desc) {
                this.isGameOver = true;
                const screen = document.getElementById('end-screen');
                document.getElementById('end-title').innerText = title;
                document.getElementById('end-desc').innerText = desc;
                document.getElementById('end-icon').innerHTML = `<i class="fas ${iconClass}"></i>`;
                document.getElementById('end-stats').innerText = `最終状態: 生命:${this.stats.hp} 心魂:${this.stats.san}`;
                setTimeout(() => screen.style.display = 'flex', 1500);
            },

            copyHistory: function() {
                const text = this.historyLog.join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("記録をクリップボードにコピーしました。");
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            }
        };
        window.onload = () => game.reset();
    </script>
</body>
</html>
