<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿·éœ§é®ï¼šå¤ç¥ä½èª (å®Œæ•´ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Space+Mono&display=swap');

        body {
            background-color: #050505;
            color: #c0c0c0;
            font-family: 'Noto Serif TC', serif;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .game-log::-webkit-scrollbar { width: 8px; }
        .game-log::-webkit-scrollbar-track { background: #1a1a1a; }
        .game-log::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .game-log::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* æ–‡å­—ç‰¹æ•ˆ */
        .text-sanity-high { color: #4ade80; }
        .text-sanity-med { color: #facc15; }
        .text-sanity-low { color: #ef4444; animation: pulse 1s infinite; }
        
        .text-highlight { color: #2dd4bf; font-weight: bold; }
        .text-item { color: #f472b6; font-weight: bold; }
        .text-clue { color: #fbbf24; font-weight: bold; border-bottom: 1px dashed #fbbf24; }
        .text-horror { color: #dc2626; font-family: 'Space Mono', monospace; }
        .text-system { color: #64748b; font-style: italic; }

        @keyframes pulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px #ef4444; }
            50% { opacity: 0.5; }
        }

        /* CRT æ•ˆæœ */
        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .btn-action {
            transition: all 0.2s;
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .btn-action:active { transform: scale(0.95); }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; border-color: #1e293b; }

        /* é€²åº¦æ¢ */
        .progress-bar-container {
            width: 100%;
            background-color: #1e293b;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #fbbf24;
            transition: width 0.5s ease;
        }

        /* Modal */
        .modal-overlay { backdrop-filter: blur(8px); background-color: rgba(0,0,0,0.85); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center overflow-hidden crt selection:bg-teal-900 selection:text-white">

    <div class="w-full max-w-4xl h-full md:h-[95vh] flex flex-col border-x border-slate-800 bg-neutral-900 shadow-2xl relative">
        
        <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
        <header class="p-3 border-b border-slate-700 bg-neutral-950 z-10 grid grid-cols-3 gap-2 items-center">
            <!-- å·¦å´ï¼šæ¨™é¡Œ -->
            <div>
                <h1 class="text-lg font-bold text-teal-500 tracking-widest">è¿·éœ§é®</h1>
                <div class="text-[10px] text-slate-500">MIST TOWN: RPG</div>
            </div>

            <!-- ä¸­é–“ï¼šèª¿æŸ¥åº¦ -->
            <div class="flex flex-col items-center w-full px-2">
                <div class="flex justify-between w-full text-xs text-yellow-500 mb-1">
                    <span>èª¿æŸ¥é€²åº¦</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- å³å´ï¼šç‹€æ…‹ -->
            <div class="flex flex-col items-end text-sm font-mono">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-400">SAN</span>
                    <span id="san-display" class="text-xl font-bold text-sanity-high">100</span>
                </div>
                <div id="location-display" class="text-slate-200 text-xs truncate max-w-[120px]">è¿·éœ§å…¥å£</div>
            </div>
        </header>

        <!-- éŠæˆ²æ—¥èªŒ -->
        <main id="game-log" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-3 bg-neutral-900 game-log font-mono text-sm md:text-base">
            <div class="text-system mb-6 border-b border-slate-800 pb-4">
                > è¼‰å…¥æ“´å……åœ°åœ–æ¨¡çµ„... å®Œæˆ<br>
                > è¼‰å…¥èª¿æŸ¥ä»»å‹™ä¸»ç·š... å®Œæˆ<br>
                > <span class="text-clue">ä»»å‹™ç›®æ¨™ï¼šæ”¶é›†é—œæ–¼é€™å€‹å°é®çš„çœŸç›¸ (èª¿æŸ¥åº¦ 100%)ï¼Œç„¶å¾Œæ´»è‘—å›åˆ°èµ·é»é€ƒé›¢ã€‚</span><br>
                ------------------------------------------------
            </div>
        </main>

        <!-- åº•éƒ¨æ§åˆ¶å€ -->
        <footer class="p-3 bg-neutral-950 border-t border-slate-800 z-10 select-none">
            
            <!-- åŠŸèƒ½æŒ‰éˆ• -->
            <div class="grid grid-cols-4 gap-2 mb-3">
                <button onclick="game.handleAction('investigate')" class="btn-action bg-slate-900 hover:bg-slate-800 text-amber-100 py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">ğŸ‘ï¸</span>
                    <span class="text-[10px] md:text-xs mt-1">èª¿æŸ¥å€åŸŸ</span>
                </button>
                <button onclick="game.handleAction('inventory')" class="btn-action bg-slate-900 hover:bg-slate-800 text-slate-200 py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">ğŸ’</span>
                    <span class="text-[10px] md:text-xs mt-1">èƒŒåŒ…ç‰©å“</span>
                </button>
                <button onclick="game.handleAction('status')" class="btn-action bg-slate-900 hover:bg-slate-800 text-slate-200 py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">ğŸ“Š</span>
                    <span class="text-[10px] md:text-xs mt-1">ç‹€æ…‹/ç·šç´¢</span>
                </button>
                <button onclick="game.handleAction('rest')" class="btn-action bg-slate-900 hover:bg-slate-800 text-slate-200 py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">ğŸ•¯ï¸</span>
                    <span class="text-[10px] md:text-xs mt-1">ä¼‘æ¯</span>
                </button>
            </div>

            <!-- ç§»å‹•é¢æ¿ -->
            <div class="flex items-center justify-center gap-4 bg-slate-900/50 p-2 rounded-lg border border-slate-800">
                <div class="grid grid-cols-3 gap-2 w-full max-w-xs">
                    <div class="col-start-2">
                        <button onclick="game.move('north')" id="btn-north" class="btn-action w-full bg-teal-900/20 hover:bg-teal-900/40 border-teal-800/50 text-teal-400 py-2 rounded font-mono text-sm">â–² åŒ—</button>
                    </div>
                    <div class="col-start-1 row-start-2">
                        <button onclick="game.move('west')" id="btn-west" class="btn-action w-full bg-teal-900/20 hover:bg-teal-900/40 border-teal-800/50 text-teal-400 py-2 rounded font-mono text-sm">â—€ è¥¿</button>
                    </div>
                    <div class="col-start-2 row-start-2 flex items-center justify-center">
                        <span class="text-slate-600 text-[10px] font-mono">MOVE</span>
                    </div>
                    <div class="col-start-3 row-start-2">
                        <button onclick="game.move('east')" id="btn-east" class="btn-action w-full bg-teal-900/20 hover:bg-teal-900/40 border-teal-800/50 text-teal-400 py-2 rounded font-mono text-sm">æ± â–¶</button>
                    </div>
                    <div class="col-start-2 row-start-3">
                        <button onclick="game.move('south')" id="btn-south" class="btn-action w-full bg-teal-900/20 hover:bg-teal-900/40 border-teal-800/50 text-teal-400 py-2 rounded font-mono text-sm">â–¼ å—</button>
                    </div>
                </div>
            </div>
        </footer>

        <!-- çµå±€/æ­»äº¡ Modal -->
        <div id="modal-endgame" class="hidden absolute inset-0 z-50 flex items-center justify-center modal-overlay p-4">
            <div class="bg-neutral-900 border border-slate-600 p-6 md:p-8 rounded-lg shadow-2xl max-w-md w-full text-center relative overflow-hidden">
                <div id="endgame-content">
                    <!-- å‹•æ…‹å…§å®¹ -->
                </div>
                <button onclick="location.reload()" class="mt-6 bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded border border-slate-600 w-full transition-colors">
                    é‡æ–°é–‹å§‹è¼ªè¿´
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. éŠæˆ²æ•¸æ“šé…ç½® (åœ°åœ–æ“´å……è‡³ 19 å€‹é») ---

        const LOCATIONS = {
            // èµ·é»èˆ‡ä¸­å¿ƒå€
            'start': {
                id: 'start',
                name: 'è¿·éœ§å…¥å£ (åœè»Šè™•)',
                desc: 'ä½ çš„è»Šæ‹‹éŒ¨åœ¨å°é®é‚Šç·£ã€‚å¼•æ“è“‹å†’è‘—ç…™ã€‚é€™è£¡æ˜¯ä½ å”¯ä¸€çš„é€ƒç”Ÿè·¯å¾‘ã€‚æœ¨ç‰Œä¸Šå¯«è‘—ã€Œæ­¡è¿ä¾†åˆ°å°æ–¯èŒ…...ã€å¾Œé¢çš„å­—è¢«åˆ®æ‰äº†ã€‚',
                exits: { north: 'square', east: 'forest', west: 'old_house' },
                events: ['intro_whisper'],
                isExitPoint: true
            },
            'square': {
                id: 'square',
                name: 'è’å»¢å»£å ´',
                desc: 'è¿·éœ§é®çš„ä¸­å¿ƒã€‚ä¸­å¤®æœ‰ä¸€åº§è¦†è“‹è‘—é˜²æ°´å¸ƒçš„æ‰­æ›²é›•åƒã€‚å››å‘¨æ­»ä¸€èˆ¬çš„å¯‚éœã€‚',
                exits: { south: 'start', north: 'church', east: 'dock', west: 'hotel', ne: 'library', se: 'store' },
                events: ['statue_move']
            },
            
            // è¥¿å€ï¼šä½å®¿èˆ‡é†«ç™‚
            'hotel': {
                id: 'hotel',
                name: 'é»‘æ°´æ—…é¤¨',
                desc: 'å¤§å»³æ›æ»¿äº†è¤ªè‰²çš„é»‘ç™½ç…§ç‰‡ï¼Œç…§ç‰‡è£¡çš„äººä¼¼ä¹éƒ½åœ¨çªè‘—ä½ ã€‚æ«ƒæª¯ä¸Šæœ‰ä¸€æœ¬ä½ˆæ»¿ç°å¡µçš„ç™»è¨˜ç°¿ã€‚',
                exits: { east: 'square', west: 'bar' },
                events: ['creepy_clerk'],
                canRest: true,
                clue: { id: 'guest_book', name: 'æ—…é¤¨åå†Š', desc: 'ä¸Šé¢å…¨æ˜¯å¤±è¹¤äººå£çš„åå­—ï¼Œä½ çœ‹åˆ°äº†ä½ è¦ªäººçš„åå­—ã€‚', progress: 15 }
            },
            'bar': {
                id: 'bar',
                name: 'é†‰é¬¼é…’é¤¨',
                desc: 'å……æ»¿äº†éœ‰å‘³å’Œé…’ç²¾å‘³ã€‚åœ°ä¸Šæ•£è½è‘—ç ´ç¢çš„é…’ç“¶ã€‚è§’è½è£¡ä¼¼ä¹åè‘—ä»€éº¼æ±è¥¿ã€‚',
                exits: { east: 'hotel', north: 'hospital' },
                events: ['drunk_monster']
            },
            'hospital': {
                id: 'hospital',
                name: 'è–ç‘ªéº—é†«é™¢',
                desc: 'é†«é™¢çš„å¤§é–€åŠæ©è‘—ï¼Œè£¡é¢å‚³ä¾†å„€å™¨é‹ä½œçš„é›»æµè²ï¼Œä½†é€™è£¡æ˜æ˜æ–·é›»å¾ˆä¹…äº†ã€‚æ¶ˆæ¯’æ°´å‘³æ··é›œè‘—è…è‡­ã€‚',
                exits: { south: 'bar', down: 'morgue', east: 'asylum' },
                events: ['nurse_shadow']
            },
            'morgue': {
                id: 'morgue',
                name: 'åœ°ä¸‹åœå±é–“',
                desc: 'æº«åº¦é©Ÿé™ã€‚å…©æ’åœå±æ«ƒï¼Œå…¶ä¸­ä¸€å€‹æ«ƒé–€æ­£åœ¨ç·©ç·©æ‰“é–‹...é€™è£¡çš„ç©ºæ°£ä»¤äººçª’æ¯ã€‚',
                exits: { up: 'hospital' },
                events: ['moving_body'],
                clue: { id: 'autopsy_report', name: 'é©—å±å ±å‘Š', desc: 'å ±å‘Šå¯«è‘—ï¼šæ­»è€…é«”å…§å……æ»¿äº†å¢¨ç¶ è‰²çš„æµ·æ°´ï¼Œå™¨å®˜è®Šç•°ç‚ºé°“ç‹€ã€‚', progress: 20 }
            },
            'asylum': {
                id: 'asylum',
                name: 'å»¢æ£„ç™‚é¤Šé™¢',
                desc: 'ç‰†å£ä¸Šå¯«æ»¿äº†ã€Œä¸è¦çœ‹ã€ã€ã€Œå®ƒå€‘åœ¨ç‰†è£¡ã€ã€‚é€™è£¡æ˜¯ç”¨ä¾†é—œæŠ¼çœ‹åˆ°çœŸç›¸çš„äººçš„åœ°æ–¹ã€‚',
                exits: { west: 'hospital' },
                events: ['crazy_scream'],
                item: 'straitjacket' // æŸç¸›è¡£
            },

            // æ±å€ï¼šæ¸¯å£èˆ‡ç‡ˆå¡”
            'dock': {
                id: 'dock',
                name: 'è…æœ½ç¢¼é ­',
                desc: 'æµ·æ°´å‘ˆç¾ä¸è‡ªç„¶çš„é»‘è‰²æ²¹è†©æ„Ÿã€‚ä½ å¯ä»¥çœ‹åˆ°æ°´ä¸‹æœ‰å·¨å¤§çš„é™°å½±æ¸¸éã€‚',
                exits: { west: 'square', north: 'lighthouse', east: 'sea_cave' },
                events: ['deep_one_watch']
            },
            'lighthouse': {
                id: 'lighthouse',
                name: 'å¤è€ç‡ˆå¡”',
                desc: 'ç‡ˆå¡”çš„æ¨“æ¢¯å‘ˆç¾èºæ—‹ç‹€ç„¡é™å‘ä¸Šå»¶ä¼¸ã€‚ç‰†å£ä¸Šåˆ»æ»¿äº†è¤»ç€†çš„ç¬¦è™Ÿã€‚',
                exits: { south: 'dock', up: 'lighthouse_top' },
                events: ['dizziness']
            },
            'lighthouse_top': {
                id: 'lighthouse_top',
                name: 'ç‡ˆå¡”é ‚å±¤',
                desc: 'å·¨å¤§çš„é€é¡å°æº–äº†æµ·é¢ä¸‹çš„æŸå€‹é»ã€‚é€™è£¡å¯ä»¥ä¿¯ç°å…¨é®ï¼Œä½ ç™¼ç¾å°é®çš„ä½ˆå±€åƒä¸€å€‹å¬å–šé™£ã€‚',
                exits: { down: 'lighthouse' },
                clue: { id: 'ritual_map', name: 'æ˜Ÿè±¡åœ–', desc: 'æ¨™è¨˜äº†ä»Šæ™šæ˜¯ç¾¤æ˜Ÿæ­¸ä½ä¹‹æ™‚ã€‚', progress: 20 }
            },
            'sea_cave': {
                id: 'sea_cave',
                name: 'æµ·è•æ´',
                desc: 'åªæœ‰é€€æ½®æ™‚æ‰èƒ½é€²å…¥ã€‚æ´ç©´æ·±è™•æœ‰å¾®å¼±çš„ç¶ å…‰å’Œå’€åš¼è²ã€‚',
                exits: { west: 'dock' },
                events: ['shoggoth_slime'],
                item: 'gold_coin' // å¤é‡‘å¹£
            },

            // åŒ—å€ï¼šå®—æ•™èˆ‡æ­»äº¡
            'church': {
                id: 'church',
                name: 'é”è²¢é›†æœƒæ‰€',
                desc: 'åŸæœ¬çš„åå­—æ¶è¢«å€’ç½®ä¸¦æ‰­æ›²æˆç« é­šçš„å½¢ç‹€ã€‚è¬›é“å°ä¸Šæ”¾è‘—ä¸€æœ¬åšé‡çš„æ›¸ã€‚',
                exits: { south: 'square', north: 'graveyard' },
                clue: { id: 'cult_book', name: 'æ•™åœ˜ç¶“æ–‡', desc: 'è¨˜è¼‰äº†å¦‚ä½•å–šé†’æ²‰ç¡è€…çš„å’’èªã€‚', progress: 15 }
            },
            'graveyard': {
                id: 'graveyard',
                name: 'ç„¡åå¢“åœ’',
                desc: 'å¢“ç¢‘å¤§å¤šæ­ªæ–œæˆ–ç ´ç¢ã€‚å¾ˆå¤šå¢³å¢“æ˜¯ç©ºçš„ï¼Œåƒæ˜¯å¾è£¡é¢è¢«æŒ–é–‹ä¸€æ¨£ã€‚',
                exits: { south: 'church', down: 'crypt' },
                events: ['ghoul_sound']
            },
            'crypt': {
                id: 'crypt',
                name: 'åœ°ä¸‹ç¥­å£‡',
                desc: 'ç©ºæ°£ä¸­å……æ»¿ç¡«ç£ºå‘³ã€‚åœ°ä¸Šç•«è‘—å·¨å¤§çš„æ³•é™£ï¼Œä¸­é–“æœ‰ä¸€å¡Šç™¼å…‰çš„çŸ³é ­ã€‚',
                exits: { up: 'graveyard' },
                clue: { id: 'star_stone', name: 'æ˜Ÿä¹‹çŸ³', desc: 'é€™æ˜¯å°å°æˆ–å¬å–šçš„é—œéµè§¸åª’ã€‚', progress: 20 },
                dangerLevel: 'high'
            },

            // å‘¨é‚Šå€åŸŸ
            'library': {
                id: 'library',
                name: 'é®ç«‹åœ–æ›¸é¤¨',
                desc: 'æ›¸æ¶å€’å¡Œï¼Œæ»¿åœ°ç‹¼ç±ã€‚åªæœ‰é—œæ–¼ç¥ç§˜å­¸çš„å€åŸŸä¸€å¡µä¸æŸ“ã€‚',
                exits: { sw: 'square', secret: 'hidden_room' },
                events: ['book_fall'],
                clue: { id: 'diary_fragment', name: 'é¤¨é•·æ—¥è¨˜', desc: 'æåˆ°ã€Œä¸è¦ç›¸ä¿¡ä»»ä½•äººï¼Œå°¤å…¶æ˜¯æ—…é¤¨è€é—†ã€ã€‚', progress: 10 }
            },
            'store': {
                id: 'store',
                name: 'é›œè²¨åº—',
                desc: 'è²¨æ¶ä¸Šå‰©ä¸‹çš„åªæœ‰ç™¼éœ‰çš„ç½é ­ã€‚æ”¶éŠ€æ©Ÿè¢«ç ¸çˆ›äº†ã€‚',
                exits: { nw: 'square' },
                item: 'medkit' // å¿…æœ‰è£œçµ¦
            },
            'forest': {
                id: 'forest',
                name: 'è¿·éœ§æ£®æ—',
                desc: 'æ¨¹æœ¨é•·å¾—åƒæ‰­æ›²çš„äººé«”ã€‚æŒ‡å—é‡åœ¨é€™è£¡ç˜‹ç‹‚æ—‹è½‰ã€‚',
                exits: { west: 'start', east: 'swamp' },
                events: ['tree_catch']
            },
            'swamp': {
                id: 'swamp',
                name: 'é»‘æ³¥æ²¼æ¾¤',
                desc: 'æ¯èµ°ä¸€æ­¥éƒ½æœƒé™·å…¥æ³¥æ¿˜ã€‚æ³¥æ½­è£¡å†’è‘—æ°£æ³¡ã€‚',
                exits: { west: 'forest' },
                item: 'whiskey'
            },
            'old_house': {
                id: 'old_house',
                name: 'æ—ä¸­å°å±‹',
                desc: 'åƒæ˜¯çµäººçš„å°å±‹ï¼Œç‰†ä¸Šæ›è‘—å¥‡æ€ªçš„ç¸éª¨æ¨™æœ¬ã€‚',
                exits: { east: 'start' },
                item: 'shotgun_shell'
            }
        };

        // --- 2. ç‰©å“èˆ‡äº‹ä»¶åº« ---

        // æ¶ˆè€—å“ (Consumable) èˆ‡ é—œéµé“å…· (Key)
        const ITEMS_DB = {
            'medkit': { name: 'æ€¥æ•‘åŒ…', type: 'consumable', effect: 20, desc: 'èˆŠå¼è»ç”¨æ€¥æ•‘åŒ…ï¼Œå«å—å•¡ã€‚ (+20 SAN)' },
            'whiskey': { name: 'é™³å¹´å¨å£«å¿Œ', type: 'consumable', effect: 10, desc: 'çƒˆé…’èƒ½éº»ç—ºç¥ç¶“ï¼Œæš«æ™‚å¿˜å»ææ‡¼ã€‚ (+10 SAN)' },
            'sedative': { name: 'å¼·åŠ›é®éœåŠ‘', type: 'consumable', effect: 30, desc: 'é†«é™¢æ‰¾åˆ°çš„è—¥ç‰©ï¼Œæ•ˆæœé¡¯è‘—ã€‚ (+30 SAN)' },
            'shotgun_shell': { name: 'çµæ§å­å½ˆ', type: 'key', desc: 'æˆ–è¨±èƒ½ç”¨ä¾†å°ä»˜é‚£äº›æ±è¥¿...å¦‚æœä½ æœ‰æ§çš„è©±ã€‚' },
            'gold_coin': { name: 'æ·±æµ·é‡‘å¹£', type: 'key', desc: 'å½¢ç‹€å¥‡ç•°çš„é‡‘å¹£ï¼Œè§¸æ„Ÿå†°æ¶¼æ»‘è†©ã€‚' },
            'straitjacket': { name: 'æŸç¸›è¡£æ®˜ç‰‡', type: 'key', desc: 'ä¸Šé¢ç¹¡è‘—æŸå€‹ç—…äººçš„ç·¨è™Ÿã€‚' }
        };

        const RANDOM_EVENTS = [
            { text: 'ä¸€é™£å¸¶æœ‰è…¥å‘³çš„æ¿•é¢¨å¹éï¼Œä½ è½åˆ°æœ‰äººåœ¨è€³é‚Šä½èªä½ çš„åå­—...', san: -5 },
            { text: 'ä½ æ„Ÿè¦ºæœ‰è¦–ç·šæ­»æ­»ç›¯è‘—ä½ çš„å¾Œé ¸ï¼ŒçŒ›ç„¶å›é ­å»ç©ºç„¡ä¸€äººã€‚', san: -3 },
            { text: 'åœ°é¢ä¸Šçš„å½±å­ä¼¼ä¹æœ‰äº†è‡ªå·±çš„æ„è­˜ï¼Œå‘ä½ çš„è…³é‚Šå»¶ä¼¸ã€‚', san: -4 },
            { text: 'é è™•å‚³ä¾†éäººé¡çš„åšå«è²ï¼Œé‚£è²éŸ³ä¸å±¬æ–¼åœ°çƒä¸Šçš„ä»»ä½•ç”Ÿç‰©ã€‚', san: -8 },
            { text: 'ä½ çªç„¶æ„Ÿåˆ°ä¸€é™£å¼·çƒˆçš„æšˆçœ©ï¼Œçœ¼å‰çš„æ™¯ç‰©è®Šæˆäº†æ‰­æ›²çš„å¹¾ä½•åœ–å½¢ã€‚', san: -5 },
            { text: 'ä¸€éš»æ­»çƒé´‰å¾å¤©è€Œé™ï¼Œæ‰åœ¨ä½ çš„è…³é‚Šï¼Œå®ƒçš„å…§è‡Ÿè¢«æç©ºäº†ã€‚', san: -2 },
            { text: 'ä½ çœ‹åˆ°ä¸€å€‹é•·è‘—é­šé°“çš„äººå½±åœ¨éœ§ä¸­ä¸€é–ƒè€Œéã€‚', san: -6 }
        ];

        // --- 3. éŠæˆ²æ ¸å¿ƒé¡åˆ¥ ---

        class Game {
            constructor() {
                this.san = 100;
                this.investigationProgress = 0;
                this.currentLocationId = 'start';
                this.inventory = []; // å­˜å„² {id, name, type...}
                this.cluesFound = []; // å­˜å„²å·²ç™¼ç¾çš„ç·šç´¢ ID
                this.turnCount = 0;
                this.isGameOver = false;

                // DOM å…ƒç´ ç·©å­˜
                this.logEl = document.getElementById('game-log');
                this.sanEl = document.getElementById('san-display');
                this.locEl = document.getElementById('location-display');
                this.progTextEl = document.getElementById('progress-text');
                this.progBarEl = document.getElementById('progress-bar');
                
                this.init();
            }

            init() {
                this.print('ä½ é†’ä¾†æ™‚ç™¼ç¾è»Šå­æ‹‹éŒ¨åœ¨è¿·éœ§ä¸­ã€‚', 'system');
                this.print('ç›´è¦ºå‘Šè¨´ä½ ï¼Œå¿…é ˆç›¡å¿«æ”¶é›†è¶³å¤ çš„ç·šç´¢äº†è§£é€™è£¡ç™¼ç”Ÿäº†ä»€éº¼ï¼Œç„¶å¾Œé€ƒé›¢ã€‚', 'system');
                this.enterLocation('start');
            }

            // æ›´æ–° UI
            updateUI() {
                // SAN
                this.sanEl.innerText = this.san;
                this.sanEl.className = 'text-xl font-bold transition-colors ' + 
                    (this.san > 70 ? 'text-sanity-high' : 
                     this.san > 30 ? 'text-sanity-med' : 'text-sanity-low');

                // åœ°é»
                this.locEl.innerText = LOCATIONS[this.currentLocationId].name;

                // é€²åº¦æ¢
                this.progTextEl.innerText = this.investigationProgress + '%';
                this.progBarEl.style.width = this.investigationProgress + '%';

                // æŒ‰éˆ•ç‹€æ…‹ (è™•ç†æ–¹å‘éµ)
                const currentExits = LOCATIONS[this.currentLocationId].exits;
                
                // ç°¡æ˜“æ˜ å°„ï¼šå°‡æ–¹å‘æŒ‰éˆ•ç¶å®šåˆ°å¸¸è¦‹å‡ºå£
                this.updateDirBtn('btn-north', currentExits.north || currentExits.up);
                this.updateDirBtn('btn-south', currentExits.south || currentExits.down);
                this.updateDirBtn('btn-east', currentExits.east || currentExits.ne || currentExits.se);
                this.updateDirBtn('btn-west', currentExits.west || currentExits.nw || currentExits.sw);
            }

            updateDirBtn(btnId, target) {
                const btn = document.getElementById(btnId);
                if (target) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.2';
                }
            }

            // è¼¸å‡ºæ—¥èªŒ
            print(text, type = 'normal') {
                const div = document.createElement('div');
                div.className = 'leading-relaxed animate-fade-in';
                
                let icon = '';
                if (type === 'system') { div.className += ' text-system border-l-2 border-slate-700 pl-2'; icon = ''; }
                else if (type === 'horror') { div.className += ' text-horror bg-red-950/20 p-2 border-l-2 border-red-800'; icon = 'âš  '; }
                else if (type === 'success') { div.className += ' text-teal-400'; icon = 'âœ“ '; }
                else if (type === 'item') { div.className += ' text-item'; icon = 'ğŸ '; }
                else if (type === 'clue') { div.className += ' text-clue'; icon = 'ğŸ” '; }
                else if (type === 'action') { div.className += ' text-slate-400 italic text-xs'; icon = '> '; }

                div.innerHTML = icon + text;
                this.logEl.appendChild(div);
                this.logEl.scrollTop = this.logEl.scrollHeight;
            }

            // è™•ç†æŒ‰éˆ•å‹•ä½œ (ä¿®å¾©ï¼šæ–°å¢ç¼ºå¤±çš„ handleAction å‡½å¼)
            handleAction(actionType) {
                if (this.isGameOver) return;
                switch(actionType) {
                    case 'investigate':
                        this.investigate();
                        break;
                    case 'inventory':
                        this.showInventory();
                        break;
                    case 'status':
                        this.showStatus();
                        break;
                    case 'rest':
                        this.rest();
                        break;
                }
            }

            // ç§»å‹•é‚è¼¯
            move(dirKey) {
                if (this.isGameOver) return;
                
                const loc = LOCATIONS[this.currentLocationId];
                // æ ¹æ“šæŒ‰éˆ•é»æ“Šï¼Œæ¨¡ç³ŠåŒ¹é…å‡ºå£
                let targetId = null;
                
                if (dirKey === 'north') targetId = loc.exits.north || loc.exits.up;
                if (dirKey === 'south') targetId = loc.exits.south || loc.exits.down;
                if (dirKey === 'east') targetId = loc.exits.east || loc.exits.ne || loc.exits.se;
                if (dirKey === 'west') targetId = loc.exits.west || loc.exits.nw || loc.exits.sw || loc.exits.secret;

                if (targetId) {
                    this.print(`å‰å¾€ ${LOCATIONS[targetId].name}...`, 'action');
                    setTimeout(() => this.enterLocation(targetId), 400);
                }
            }

            enterLocation(locId) {
                this.currentLocationId = locId;
                const loc = LOCATIONS[locId];
                
                this.print(`<br><strong class="text-teal-500 text-lg">ğŸ“ æŠµé”ï¼š${loc.name}</strong>`, 'normal');
                this.print(loc.desc, 'normal');
                
                this.updateUI();

                // æª¢æŸ¥æ˜¯å¦é€šé—œ
                if (loc.isExitPoint && this.investigationProgress >= 100) {
                    this.triggerGoodEnd();
                    return;
                }

                // å±éšªå€åŸŸå¼·åˆ¶æ‰£ SAN
                if (loc.dangerLevel === 'high') {
                    this.changeSan(-5, 'é€™å€‹å€åŸŸçš„é‚ªæƒ¡æ°£æ¯è®“ä½ æ„Ÿåˆ°çª’æ¯ï¼');
                }

                // 30% æ©Ÿç‡è§¸ç™¼éš¨æ©Ÿææ€–äº‹ä»¶
                if (Math.random() < 0.3) {
                    this.triggerRandomEvent(loc);
                }
            }

            // èª¿æŸ¥é‚è¼¯
            investigate() {
                if (this.isGameOver) return;
                this.print('ä½ é–‹å§‹ä»”ç´°æœæŸ¥å‘¨åœ...', 'action');
                const loc = LOCATIONS[this.currentLocationId];
                let foundSomething = false;

                // 1. æª¢æŸ¥æ˜¯å¦æœ‰åŠ‡æƒ…ç·šç´¢ (åªè§¸ç™¼ä¸€æ¬¡)
                if (loc.clue && !this.cluesFound.includes(loc.clue.id)) {
                    // 50% æ©Ÿç‡ç™¼ç¾ç·šç´¢ (å¦‚æœé‚„æ²’ç™¼ç¾)
                    if (Math.random() < 0.8) { // æé«˜æ©Ÿç‡è®“éŠæˆ²æµæš¢é»
                        this.foundClue(loc.clue);
                        foundSomething = true;
                    }
                }

                // 2. æª¢æŸ¥æ˜¯å¦æœ‰ç‰©å“ (åªæ‹¿ä¸€æ¬¡ï¼Œç°¡å–®è™•ç†)
                if (!foundSomething && loc.item) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ‹¿é (ç°¡å–®é˜²åˆ·ï¼šé€™è£¡æš«æ™‚æ¯æ¬¡éƒ½èƒ½æ‹¿è—¥æœ‰é»å¤ªç°¡å–®ï¼Œæ”¹ç‚ºå„é»åªæœ‰ä¸€æ¬¡æ©Ÿæœƒ)
                    if (!loc.itemTaken) {
                        const itemKey = loc.item;
                        // å¦‚æœæ˜¯å›ºå®šç‰©å“é…ç½®
                        let item = ITEMS_DB[itemKey]; 
                        // å¦‚æœæ²’æœ‰é…ç½®ï¼Œéš¨æ©Ÿçµ¦è—¥
                        if (!item) item = ITEMS_DB['medkit'];

                        this.inventory.push(item);
                        loc.itemTaken = true; // æ¨™è¨˜å·²æ‹¿å–
                        this.print(`ä½ åœ¨è§’è½ç™¼ç¾äº†ï¼š${item.name}`, 'item');
                        foundSomething = true;
                    }
                }

                // 3. ä»€éº¼éƒ½æ²’ç™¼ç¾ / éš¨æ©Ÿäº‹ä»¶
                if (!foundSomething) {
                    if (Math.random() < 0.4) {
                        this.print('é€™è£¡é™¤äº†ä¸€äº›ä»¤äººä¸å®‰çš„ç—•è·¡å¤–ï¼Œä»€éº¼éƒ½æ²’æœ‰ã€‚', 'normal');
                    } else {
                        this.triggerRandomEvent(loc);
                    }
                }
            }

            foundClue(clueObj) {
                this.cluesFound.push(clueObj.id);
                this.investigationProgress += clueObj.progress;
                if (this.investigationProgress > 100) this.investigationProgress = 100;
                
                this.print(`ç™¼ç¾é—œéµç·šç´¢ï¼š${clueObj.name}`, 'clue');
                this.print(`${clueObj.desc}`, 'system');
                this.print(`èª¿æŸ¥åº¦æå‡ï¼ (ç›®å‰: ${this.investigationProgress}%)`, 'success');
                this.updateUI();
            }

            // ç‰©å“æ¬„é‚è¼¯
            showInventory() {
                if (this.inventory.length === 0) {
                    this.print('ä½ çš„èƒŒåŒ…è£¡ä»€éº¼éƒ½æ²’æœ‰ã€‚', 'system');
                    return;
                }

                let content = '<div class="bg-slate-800 p-3 rounded text-sm">';
                content += '<h3 class="text-teal-400 font-bold border-b border-slate-600 mb-2">ğŸ“¦ èƒŒåŒ…ç‰©å“</h3>';
                
                this.inventory.forEach((item, idx) => {
                    content += `<div class="flex justify-between items-center mb-2">
                        <span>${idx + 1}. <span class="${item.type === 'key' ? 'text-yellow-400' : 'text-pink-300'}">${item.name}</span></span>
                        ${item.type === 'consumable' 
                            ? `<button onclick="game.useItem(${idx})" class="text-xs border border-slate-500 px-2 py-1 rounded hover:bg-slate-600">ä½¿ç”¨</button>` 
                            : `<span class="text-xs text-slate-500">[åŠ‡æƒ…]</span>`}
                    </div>`;
                });
                content += '</div>';
                this.print(content);
            }

            useItem(index) {
                const item = this.inventory[index];
                if (item.type === 'consumable') {
                    this.changeSan(item.effect);
                    this.print(`ä½ ä½¿ç”¨äº† ${item.name}ã€‚`, 'success');
                    this.inventory.splice(index, 1); // ç§»é™¤
                    // é‡æ–°é¡¯ç¤ºèƒŒåŒ…æœƒæœ‰æŠ€è¡“å›°é›£(å› ç‚ºæ—¥èªŒæµå‹•)ï¼Œé€™è£¡ç°¡å–®æç¤ºå³å¯
                }
            }

            // ç‹€æ…‹é‚è¼¯
            showStatus() {
                let statusHtml = `<div class="bg-slate-900 border border-slate-700 p-4 rounded text-sm font-mono">
                    <h3 class="text-lg text-teal-500 font-bold mb-2">èª¿æŸ¥å“¡ç‹€æ…‹</h3>
                    <p>â¤ï¸ ç†æ™º (SAN): <span class="${this.san > 50 ? 'text-green-400' : 'text-red-500'}">${this.san}/100</span></p>
                    <p>ğŸ“ ç•¶å‰ä½ç½®: ${LOCATIONS[this.currentLocationId].name}</p>
                    <p>ğŸ•µï¸ èª¿æŸ¥é€²åº¦: ${this.investigationProgress}%</p>
                    <div class="mt-3 border-t border-slate-700 pt-2">
                        <p class="text-yellow-500 mb-1">å·²æ”¶é›†é—œéµç·šç´¢/é“å…·:</p>
                        <ul class="list-disc list-inside text-slate-400 text-xs">`;
                
                // åˆ—å‡ºå·²ç™¼ç¾çš„ç·šç´¢é“å…·
                let hasKeyItems = false;
                
                // 1. ä¾†è‡ª clue
                this.cluesFound.forEach(cid => {
                    // é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥åæŸ¥æ‰€æœ‰åœ°é»æ‰¾åå­— (æ•ˆèƒ½ä¸ä½³ä½†è³‡æ–™é‡å°ç„¡æ‰€è¬‚)
                    for(let k in LOCATIONS) {
                        if(LOCATIONS[k].clue && LOCATIONS[k].clue.id === cid) {
                            statusHtml += `<li>${LOCATIONS[k].clue.name}</li>`;
                            hasKeyItems = true;
                        }
                    }
                });
                
                // 2. ä¾†è‡ª inventory çš„ key items
                this.inventory.filter(i => i.type === 'key').forEach(i => {
                    statusHtml += `<li>${i.name}</li>`;
                    hasKeyItems = true;
                });

                if(!hasKeyItems) statusHtml += '<li>(æš«ç„¡)</li>';

                statusHtml += `</ul></div></div>`;
                this.print(statusHtml);
            }

            rest() {
                if (LOCATIONS[this.currentLocationId].canRest) {
                    this.print('ä½ é–å¥½é–€çª—ï¼Œåœ¨ä¸å®‰ä¸­ç¡å»...', 'action');
                    setTimeout(() => {
                         this.changeSan(15);
                         this.print('é«”åŠ›æ¢å¾©äº†ä¸€äº›ï¼Œä½†æƒ¡å¤¢æ®ä¹‹ä¸å»ã€‚ (+15 SAN)', 'success');
                    }, 1000);
                } else {
                    this.print('é€™è£¡å¤ªå±éšªäº†ï¼Œç„¡æ³•ä¼‘æ¯ã€‚', 'system');
                }
            }

            changeSan(amount, msg) {
                this.san += amount;
                if (this.san > 100) this.san = 100;
                
                if (msg) this.print(msg, amount < 0 ? 'horror' : 'success');
                else if (amount < 0) this.print(`ç†æ™ºå—åˆ°è¡æ“Šï¼ ${amount} SAN`, 'horror');
                
                this.updateUI();
                if (this.san <= 0) this.triggerBadEnd();
            }

            triggerRandomEvent(loc) {
                // å„ªå…ˆè§¸ç™¼åœ°é»å°ˆå±¬äº‹ä»¶
                if (loc.events && loc.events.length > 0 && Math.random() < 0.6) {
                    // é€™è£¡ç°¡åŒ–ï¼Œä¸å¯¦ä½œè¤‡é›œçš„äº‹ä»¶åº«æ˜ å°„ï¼Œç›´æ¥ç”¨é€šç”¨çš„ï¼Œæˆ–å¯ä»¥åœ¨ LOCATIONS è£¡å¯«æ­»æ–‡æœ¬
                    // ç‚ºäº†æ“´å……æ€§ï¼Œé€™è£¡æ¼”ç¤ºä½¿ç”¨é€šç”¨éš¨æ©Ÿäº‹ä»¶ + å°‘é‡å°ˆå±¬é‚è¼¯
                    const evt = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    this.print(evt.text, 'horror');
                    this.changeSan(evt.san);
                } else {
                    const evt = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    this.print(evt.text, 'horror');
                    this.changeSan(evt.san);
                }
            }

            triggerBadEnd() {
                this.isGameOver = true;
                const modal = document.getElementById('modal-endgame');
                const content = document.getElementById('endgame-content');
                content.innerHTML = `
                    <h2 class="text-3xl font-bold text-red-600 mb-4 font-mono tracking-widest">ç†æ™ºå´©å£</h2>
                    <p class="text-slate-300 mb-6">ä½ çœ¼ä¸­çš„ä¸–ç•Œæ‰­æ›²æˆäº†ç„¡æ³•ç†è§£çš„å¹¾ä½•åœ–å½¢ï¼Œä½èªè²è®Šæˆäº†å°–å«...ä½ æ°¸é ç•™åœ¨äº†è¿·éœ§é®ã€‚</p>
                    <div class="text-sm text-slate-500">èª¿æŸ¥é€²åº¦: ${this.investigationProgress}%</div>
                `;
                modal.classList.remove('hidden');
            }

            triggerGoodEnd() {
                this.isGameOver = true;
                const modal = document.getElementById('modal-endgame');
                const content = document.getElementById('endgame-content');
                content.innerHTML = `
                    <h2 class="text-3xl font-bold text-teal-500 mb-4 font-mono tracking-widest">æˆåŠŸé€ƒè„«</h2>
                    <p class="text-slate-300 mb-6">ä½ æ‹¼æ¹Šå‡ºäº†çœŸç›¸ï¼Œç”¨é¡«æŠ–çš„æ‰‹ç™¼å‹•äº†å¼•æ“ã€‚å¾Œç…§é¡è£¡ï¼Œå°é®è¢«æ¹§èµ·çš„é»‘è‰²æµ·æ°´æ·¹æ²’ã€‚ä½ æ´»ä¸‹ä¾†äº†ï¼Œä½†é‚£äº›è¨˜æ†¶å°‡æ°¸é ä¼´éš¨è‘—ä½ ã€‚</p>
                    <div class="text-xl text-yellow-500 font-bold">å®Œç¾é”æˆ (èª¿æŸ¥åº¦ 100%)</div>
                `;
                modal.classList.remove('hidden');
            }
        }

        const game = new Game();

    </script>
</body>
</html>