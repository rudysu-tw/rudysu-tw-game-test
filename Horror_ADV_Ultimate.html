<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>詭屋異行：命運迴廊 - 沉浸體驗版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #050505;
            --text-color: #c0c0c0;
            --accent-color: #8b0000;
            --san-color: #4a90e2;
            --hp-color: #e74c3c;
            --courage-color: #f1c40f;
            --insight-color: #9b59b6;
            --item-color: #f39c12;
            --ui-bg: #141414;
            --border-color: #444;
            --success-color: #2ecc71;
            --fail-color: #e74c3c;
            --fuel-color: #3498db;
            --event-color: #e67e22;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        #app-container { width: 100%; max-width: 900px; height: 100%; display: flex; flex-direction: column; background: var(--ui-bg); border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); position: relative; z-index: 5; box-shadow: 0 0 40px rgba(0,0,0,0.95); }
        
        #vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; box-shadow: inset 0 0 100px rgba(0,0,0,0.9); z-index: 10; transition: box-shadow 0.5s ease; }
        .pulse-fast { animation: heartbeat 0.8s infinite; }
        .pulse-slow { animation: heartbeat 2s infinite; }
        @keyframes heartbeat { 0% { box-shadow: inset 0 0 50px rgba(139, 0, 0, 0.2); } 50% { box-shadow: inset 0 0 150px rgba(139, 0, 0, 0.6); } 100% { box-shadow: inset 0 0 50px rgba(139, 0, 0, 0.2); } }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .text-distort { text-shadow: 2px 0 var(--hp-color), -2px 0 var(--san-color); animation: glitch-text 0.2s infinite; }
        @keyframes glitch-text { 0% { transform: translate(0); opacity: 1; } 20% { transform: translate(-1px, 1px); opacity: 0.8; } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, -1px); opacity: 0.9; } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0); opacity: 1; } }
        .hallucination { filter: blur(1px) hue-rotate(30deg) contrast(1.2); transition: filter 1s; }

        @keyframes item-glow { 0% { box-shadow: 0 0 5px var(--item-color); background: #333; } 50% { box-shadow: 0 0 30px var(--item-color), inset 0 0 20px var(--item-color); background: #543; } 100% { box-shadow: 0 0 5px var(--item-color); background: #222; } }
        .item-get-anim { animation: item-glow 0.8s ease-out; }

        #start-screen, #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 5, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 30; text-align: center; padding: 30px; }
        h1 { color: var(--accent-color); font-size: 2.5rem; text-shadow: 0 0 15px rgba(139, 0, 0, 0.8); margin-bottom: 10px; letter-spacing: 3px; font-weight: bold; }
        .start-btn { background: rgba(20, 20, 20, 0.9); color: #ddd; border: 1px solid var(--accent-color); padding: 12px 40px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; transition: all 0.3s; font-family: inherit; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 15px rgba(139, 0, 0, 0.3); border-radius: 4px; }
        .start-btn:hover { background: var(--accent-color); color: #fff; box-shadow: 0 0 30px var(--accent-color); transform: scale(1.05); }

        header { padding: 8px 15px; border-bottom: 1px solid var(--border-color); background: #0f0f0f; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; letter-spacing: 1px; flex-shrink: 0; }
        
        #status-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border-color); padding-bottom: 1px; flex-shrink: 0; }
        .stat-box { display: flex; flex-direction: column; align-items: center; padding: 6px 2px; background: #111; transition: background 0.3s; }
        .stat-label { font-size: 0.65rem; color: #666; margin-bottom: 2px; letter-spacing: 0.5px; }
        .stat-value { font-weight: bold; font-size: 1rem; }
        .hp-val { color: var(--hp-color); }
        .san-val { color: var(--san-color); }
        .courage-val { color: var(--courage-color); }
        .ins-val { color: var(--insight-color); }
        .fuel-val { color: var(--fuel-color); }

        #inventory-bar { padding: 5px 15px; background: #0a0a0a; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; min-height: 35px; align-items: center; overflow-x: auto; flex-shrink: 0; }
        .inv-item { background: #222; border: 1px solid #444; padding: 2px 8px; font-size: 0.75rem; border-radius: 4px; color: var(--item-color); display: flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* UI調整：故事區擴大，字體與行距優化 */
        #story-area { flex: 2 1 auto; padding: 25px 30px; overflow-y: auto; line-height: 1.8; font-size: 1.15rem; color: #e0e0e0; border-bottom: 1px solid var(--border-color); background-image: radial-gradient(circle at center, #1f1f1f 0%, #141414 100%); position: relative; min-height: 280px; }
        .story-text { margin-bottom: 15px; opacity: 0; animation: fadeIn 1s forwards; text-align: justify; word-wrap: break-word; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* UI調整：選擇區 */
        #choice-area { padding: 10px 15px; display: grid; grid-template-columns: 1fr; gap: 8px; background: #111; flex-shrink: 0; }
        @media (min-width: 700px) { #choice-area { grid-template-columns: 1fr 1fr; gap: 12px; } }

        .choice-btn { background: linear-gradient(145deg, #1e1e1e, #181818); border: 1px solid #333; color: #bbb; padding: 10px 12px; cursor: pointer; font-family: inherit; font-size: 0.9rem; text-align: left; transition: all 0.2s; display: flex; flex-direction: column; justify-content: center; border-radius: 4px; position: relative; min-height: 55px; }
        .choice-title { font-weight: bold; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; color: #ddd; font-size: 0.95rem; }
        .choice-desc { font-size: 0.75rem; color: #777; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .choice-btn i { font-size: 0.9rem; color: #666; width: 18px; text-align: center; }
        .choice-btn:hover { background: #252525; color: #fff; border-color: #666; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .choice-btn:hover i { color: var(--item-color); }
        .choice-btn:hover .choice-desc { color: #aaa; }
        .chance-tag { position: absolute; top: 6px; right: 6px; font-size: 0.65rem; background: #222; padding: 1px 4px; border-radius: 3px; color: #aaa; border: 1px solid #333; }
        
        .madness-choice { border-color: var(--accent-color) !important; color: var(--hp-color) !important; font-family: "Impact", monospace; letter-spacing: 1px; animation: shake 2s infinite; background: #1a0505; }
        .phantom-choice { border: 1px dashed #444; opacity: 0.95; }

        /* UI調整：日誌區高度增加至 140px (約 5-6 行) */
        #log-window { height: 140px; background: #000; border-top: 2px solid var(--border-color); padding: 10px 12px; font-size: 0.85rem; font-family: "Courier New", monospace; color: #0f0; overflow-y: scroll; display: flex; flex-direction: column; flex-shrink: 0; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #222; padding-bottom: 2px; line-height: 1.4; animation: fadeIn 0.3s; }
        .log-new { color: #fff; text-shadow: 0 0 5px #0f0; border-left: 3px solid #0f0; padding-left: 5px; }
        .log-negative { color: var(--hp-color); }
        .log-positive { color: var(--success-color); }
        .log-info { color: #f1c40f; }
        .log-item { color: var(--item-color); font-weight: bold; }
        .log-event { color: var(--event-color); font-weight: bold; }
        .log-phantom { color: #888; font-style: italic; text-decoration: line-through; }

        #dice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 25; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #dice-visual { width: 120px; height: 120px; border: 5px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 4rem; font-weight: bold; color: #fff; background: #111; box-shadow: 0 0 40px rgba(255,255,255,0.1); border-radius: 18px; margin-bottom: 20px; transition: all 0.1s; }
        .dice-rolling { animation: roll 0.05s infinite; }
        @keyframes roll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(8deg) scale(1.02); } 50% { transform: rotate(0deg) scale(1); } 75% { transform: rotate(-8deg) scale(1.02); } 100% { transform: rotate(0deg) scale(1); } }
        .dice-success { border-color: var(--success-color) !important; color: var(--success-color) !important; box-shadow: 0 0 50px var(--success-color) !important; transform: scale(1.1); }
        .dice-fail { border-color: var(--fail-color) !important; color: var(--fail-color) !important; box-shadow: 0 0 50px var(--fail-color) !important; transform: scale(0.9); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div id="vignette"></div>
    <div id="dice-overlay"><div id="dice-visual">?</div><div id="dice-msg" style="font-size: 1.5rem; color: #ddd; margin-bottom: 10px; font-weight: bold; letter-spacing: 2px;">命運檢定中...</div><div id="dice-detail" style="font-size: 1rem; color: #888;"></div></div>

    <div id="app-container">
        <div id="start-screen">
            <h1><i class="fas fa-dungeon"></i> 詭屋異行</h1>
            <p style="color: #888; margin-bottom: 25px; font-size: 1rem; letter-spacing: 3px;">DEPTHS OF MADNESS - IMMERSIVE EDITION</p>
            <div style="max-width: 500px; line-height: 1.8; text-align: left; background: #111; padding: 25px; border: 1px solid #333; border-radius: 8px; font-size: 0.95rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <p style="color: var(--item-color); font-weight: bold; font-size: 1.1rem; margin-bottom: 15px;"><i class="fas fa-book-open"></i> 沉浸式體驗更新</p>
                <ul style="padding-left: 20px; list-style-type: square; color: #ccc;">
                    <li><b>劇本升級</b>：大幅擴充了所有場景的細節描述，帶給您如同閱讀恐怖小說般的體驗。</li>
                    <li><b>介面優化</b>：擴大了閱讀區域，並增加了訊息視窗的顯示行數。</li>
                    <li><b>系統修正</b>：已修復回合卡頓與終局判定的所有已知問題。</li>
                    <li><b>求生指南</b>：善用燃料，保持理智，這是你在輪迴中唯一的籌碼。</li>
                </ul>
            </div>
            <button class="start-btn" onclick="game.start()"><i class="fas fa-skull"></i> 進入洋館</button>
        </div>

        <header>
            <div><i class="fas fa-user-secret"></i> 調查員：亞瑟 <span id="phobia-display" class="phobia-tag"></span></div>
            <div class="turn-indicator"><i class="fas fa-hourglass-half"></i> 回合: <span id="turn-display">1</span>/25</div>
        </header>

        <section id="status-bar">
            <div class="stat-box"><i class="fas fa-heart hp-val"></i><span class="stat-label">生命</span><span class="stat-value hp-val" id="hp-val">100</span></div>
            <div class="stat-box"><i class="fas fa-brain san-val"></i><span class="stat-label">理智</span><span class="stat-value san-val" id="san-val">80</span></div>
            <div class="stat-box"><i class="fas fa-fist-raised courage-val"></i><span class="stat-label">勇氣</span><span class="stat-value courage-val" id="courage-val">50</span></div>
            <div class="stat-box"><i class="fas fa-eye ins-val"></i><span class="stat-label">洞察</span><span class="stat-value ins-val" id="insight-val">10</span></div>
            <div class="stat-box"><i class="fas fa-fire fuel-val"></i><span class="stat-label">燃料</span><span class="stat-value fuel-val" id="fuel-val">25</span></div>
        </section>

        <section id="inventory-bar">
            <span style="color:#666; font-size:0.8rem; margin-right: 10px;"><i class="fas fa-box-open"></i> 背包:</span>
            <div id="inventory-list" style="display:flex; gap:10px;"></div>
        </section>

        <section id="story-area">
            <div id="story-content" class="story-text"></div>
        </section>

        <section id="choice-area"></section>

        <section id="log-window">
            <div id="log-content"></div>
        </section>

        <div id="end-screen" style="display: none;">
            <h1 id="end-title">結局</h1>
            <div id="end-icon" style="font-size: 5rem; margin: 30px 0; color: #555;"></div>
            <p id="end-desc" style="max-width: 600px; margin: 10px 0; line-height: 1.8; font-size: 1.1rem; color: #ccc;"></p>
            <div id="end-stats" style="color: #888; font-size: 1rem; margin-bottom: 20px; font-family: monospace;"></div>
            
            <div style="display:flex; gap:10px;">
                <button class="start-btn" style="padding:10px 20px; font-size:1rem; margin-top:0;" onclick="game.copyHistory()"><i class="fas fa-copy"></i> 複製歷程</button>
                <button class="start-btn reset-btn" style="padding:10px 20px; font-size:1rem; margin-top:0;" onclick="game.reset()"><i class="fas fa-redo"></i> 再次挑戰</button>
            </div>
        </div>
    </div>

    <script>
        const PHOBIAS = [
            { id: 'dark', name: '幽閉恐懼', desc: '黑暗場景 SAN 懲罰加倍', icon: 'fa-dungeon' },
            { id: 'blood', name: '恐血症', desc: '血腥場景 SAN 懲罰加倍', icon: 'fa-tint' },
            { id: 'noise', name: '聲響恐懼', desc: '噪音場景 SAN 懲罰加倍', icon: 'fa-volume-up' }
        ];

        const ITEMS = {
            key: { name: "鏽蝕鑰匙", icon: "fa-key", desc: "開啟地下室某扇門的關鍵。" },
            crowbar: { name: "撬棍", icon: "fa-hammer", desc: "物理學聖劍，勇氣檢定 +10%。" },
            amulet: { name: "舊印護符", icon: "fa-shield-alt", desc: "抵擋致命攻擊，儀式關鍵。" },
            lighter: { name: "黃銅打火機", icon: "fa-fire", desc: "提供光源，減少黑暗恐懼。" },
            journal: { name: "導師筆記", icon: "fa-book", desc: "記載儀式殘頁，洞察檢定 +10%。" },
            gun: { name: "左輪手槍", icon: "fa-crosshairs", desc: "只有一發子彈，暴力結局關鍵。" },
            medkit: { name: "急救包", icon: "fa-briefcase-medical", desc: "恢復少量生命值。" },
            mirror_shard: { name: "鏡之碎片", icon: "fa-gem", desc: "可以看到真實。" }
        };

        const FORCED_EVENTS = [
            { msg: "【突發】牆壁裡傳來老鼠的抓撓聲...", effect: { san: -5 } },
            { msg: "【突發】一陣冷風吹熄了你的熱情。", effect: { courage: -5 } },
            { msg: "【突發】在地板縫隙發現了一枚古老硬幣。", effect: { insight: 5 } },
            { msg: "【突發】天花板滴下腐蝕性黏液。", effect: { san: -3, hp: -2 } },
            { msg: "【突發】靈光一閃，想起導師的教誨。", effect: { insight: 10, san: 2 } },
            { msg: "【突發】發現一個舊油罐，裡面還有剩油！", effect: { fuel: 5 } },
            { msg: "【突發】視線模糊了一秒，看到幻覺。", effect: { san: -8 } },
            { msg: "【突發】吃下角落發霉的三明治。", effect: { hp: 5, san: -2 } }
        ];

        /* --- 模組化場景資料庫 (Immersive Text) --- */
        const MODULES = {
            A: [
                { text: "隨著一聲令人牙酸的金屬轟鳴，厚重的鐵門在你身後重重關上，彷彿巨獸的咽喉吞噬了最後一絲光亮。空氣中瀰漫著陳腐的霉味和一股揮之不去的海水鹹腥，令人窒息。門廳中央孤零零地立著一張積滿灰塵的桃花心木桌子，四周死一般的寂靜，只有你急促的呼吸聲在迴盪...", type: "dark", choices: [
                    { text: "搜索桌子", desc: "這張桌子看起來有些年代了。你決定仔細檢查它的抽屜和縫隙，希望能找到任何可用的物資。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'lighter', msg: "幸運女神眷顧！你在抽屜的夾層裡摸到了一個冰冷金屬物——是一個還能用的黃銅打火機。" }, fail: { hp: -5, msg: "当你伸手進去時，指尖傳來一陣劇痛！抽屜裡藏著一隻巨大的黑寡婦蜘蛛，它在你的手指上狠狠咬了一口。" } },
                    { text: "檢查地面", desc: "地板上的灰塵有些不對勁。你蹲下身，仔細觀察那些奇怪的、蜿蜒的泥土痕跡。", icon: "fa-eye", effect: { insight: 5 }, msg: "你發現這些痕跡並非人類留下的...更像是某種沈重的、濕漉漉的軟體生物被強行拖向了深處。" },
                    { text: "破壞大門", desc: "恐懼讓你本能地想要逃離。你試圖用蠻力撞開那扇已經鎖死的大門，不顧一切地想要出去。", icon: "fa-door-closed", effect: { hp: -10, san: -10 }, msg: "大門紋絲不動，就像是用生鐵澆鑄的一樣。你的肩膀撞得瘀青，絕望感油然而生——你被困住了。", reckless: true }
                ]},
                { text: "你推開雙開門，來到了宴會廳。長桌上擺滿了早已腐爛發黑的食物，但在燭光搖曳下，你驚恐地發現某些肉塊似乎還在輕微跳動。正對面的牆上掛著一幅巨大的家族肖像畫，畫中所有人的眼睛都被粗暴地挖空了，只剩下黑洞洞的眼窩，彷彿在無聲地注視著你。", type: "blood", choices: [
                    { text: "觀察肖像", desc: "強忍著不適與恐懼，你決定靠近那幅詭異的畫像，尋找可能隱藏在畫框後的線索。", icon: "fa-image", effect: { insight: 10, san: -5 }, msg: "當你靠近時，畫中人的眼窩竟流出了新鮮的血淚！你在畫框後發現了一張泛黃的紙條，上面寫著潦草的警告。" },
                    { text: "搜餐具櫃", desc: "無視畫像投來的惡意視線，你快速搜索旁邊的銀質餐具櫃，希望能找到武器或工具。", icon: "fa-box", type: "check", checkType: "insight", chance: 70, success: { item: 'key', msg: "你在發黑的銀器堆中發現了一把沈甸甸的鏽蝕鑰匙，它看起來能打開某扇重要的門。" }, fail: { hp: -5, san: -5, msg: "櫃子突然向你倒塌，發出巨大的轟鳴聲！你閃避不及，腿部被重重壓傷。" }, tag: "noise" },
                    { text: "快速通過", desc: "這裡的氣氛太過邪惡，每一秒都讓你感到窒息。你決定不在此逗留，低著頭儘快穿過房間。", icon: "fa-running", effect: { courage: -2 }, msg: "你一口氣衝過了宴會廳，雖然安全了，但你錯過了探索的機會，內心感到一絲因逃避而產生的懦弱。" }
                ]},
                { text: "走廊深處傳來一陣陣細碎而密集的低語聲，像是有人在牆壁夾層裡用指甲瘋狂刮擦木板。你的左手邊有一個半掩的雜物間，門縫裡透出一股令人作嘔的腐臭味，蒼蠅在周圍嗡嗡作響。", type: "noise", choices: [
                    { text: "搜雜物間", desc: "雖然味道難聞，但雜物間通常藏有工具。你決定捏著鼻子進去看看。", icon: "fa-search", type: "check", checkType: "insight", chance: 80, success: { item: 'crowbar', msg: "這是求生的利器！你在雜物堆中找到了一把堅固的撬棍，握在手裡讓你感到安心。" }, fail: { san: -5, msg: "裡面堆滿了死老鼠，它們的身體扭曲，眼睛都死死盯著門口。你感到一陣強烈的噁心。" } },
                    { text: "貼耳偷聽", desc: "好奇心戰勝了恐懼。你將耳朵貼在牆上，試圖聽清那些牆內低語的內容。", icon: "fa-ear-listen", effect: { insight: 15, san: -15 }, msg: "你聽懂了幾個音節...那絕對不屬於人類的語言結構。你的大腦開始顫抖，獲得了某種禁忌的知識。" },
                    { text: "原地休息", desc: "連續的恐懼讓你精疲力盡。你決定在角落稍作休息，平復劇烈的心跳。", icon: "fa-praying-hands", effect: { san: 5 }, msg: "你閉目養神，強迫自己不去聽那些聲音。片刻的寧靜讓你的理智稍微回復了一些。" }
                ]},
                { text: "你推開門進入了僕人房。這裡的牆壁上寫滿了乾涸的血書，字跡狂亂：「不要睡覺」、「它在鏡子裡看著你」。房間角落有一面蒙著厚重黑布的落地鏡，顯得格格不入，彷彿裡面關押著什麼。", type: "dark", choices: [
                    { text: "揭開鏡子", desc: "不知為何，你感到一股強烈的衝動想要揭開黑布，看看鏡子裡到底藏著什麼秘密。", icon: "fa-eye", type: "check", checkType: "courage", chance: 70, success: { insight: 15, item: "mirror_shard", msg: "你猛地揭開黑布！鏡子瞬間自行碎裂。你撿起一片碎片，發現它能映照出肉眼看不見的真實。" }, fail: { san: -20, msg: "你看到了...鏡子裡的你正在極速腐爛，皮膚一塊塊剝落，露出白骨。你尖叫著後退。" } },
                    { text: "閱讀日記", desc: "桌上有一本沾滿灰塵的日記本，你決定閱讀它來了解這棟屋子過去發生的慘劇。", icon: "fa-book-open", type: "check", checkType: "insight", chance: 80, success: { insight: 10, msg: "透過日記，你了解到宅邸主人試圖召喚古神來復活女兒，但儀式失控了。" }, fail: { san: -5, msg: "日記裡的文字開始像蟲子一樣在紙上扭動、攀爬，讓你頭痛欲裂，無法閱讀。" } },
                    { text: "燒掉房間", desc: "這裡充滿了不潔的氣息，讓你感到污穢。你決定用火淨化這一切。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "火焰吞噬了血書和那面詭異的鏡子。看著跳動的火光，你感到一種毀滅的快感，但也消耗了寶貴的燃料。" }
                ]},
                { text: "這是通往宅邸深處的轉折點。前方是一片伸手不見五指的黑暗過渡區域，寒氣逼人，彷彿連接著另一個世界。沒有任何光線能穿透這片黑暗，你只能聽到自己心跳的回音。", type: "dark", choices: [
                    { text: "點亮光源", desc: "絕不能在這種地方摸黑。你決定消耗燃料點亮周圍，驅散黑暗帶來的未知恐懼。", icon: "fa-lightbulb", req: "fuel", effect: { fuel: -3, san: 5 }, msg: "溫暖的光芒讓你稍微安心。你看清了腳下崎嶇的路，避免了潛在的危險。" },
                    { text: "摸黑前進", desc: "燃料是有限的，必須省著用。你決定依靠觸覺和聽覺在黑暗中摸索前進。", icon: "fa-walking", type: "check", checkType: "courage", chance: 60, success: { courage: 15 }, fail: { hp: -10, san: -10, msg: "你踩空了，滾下了幾階樓梯。在跌落的瞬間，你感覺黑暗中有一雙冰冷的手推了你一把。" } },
                    { text: "投石探路", desc: "撿起一塊石頭扔向前方，通過回音來判斷前方空間的大小和結構。", icon: "fa-cube", effect: { insight: 5 }, msg: "石頭落地很久才傳來微弱的回音，這意味著前方是一個巨大的、深不見底的空洞空間。" }
                ]}
            ],
            B: [
                { text: "【進入上層區域】你身處二樓的圖書室。這裡的景象徹底違背了物理法則——所有的書籍都脫離了書架，靜靜地飄浮在半空中，彷彿時間在這裡停滯了，構成了一座由文字組成的迷宮。", type: "dark", choices: [
                    { text: "抓取筆記", desc: "你眼尖地發現導師的筆記也在飄浮的書堆中，你試圖跳起來抓住它。", icon: "fa-book", type: "check", checkType: "insight", chance: 75, success: { item: 'journal', msg: "你成功抓住了導師的筆記！裡面記載了關鍵的儀式資訊，這可能是你活下去的希望。" }, fail: { san: -10, msg: "當你的手指觸碰書本時，它們突然變成了一張張尖叫的人臉，狠狠咬傷了你的手。" } },
                    { text: "擊落書本", desc: "這些飄浮的書讓你感到強烈的不安，你決定用撬棍把它們通通打下來。", icon: "fa-hammer", req: "crowbar", effect: { courage: 5, san: -5 }, msg: "你暴力地擊落了周圍的書本。書頁紛飛，這種破壞感讓你稍微找回了控制權，但也打破了死寂。" },
                    { text: "躲藏", desc: "這種超自然現象意味著極度的危險。你決定先躲在桌子底下觀察情況。", icon: "fa-shield-alt", effect: { san: 5 }, msg: "你蜷縮在桌下，屏住呼吸。書本繼續在頭頂飄浮，沒有發生其他異狀，你暫時安全了。" }
                ]},
                { text: "書架後方傳來沉重的、拖沓的腳步聲。透過縫隙，你看到一個無頭的影子正在巡邏，手裡拖著一把巨大的、沾滿乾涸血跡的斧頭。它似乎在尋找入侵者。", type: "noise", choices: [
                    { text: "屏息不動", desc: "依靠書架的掩護，屏住呼吸，祈禱它不會發現你。", icon: "fa-stop", type: "check", checkType: "courage", chance: 60, success: { san: 5, msg: "影子在你面前停留了片刻，斧頭擦過地面發出刺耳聲響，然後它轉身離開了。你鬆了一口氣。" }, fail: { san: -15, msg: "恐懼讓你忍不住發出了一聲響動。影子瞬間穿過了書架和你的身體，帶走了你的體溫與一部分理智。" } },
                    { text: "扔物引開", desc: "犧牲身上的物品，扔向遠處製造聲響來引開它的注意。", icon: "fa-share", effect: { insight: 5, itemLost: 'lighter' }, msg: "你扔出了打火機。清脆的撞擊聲成功吸引了影子的注意，你趁機逃脫，但永遠失去了光源。" },
                    { text: "正面戰鬥", desc: "恐懼轉化為憤怒，你決定衝出去與這個怪物決一死戰！", icon: "fa-fist-raised", effect: { hp: -20, courage: 20 }, msg: "你瘋狂地揮舞拳頭穿過影子的身體。它消散了，但接觸的瞬間你感覺靈魂被撕裂，受了重傷。", reckless: true }
                ]},
                { text: "走廊盡頭有一間臨時搭建的牢房。你震驚地發現導師被粗大的鐵鍊鎖在裡面，他全身是傷，看起來神智不清，嘴裡不斷唸叨著：「眼睛...都在看著...都在看著我們...」", type: "blood", choices: [
                    { text: "喚醒導師", desc: "試圖呼喚導師的名字，讓他恢復理智，希望能獲取有用的情報。", icon: "fa-user-md", type: "check", checkType: "insight", chance: 70, success: { insight: 20, msg: "導師的眼神恢復了一絲清明，他顫抖著告訴了你古神儀式的弱點和封印方法。", flag: "mentor_hint" }, fail: { san: -10, msg: "導師猛地抬起頭，對著你發出非人的尖叫，那聲音讓你毛骨悚然，直透靈魂。" } },
                    { text: "破壞鎖鏈", desc: "不管那麼多了，先用撬棍把鎖鏈砸開救人要緊！", icon: "fa-hammer", req: "crowbar", type: "check", checkType: "courage", chance: 80, success: { courage: 10, msg: "隨著一聲金屬斷裂的脆響，鎖鏈斷裂！你成功救出了導師，他雖然虛弱，但能跟隨你行動。", flag: "mentor_saved" }, fail: { hp: -10, msg: "鐵鍊異常堅固，反彈的力道擊中了你的頭部，你眼冒金星，差點暈過去。" } },
                    { text: "留槍給他", desc: "你看著他痛苦的樣子，決定把手槍留給他，讓他自己選擇結局。", icon: "fa-gun", req: "gun", effect: { san: -20, itemLost: 'gun' }, msg: "你把槍放在他顫抖的手裡，轉身離開。身後傳來一聲槍響，牢房安靜了。你永遠失去了導師和武器。", reckless: true }
                ]},
                { text: "你誤入了一間充滿古怪標本的實驗室。架子上擺滿了福爾馬林浸泡的玻璃罐，裡面裝著各種畸形的生物器官。你感覺有些眼球似乎跟隨著你的移動而轉動。", type: "dark", choices: [
                    { text: "檢查標本", desc: "忍著噁心觀察這些標本，試圖找出它們的來源和弱點。", icon: "fa-flask", type: "check", checkType: "insight", chance: 60, success: { insight: 10 }, fail: { san: -10, msg: "當你湊近觀察時，一個標本突然睜開眼並猛烈撞擊玻璃！你嚇得跌坐在地，心臟狂跳。" } },
                    { text: "尋找藥品", desc: "實驗室通常會有急救用品，你決定四處翻找看看。", icon: "fa-briefcase-medical", type: "check", checkType: "insight", chance: 70, success: { item: 'medkit', msg: "在一個落滿灰塵的櫃子裡，你找到了一個未開封的急救包，這可是救命稻草。" }, fail: { hp: -5, msg: "你不小心打碎了一個裝滿酸液的瓶子，飛濺的液體灼傷了你的皮膚，發出滋滋聲。" } },
                    { text: "立刻離開", desc: "這裡的氣味讓你頭暈，直覺告訴你這裡很危險，不想多待一秒。", icon: "fa-door-open", effect: { hp: 0 }, msg: "你迅速退出了房間，關上了門，將那些窺視的視線隔絕在內。" }
                ]},
                { text: "通往閣樓的狹窄樓梯口傳來斷斷續續的哭聲，聽起來像是一個小女孩在無助地啜泣，聲音淒涼而哀怨。", type: "noise", choices: [
                    { text: "上樓查看", desc: "雖然害怕，但你的良知讓你不能放任一個孩子在那裡哭泣。", icon: "fa-arrow-up", type: "check", checkType: "courage", chance: 50, success: { san: 5, insight: 10, msg: "你上樓發現這只是一個老舊的錄音機在循環播放。雖然詭異，但至少不是鬼魂，你鬆了口氣。" }, fail: { san: -15, msg: "你爬上閣樓，看見了一具穿著洋裝的上吊屍體，正在隨風擺盪...那哭聲是從屍體腹部發出的。" } },
                    { text: "封死門口", desc: "這絕對是陷阱。你決定用撬棍將閣樓的門徹底卡死。", icon: "fa-hammer", req: "crowbar", effect: { courage: 5 }, msg: "你封鎖了樓梯口。眼不見為淨，那令人心煩的哭聲似乎也變小了。" },
                    { text: "大喊回應", desc: "你對著樓梯口大喊：「誰在那裡？出來！」試圖威嚇對方。", icon: "fa-bullhorn", effect: { san: -10 }, msg: "哭聲戛然而止，取而代之的是一陣淒厲的、多重聲線的狂笑，迴盪在整個樓道。", reckless: true }
                ]}
            ],
            C: [
                { text: "【進入水淹區域】你聞到了一股令人作嘔的腐臭味，彷彿死魚和爛泥混合在一起。你進入了廚房，這裡的巨大鍋爐還在沸騰，裡面煮著某種不可名狀的肉湯，冒著綠色的泡泡。", type: "blood", choices: [
                    { text: "搜香料罐", desc: "架子上有一排奇怪的密封罐子，或許裡面藏著什麼東西。", icon: "fa-box-open", type: "check", checkType: "insight", chance: 75, success: { item: 'amulet', msg: "你在一個貼著符咒的罐子裡找到了舊印護符！這是對抗邪惡的關鍵道具。" }, fail: { hp: -5, msg: "罐子裡藏著一隻劇毒的蠍子，你的手被狠狠螫了一下，手臂瞬間麻痺。" } },
                    { text: "打翻鍋爐", desc: "這鍋湯散發著邪惡的氣息，你決定把它毀了，絕不能讓它完成。", icon: "fa-dumpster-fire", effect: { courage: 5, san: -10 }, msg: "你用力推倒了鍋爐。湯汁流得滿地都是，裡面全是煮熟的眼球。場面極度噁心，但你毀掉了這邪惡的儀式湯。" },
                    { text: "悄悄離開", desc: "不想驚動可能存在的廚師，你決定踮著腳尖悄悄離開。", icon: "fa-walking", effect: { fuel: -1 }, msg: "你屏住呼吸離開了廚房，雖然消耗了點時間和燃料，但至少安全無虞。" }
                ]},
                { text: "地下走廊被汙水淹沒了。黑色的水深及腰，水面上漂浮著傢俱殘骸...以及一具穿著制服的保全屍體，面部朝下漂浮著。", type: "water", choices: [
                    { text: "涉水而過", desc: "沒有別的路了。忍受著冰冷和汙穢，一步步涉水通過。", icon: "fa-water", type: "check", checkType: "courage", chance: 70, success: { courage: 5 }, fail: { hp: -10, msg: "水下隱藏的尖銳金屬劃破了你的腿，傷口在汙水中刺痛，你擔心會感染。" } },
                    { text: "搜查屍體", desc: "這具屍體上或許有武器。你強忍著強烈的嘔吐感靠近它。", icon: "fa-search", effect: { san: -5, item: "gun" }, msg: "你將屍體翻過來（他的臉已經被啃食了一半），幸運地在他的槍套裡找到了一把左輪手槍！" },
                    { text: "爬管線", desc: "嘗試攀爬頭頂的生鏽管線，避免接觸下面噁心的汙水。", icon: "fa-grip-lines", type: "check", checkType: "courage", chance: 60, success: { hp: 0 }, fail: { hp: -15, msg: "管線承受不住重量斷裂了，你重重摔進水裡，嗆了一大口腥臭的屍水，幾乎窒息。" } }
                ]},
                { text: "你進入了幫浦室。巨大的活塞發出震耳欲聾的轟鳴聲，彷彿巨獸的心跳。這裡似乎控制著整個地下區域的水流，但也充滿了危險的機械運轉聲。", type: "noise", choices: [
                    { text: "破壞面板", desc: "直接用撬棍砸爛控制面板，強制讓機器停止運轉。", icon: "fa-hammer", req: "crowbar", effect: { courage: 10, san: 5 }, msg: "隨著火花四濺，機械停止了運轉。噪音消失了，世界終於清靜了，你的耳鳴也逐漸消退。" },
                    { text: "研究手冊", desc: "桌上有一本沾滿油汙的操作手冊，試著閱讀它來理解機械原理。", icon: "fa-book-reader", type: "check", checkType: "insight", chance: 80, success: { insight: 15, msg: "你成功理解了複雜的操作流程，學會了如何排空下一個房間的水位。" }, fail: { san: -5, msg: "手冊上的文字變成了密密麻麻的爬蟲，你看得頭皮發麻，完全無法理解。" } },
                    { text: "躲避休息", desc: "在巨大的噪音掩護下，怪物可能聽不到你。你決定稍作休息。", icon: "fa-bed", effect: { hp: 10, fuel: -2 }, msg: "你縮在角落休息了一會兒，體力得到恢復，但浪費了寶貴的燃料。" }
                ]},
                { text: "前方是一條完全被水淹沒的隧道。除非你在幫浦室成功排空了水，否則這將是一場賭命的潛水。", type: "water", choices: [
                    { text: "閉氣潛游", desc: "深吸一口氣，潛入黑水中，祈禱能在氧氣耗盡前游到對岸。", icon: "fa-swimmer", type: "check", checkType: "courage", chance: 70, success: { courage: 15 }, fail: { hp: -20, san: -10, msg: "你在水中迷失了方向，差點溺死。更糟的是，水中的某個東西抓了一下你的腳踝。" } },
                    { text: "鏡子觀察", desc: "將鏡之碎片伸入水中，觀察水下的情況。", icon: "fa-search", req: "mirror_shard", effect: { insight: 10 }, msg: "通過鏡子，你看清了水下的陷阱和障礙，成功規劃出一條安全路線。" },
                    { text: "喝怪藥水", desc: "喝下之前在實驗室找到的發光藥水，希望能獲得能在水下呼吸的能力。", icon: "fa-flask", effect: { hp: 20, san: -20 }, msg: "你喝下了藥水。身體充滿了狂暴的力量，甚至感覺不到缺氧，但你的腦袋變得混亂不堪，產生了幻覺。" }
                ]},
                { text: "你來到了一個巨大的地下蓄水池。水面平靜得可怕，但在深處，一個巨大的黑影正在緩慢游動，攪動著水流。", type: "dark", choices: [
                    { text: "快速游過", desc: "趁著怪物還沒浮上來，拼盡全力游向對岸。", icon: "fa-swimmer", type: "check", checkType: "courage", chance: 70, success: { courage: 20 }, fail: { hp: -30, msg: "水花濺起，一張血盆大口咬住了你的腿！你拼死掙脫，被咬掉了一塊肉，鮮血染紅了水面。" } },
                    { text: "投肉引怪", desc: "割下自己的一塊皮膚扔進水裡...這很瘋狂，但血腥味或許能引開它。", icon: "fa-drumstick-bite", effect: { san: -5, insight: 5 }, msg: "你忍痛割肉投餵。怪物追逐血肉而去，你趁機通過。這自殘的行為讓你離瘋狂更近了一步。" },
                    { text: "射擊水面", desc: "用槍射擊水面，製造聲響和衝擊波嚇退怪物。", icon: "fa-gun", req: "gun", effect: { itemLost: "gun", courage: 10 }, msg: "槍聲在地下迴盪。怪物被激怒了，翻滾著沉入水底。你趁亂逃脫，但不慎將槍掉進了深水裡。" }
                ]}
            ],
            D: [
                { text: "【進入異界區域】這裡不再是洋館。牆壁變成了脈動的血肉，每一次呼吸都噴出溫熱的腥氣。地面是黏稠的組織，你彷彿行走在某種巨獸的腸道中。", type: "blood", choices: [
                    { text: "火燒開路", desc: "用打火機點燃這些噁心的肉壁，燒出一條路來。", icon: "fa-fire", req: "lighter", effect: { fuel: -5, san: 5 }, msg: "火焰讓血肉劇烈收縮尖叫。你聞到了焦臭味，但路通了。" },
                    { text: "閉眼衝刺", desc: "不看、不想、不聞。閉上眼睛全力向前衝。", icon: "fa-running", type: "check", checkType: "courage", chance: 60, success: { courage: 10, hp: -5 }, fail: { hp: -15, san: -10, msg: "你被地上的觸手絆倒，臉朝下摔進了肉泥裡，甚至吞下了一些不明組織液，噁心至極。" } },
                    { text: "解剖牆壁", desc: "用手術刀或銳器切開牆壁，看看裡面有什麼。", icon: "fa-scalpel", type: "check", checkType: "insight", chance: 50, success: { insight: 20, item: "medkit" }, fail: { san: -20, msg: "你切開了肉壁，發現裡面包裹著的...是你失蹤已久的親人的臉，正對著你哭泣。" } }
                ]},
                { text: "你闖入了一個充滿半透明蛋的巢穴。這些蛋裡蜷縮著人形的胚胎，正隨著心跳律動。如果不小心，就會驚動黑暗中的母體。", type: "dark", choices: [
                    { text: "悄悄通過", desc: "像影子一樣移動，絕對不要觸碰任何一顆蛋。", icon: "fa-shoe-prints", type: "check", checkType: "insight", chance: 75, success: { insight: 10 }, fail: { hp: -15, msg: "你腳底一滑，踩碎了一顆蛋。酸液濺射，母體發出了憤怒的尖嘯！" } },
                    { text: "火燒巢穴", desc: "這些邪惡的東西不能留存。你決定放火燒光一切。", icon: "fa-fire", req: "fuel", effect: { fuel: -10, courage: 20, san: -10 }, msg: "火勢迅速蔓延。無數胚胎在火中發出嬰兒般的慘叫聲，這聲音將伴隨你一生，但威脅解除了。" },
                    { text: "偷走一顆", desc: "這個樣本太珍貴了。你決定偷走一顆蛋帶回去研究。", icon: "fa-egg", effect: { san: -30, insight: 30 }, msg: "你瘋了嗎？你把怪物裝進了背包。你能感覺到它在你的背上跳動，散發著熱量。" }
                ]},
                { text: "你穿過了一扇門，卻發現自己倒立在天花板上。這裡的幾何結構完全錯誤，牆角呈現出不可能的角度，看久了會讓人強烈反胃，空間感喪失。", type: "noise", choices: [
                    { text: "閉眼行走", desc: "既然視覺在欺騙你，那就閉上眼睛憑感覺走。", icon: "fa-blind", type: "check", checkType: "insight", chance: 60, success: { insight: 10, san: 5 }, fail: { hp: -10, msg: "你撞到了看不見的牆角，頭破血流，空間感徹底錯亂。" } },
                    { text: "理解結構", desc: "強迫自己的大腦去理解這種非歐幾里得幾何結構。", icon: "fa-brain", effect: { insight: 30, san: -20 }, msg: "你的大腦彷彿被重構了。你理解了這個空間的邏輯，但你的人類常識正在崩塌。" },
                    { text: "服用藥物", desc: "吞下急救包裡的鎮定劑，強迫自己冷靜下來。", icon: "fa-pills", req: "medkit", effect: { san: 20, hp: 5 }, msg: "藥物讓你神經麻痺，世界看起來稍微「正常」了一點，雖然只是錯覺。" }
                ]},
                { text: "時間似乎在這裡停滯。你看到前方的走廊上，有一個和你穿著一模一樣的人背對著你站著，一動不動，場景詭異至極。", type: "dark", choices: [
                    { text: "拍他肩膀", desc: "走過去拍拍他的肩膀，看看他是誰。", icon: "fa-hand-point-right", effect: { san: -30 }, msg: "他轉過頭...那是一具腐爛已久的骷髏，穿著你的衣服。那是未來的你。" },
                    { text: "開槍射擊", desc: "不管那是誰，先下手為強。", icon: "fa-gun", req: "gun", effect: { san: -10, itemLost: "gun" }, msg: "你開槍了。如果那是未來的你，那你剛剛自殺了嗎？槍支因時空悖論而卡殼損壞。" },
                    { text: "繞道而行", desc: "直覺告訴你絕對不能靠近他，你選擇繞遠路。", icon: "fa-route", type: "check", checkType: "insight", chance: 75, success: { san: 5 }, fail: { san: -10, msg: "當你經過時，你聽到他在背後用你的聲音淒厲地叫著你的名字。" } }
                ]},
                { text: "你進入了一個由無數鏡子組成的迷宮。每個鏡像裡的你都做著不同的動作，有的在笑，有的在哭，有的在割喉。真實與虛幻已無法分辨。", type: "dark", choices: [
                    { text: "閉眼尋路", desc: "不要看鏡像，憑直覺尋找出口。", icon: "fa-blind", type: "check", checkType: "insight", chance: 60, success: { insight: 10, san: 5 }, fail: { san: -15, msg: "你撞到了鏡子，鏡中的你也撞向了你，頭破血流。" } },
                    { text: "打破鏡子", desc: "用暴力打破這些幻象。", icon: "fa-hammer", req: "crowbar", type: "check", checkType: "courage", chance: 80, success: { courage: 10 }, fail: { hp: -20, msg: "鏡子碎片飛濺，深深刺入了你的身體。" } },
                    { text: "凝視鏡像", desc: "試圖找出哪個才是真實的自己。", icon: "fa-eye", effect: { san: -25 }, msg: "你發現...沒有一個是你。你迷失了自我。" }
                ]}
            ],
            // 終局 (21-25)
            E: [
                { text: "【終局：儀式】你終於重摔在祭壇前。現實與虛幻在這裡重疊。古神的本體即將降臨，空間正在崩塌。如果你救了導師，他現在正倒在血泊中拼命畫著防禦法陣。", type: "blood", choices: [
                    // 修復：100% 成功率
                    { text: "誦讀反咒", desc: "拿出導師的筆記，大聲誦讀上面的反制咒語。", icon: "fa-book", req: "journal", type: "check", checkType: "insight", chance: 100, success: { insight: 30, san: -10, msg: "咒語生效了！空氣開始震動，古神的降臨動作變慢了，儀式已成功啟動。", flag: "ritual_started" }, fail: { san: -20, msg: "（此選項不應失敗）" } },
                    { text: "破壞祭壇", desc: "用撬棍物理破壞這個邪惡的祭壇。", icon: "fa-hammer", req: "crowbar", type: "check", checkType: "courage", chance: 80, success: { courage: 20, hp: -10, msg: "你瘋狂地砸碎了祭壇的一角，能量亂流劃傷了你的臉，但儀式被打斷了。", flag: "altar_damaged" }, fail: { hp: -30, msg: "祭壇的反衝力將你擊飛，你的肋骨斷了幾根，倒地不起。" } },
                    { text: "獻祭自己", desc: "如果需要祭品...那就用我自己。", icon: "fa-skull", effect: { hp: -99, san: 0 }, msg: "你義無反顧地走上了祭壇，匕首刺入心臟，成為了最後的祭品..." }
                ]},
                { text: "祭壇的守護者出現了——一隻由無數人手扭曲組成的怪物。它擋在了核心前，阻止你靠近。", type: "blood", choices: [
                    { text: "射擊核心", desc: "用槍瞄準怪物胸口那顆跳動的肉瘤核心。", icon: "fa-gun", req: "gun", effect: { itemLost: "gun", courage: 20 }, msg: "砰！最後一顆子彈精準命中！怪物發出哀嚎倒下。手槍也因承受不住能量而炸裂。" },
                    { text: "火攻", desc: "潑灑燃料，點燃這個怪物。", icon: "fa-fire", req: "fuel", effect: { fuel: -10, hp: -10 }, msg: "你將最後的燃料潑灑出去並點燃。怪物變成了火球，但你也被高溫燒傷了。" },
                    { text: "靈活閃避", desc: "依靠速度繞過怪物，直取祭壇。", icon: "fa-running", type: "check", checkType: "courage", chance: 70, success: { hp: -5 }, fail: { hp: -40, msg: "你太慢了。你被數十隻手同時抓住，骨頭被捏碎的聲音清晰可聞。" } }
                ]},
                { text: "古神的低語直接鑽入你的腦海，那是超越人類理解的聲音。祂許諾給你無盡的知識與力量，只要你現在放棄抵抗。", type: "noise", choices: [
                    { text: "咬破舌頭", desc: "用劇痛來對抗精神控制，拒絕誘惑。", icon: "fa-user-slash", effect: { hp: -10, san: 10, courage: 20 }, msg: "疼痛讓你瞬間清醒。你吐出一口血水，對著神祇發出嘲笑。" },
                    { text: "傾聽低語", desc: "或許...祂說的是對的？你選擇傾聽。", icon: "fa-question", effect: { san: -30, insight: 20 }, msg: "你看到了宇宙的真理...人類只是塵埃。你的世界觀崩塌了，你快要崩潰了。" },
                    { text: "鏡子反射", desc: "用鏡之碎片反射古神的精神波。", icon: "fa-gem", req: "mirror_shard", effect: { san: 10 }, msg: "你將鏡子對準虛空。古神似乎看到了醜陋的自己，發出厭惡的波動退縮了。" }
                ]},
                { text: "儀式到了最後階段。天空裂開，一隻巨大的、燃燒的眼睛注視著你。你需要做最後的準備。", type: "dark", choices: [
                    { text: "檢查裝備", desc: "確認身上還有什麼能用的東西。", icon: "fa-toolbox", type: "check", checkType: "insight", chance: 90, success: { insight: 10 }, fail: { san: -5, msg: "你發現大部分裝備都壞了，絕望感襲來。" } },
                    { text: "祈禱", desc: "向任何可能聆聽的神祈禱。", icon: "fa-praying-hands", effect: { san: 20, courage: -10 }, msg: "你內心獲得了奇異的平靜，不再恐懼死亡，但鬥志也消退了。" },
                    { text: "注射藥物", desc: "將急救包裡所有的興奮劑和止痛藥全部注射進體內。", icon: "fa-syringe", req: "medkit", effect: { hp: 50, san: -20 }, msg: "你感覺不到疼痛了，心跳快得像機關槍。你現在是個戰鬥機器，也是個徹頭徹尾的瘋子。" }
                ]},
                { text: "這是最後的抉擇。虛空之門即將完全打開，或者被永遠關閉。你的每一個細胞都在尖叫，結局就在眼前。", type: "dark", choices: [
                    { text: "封印 (需儀式)", desc: "如果你已經啟動了反咒，現在是用護符完成封印的時候了。", icon: "fa-shield-alt", req: "amulet", effect: { final: "seal" }, msg: "你高舉護符，義無反顧地衝向那團混沌的光芒中心！" },
                    { text: "同歸於盡", desc: "引爆所有燃料，將這棟房子連同古神一起埋葬。", icon: "fa-bomb", req: "fuel", effect: { final: "boom" }, msg: "你點燃了引信，笑著看著火焰吞噬一切。去死吧，怪物！" },
                    { text: "轉身逃跑", desc: "任務失敗了，活下去才是最重要的。跑！", icon: "fa-running", effect: { final: "escape" }, msg: "你丟下一切，轉身向著出口狂奔，背後傳來世界的崩塌聲..." }
                ]}
            ]
        };

        const game = {
            turn: 1,
            maxTurns: 25,
            stats: { hp: 100, san: 80, courage: 50, insight: 10, fuel: 25 },
            inventory: [],
            flags: [],
            phobia: null,
            isGameOver: false,
            finalChoice: null,
            scenarioTimeline: [], 
            historyLog: [], 

            start: function() {
                this.turn = 1;
                this.stats = { hp: 100, san: 80, courage: 50, insight: 10, fuel: 25 };
                this.inventory = [];
                this.flags = [];
                this.historyLog = [];
                this.isGameOver = false;
                this.phobia = PHOBIAS[Math.floor(Math.random() * PHOBIAS.length)];
                
                const midModules = ['B', 'C', 'D'].sort(() => Math.random() - 0.5);
                this.scenarioTimeline = [
                    ...MODULES.A,
                    ...MODULES[midModules[0]],
                    ...MODULES[midModules[1]],
                    ...MODULES[midModules[2]],
                    ...MODULES.E
                ];
                console.log("Map Order:", midModules);

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('end-screen').style.display = 'none';
                document.getElementById('log-content').innerHTML = '';
                this.updateUI();
                this.log(`進入詭屋。你的弱點是：${this.phobia.name} (${this.phobia.desc})`, "log-info");
                this.loadScenario();
                this.checkAtmosphere();
            },

            reset: function() {
                document.getElementById('start-screen').style.display = 'flex';
                document.getElementById('end-screen').style.display = 'none';
            },

            loadScenario: function() {
                if (this.turn > 25) { 
                    this.triggerEnding(); 
                    return; 
                }

                let data = this.scenarioTimeline[this.turn - 1];
                let text = `[回合 ${this.turn}] ${data.text}`;
                let choices = [...data.choices];

                this.historyLog.push(`回合 ${this.turn}: ${data.text}`);

                if (this.turn < 24 && this.stats.san < 70 && Math.random() < 0.3) {
                    const phantomText = ["打開隱藏的門", "撿起地上的金幣", "與角落的人影對話", "閱讀牆上的文字", "喝下桌上的水"];
                    const randomText = phantomText[Math.floor(Math.random() * phantomText.length)];
                    const randomIcon = ["fa-door-open", "fa-coins", "fa-user", "fa-font", "fa-glass-water"][Math.floor(Math.random() * 5)];
                    const insertIndex = Math.floor(Math.random() * (choices.length + 1));
                    choices.splice(insertIndex, 0, {
                        text: randomText, desc: "這感覺很真實...", icon: randomIcon, isPhantom: true, chance: 80, type: 'check'
                    });
                }

                if (this.stats.san < 30) {
                    text += " <span class='text-distort' style='display:block; margin-top:10px; color:#e74c3c;'>[幻聽] " + this.getMadnessText() + "</span>";
                    if (Math.random() < 0.4) {
                        choices.push({ 
                            text: "聽從低語：挖出眼睛", desc: "只要挖出眼睛就不用看了...", icon: "fa-eye-slash", 
                            effect: { hp: -50, san: -50 }, msg: "你瘋了。世界陷入黑暗。", reckless: true, isMadness: true 
                        });
                    }
                }

                const storyContent = document.getElementById('story-content');
                storyContent.innerHTML = `<i class="fas ${this.getScenarioIcon(this.turn)} story-icon"></i>` + text;
                storyContent.className = 'story-text';
                void storyContent.offsetWidth; 
                storyContent.classList.add(this.stats.san < 60 ? 'hallucination' : 'fade-in');

                const choiceArea = document.getElementById('choice-area');
                choiceArea.innerHTML = '';

                choices.forEach(choice => {
                    if (this.turn === 25 && choice.effect && choice.effect.final === 'seal') {
                        const canSeal = this.hasItem('amulet') && this.flags.includes('ritual_started');
                        if (!canSeal) choice.desc += " <span style='color:#e74c3c'>(條件未滿足：需護符與儀式啟動)</span>";
                        else choice.desc = "<span style='color:#2ecc71; font-weight:bold;'>(條件滿足 - 可封印)</span> " + choice.desc;
                    }

                    if (choice.req && !this.hasItem(choice.req)) return;
                    if (choice.req === 'fuel' && this.stats.fuel <= 0) return;

                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    if (choice.isMadness) btn.classList.add('madness-choice');
                    if (choice.isPhantom) btn.classList.add('phantom-choice');
                    
                    let iconHtml = `<i class="fas ${choice.icon || 'fa-circle'}"></i>`;
                    let chanceHtml = choice.type === 'check' ? `<span class="chance-tag">${this.calculateChance(choice)}%</span>` : '';
                    
                    btn.innerHTML = `<div class="choice-title">${iconHtml} ${choice.text} ${chanceHtml}</div><div class="choice-desc">${choice.desc || ''}</div>`;
                    
                    btn.onclick = (e) => {
                        if (choice.isPhantom) {
                            this.triggerPhantom(e.currentTarget);
                        } else {
                            this.handleInput(choice);
                        }
                    };
                    choiceArea.appendChild(btn);
                });
                document.getElementById('turn-display').innerText = this.turn;
            },

            triggerPhantom: function(btnElement) {
                btnElement.style.transform = "scale(0.95)";
                setTimeout(() => { btnElement.style.opacity = "0"; setTimeout(() => { btnElement.style.display = "none"; }, 200); }, 100);
                document.getElementById('app-container').classList.add('shake');
                setTimeout(() => document.getElementById('app-container').classList.remove('shake'), 200);
                this.log("你伸手去觸碰...但那裡什麼都沒有。是幻覺！", "log-phantom");
                this.stats.san -= 2;
                this.updateUI();
            },

            calculateChance: function(choice) {
                if (choice.isPhantom) return choice.chance;
                let base = choice.chance;
                if (choice.checkType === 'insight' && this.hasItem('journal')) base += 10;
                if (choice.checkType === 'courage' && this.hasItem('crowbar')) base += 10;
                return Math.min(100, base);
            },

            handleInput: async function(choice) {
                if (this.isGameOver) return;
                document.getElementById('app-container').classList.add('shake');
                setTimeout(() => document.getElementById('app-container').classList.remove('shake'), 500);

                this.historyLog.push(`選擇: ${choice.text}`);

                if (choice.effect && choice.effect.final) this.finalChoice = choice.effect.final;

                if (choice.type === 'check') {
                    const result = await this.rollDice(this.calculateChance(choice));
                    if (result) this.applyEffect(choice.success);
                    else this.applyEffect(choice.fail);
                } else {
                    this.applyEffect(choice.effect || choice);
                    if (choice.msg) this.log(choice.msg, "log-info");
                }

                if (choice.reckless) { this.stats.san -= 30; this.log("【魯莽行為】SAN -30", "log-negative"); }
                
                const currentData = this.scenarioTimeline[this.turn - 1];
                if (currentData && currentData.type === this.phobia.id && this.stats.san < 60) {
                    this.stats.san -= 10;
                    this.log(`【恐懼症】${this.phobia.name}發作！ SAN -10`, "log-negative");
                }
                this.postTurnProcess();
            },

            applyEffect: function(effect) {
                if (!effect) return;
                if (effect.hp) this.stats.hp += effect.hp;
                if (effect.san) this.stats.san += effect.san;
                if (effect.courage) this.stats.courage += effect.courage;
                if (effect.insight) this.stats.insight += effect.insight;
                if (effect.fuel) this.stats.fuel += effect.fuel;
                if (effect.item) { this.addItem(effect.item); document.getElementById('inventory-bar').classList.add('item-get-anim'); setTimeout(()=>document.getElementById('inventory-bar').classList.remove('item-get-anim'), 1000); }
                if (effect.itemLost) this.removeItem(effect.itemLost);
                if (effect.flag) {
                    this.flags.push(effect.flag);
                    console.log("Flag added:", effect.flag);
                }
                if (effect.msg) this.log(effect.msg, (effect.hp < 0 || effect.san < 0) ? "log-negative" : "log-positive");
                this.logStatsChange(effect);
            },

            postTurnProcess: function() {
                this.stats.hp = Math.min(100, Math.max(0, this.stats.hp));
                this.stats.san = Math.min(100, Math.max(0, this.stats.san));
                this.stats.fuel = Math.min(50, Math.max(0, this.stats.fuel));
                if (this.hasItem('lighter')) { this.stats.fuel -= 1; if (this.stats.fuel <= 0) this.log("打火機燃料耗盡！", "log-negative"); }
                this.updateUI();
                this.checkAtmosphere();

                if (this.stats.hp <= 0) { this.endGame("死亡結局", "fa-skull-crossbones", "你的肉體無法承受這些傷害。你倒下了，成為了這棟屋子新的養分。"); return; }
                if (this.stats.san <= 0) { this.endGame("瘋狂結局", "fa-dizzy", "你的理智徹底崩潰。你挖出了自己的雙眼，因為這樣就不用再看到那些恐懼了。"); return; }

                if (Math.random() < 0.20 && this.turn < 24) {
                    const evt = FORCED_EVENTS[Math.floor(Math.random() * FORCED_EVENTS.length)];
                    if (!evt.condition || evt.condition(this)) {
                        this.log(evt.msg, "log-event"); this.applyEffect(evt.effect);
                    }
                }
                this.turn++;
                setTimeout(() => this.loadScenario(), 500);
            },

            rollDice: function(chance) {
                return new Promise(resolve => {
                    const overlay = document.getElementById('dice-overlay');
                    const diceVisual = document.getElementById('dice-visual');
                    const diceMsg = document.getElementById('dice-msg');
                    const diceDetail = document.getElementById('dice-detail');
                    overlay.style.display = 'flex';
                    diceVisual.className = 'dice-rolling';
                    diceVisual.innerText = '';
                    diceMsg.innerText = "命運檢定中...";
                    diceMsg.style.color = "#ddd";
                    diceDetail.innerText = `目標成功率: ${chance}%`;
                    setTimeout(() => {
                        const roll = Math.floor(Math.random() * 100) + 1;
                        const isSuccess = roll <= chance;
                        diceVisual.className = ''; diceVisual.innerText = roll;
                        if (isSuccess) { diceVisual.classList.add('dice-success'); diceMsg.innerText = "檢定成功！"; diceMsg.style.color = "#2ecc71"; } 
                        else { diceVisual.classList.add('dice-fail'); diceMsg.innerText = "檢定失敗..."; diceMsg.style.color = "#e74c3c"; }
                        setTimeout(() => { overlay.style.display = 'none'; diceVisual.classList.remove('dice-success', 'dice-fail'); resolve(isSuccess); }, 600);
                    }, 600);
                });
            },

            triggerEnding: function() {
                let title, desc, icon;
                const { hasAmulet, mentorSaved, ritualStarted } = { hasAmulet: this.hasItem('amulet'), mentorSaved: this.flags.includes('mentor_saved'), ritualStarted: this.flags.includes('ritual_started') };
                
                console.log("Ending Check:", { finalChoice: this.finalChoice, hasAmulet, ritualStarted });

                if (this.finalChoice === 'seal') {
                    if (hasAmulet && ritualStarted) {
                        title = "真結局：永恆封印"; desc = "在導師的協助與護符的力量下，你成功封印了古神。這棟屋子坍塌了，掩埋了一切秘密。你是英雄，雖然沒人知道。你帶著傷痕累累的身體和靈魂，回到了陽光下。"; icon = "fa-star";
                    } else {
                        title = "壞結局：儀式失敗"; desc = "你高舉護符，但反咒沒有完成（或未啟動）。古神的力量輕易粉碎了屏障。你是第一個見證者，也是第一個祭品。"; icon = "fa-eye";
                    }
                }
                else if (this.finalChoice === 'boom') { title = "爆炸結局：毀滅與重生"; desc = "你引爆了燃料。火光吞噬了一切，包括你和古神。雖然你沒能逃出來，但至少那些怪物也陪葬了。你的犧牲是有價值的，這座山谷終於恢復了平靜。"; icon = "fa-bomb"; }
                else if (this.finalChoice === 'escape' && mentorSaved) { title = "好結局：師徒倖存"; desc = "你帶著受傷的導師逃出了洋館。雖然古神依然在沉睡，隨時可能甦醒，但你們活了下來，並將這段經歷寫成了警告世人的書籍，成為了神秘學界的傳奇。"; icon = "fa-user-friends"; }
                else if (this.finalChoice === 'escape') { title = "普通結局：孤獨的倖存者"; desc = "你獨自逃了出來。雖然身體完好，但那段記憶將永遠折磨你。你經常在半夜驚醒，聽見那些低語。你花費餘生在療養院中度過，試圖忘記那雙眼睛。"; icon = "fa-running"; }
                else { title = "壞結局：吞噬"; desc = "你什麼都沒做，或者做錯了選擇。黑暗吞噬了你。"; icon = "fa-skull"; }
                this.endGame(title, icon, desc);
            },

            addItem: function(itemId) { if (!this.inventory.includes(itemId)) { this.inventory.push(itemId); this.log(`獲得: ${ITEMS[itemId].name}`, "log-item"); } },
            hasItem: function(id) { return this.inventory.includes(id); },
            removeItem: function(id) { this.inventory = this.inventory.filter(i => i !== id); this.log(`失去: ${ITEMS[id].name}`, "log-negative"); },
            
            updateUI: function() {
                document.getElementById('hp-val').innerText = this.stats.hp;
                document.getElementById('san-val').innerText = this.stats.san;
                document.getElementById('courage-val').innerText = this.stats.courage;
                document.getElementById('insight-val').innerText = this.stats.insight;
                document.getElementById('fuel-val').innerText = this.stats.fuel;
                document.getElementById('phobia-display').innerText = `(${this.phobia.name})`;
                const invList = document.getElementById('inventory-list');
                invList.innerHTML = this.inventory.map(id => `<div class="inv-item"><i class="fas ${ITEMS[id].icon}"></i> ${ITEMS[id].name}</div>`).join('');
            },

            checkAtmosphere: function() {
                const vignette = document.getElementById('vignette');
                const storyContent = document.getElementById('story-content');
                vignette.className = '';
                if (this.stats.hp < 30) vignette.classList.add('pulse-fast'); else if (this.stats.hp < 60) vignette.classList.add('pulse-slow');
                if (this.stats.san < 60) storyContent.classList.add('text-distort'); else storyContent.classList.remove('text-distort');
                if (this.stats.san < 30) storyContent.classList.add('hallucination'); else storyContent.classList.remove('hallucination');
            },

            log: function(msg, cls) { 
                const win = document.getElementById('log-content'); 
                const entry = document.createElement('div');
                entry.className = `log-entry ${cls} log-new`;
                entry.innerHTML = `> ${msg}`;
                win.prepend(entry);
                if (win.children.length > 20) win.lastElementChild.remove();
            },
            logStatsChange: function(effect) { let parts = []; if (effect.hp) parts.push(`HP${effect.hp}`); if (effect.san) parts.push(`SAN${effect.san}`); if (parts.length) this.log(`[${parts.join(' ')}]`, effect.hp<0||effect.san<0?"log-negative":"log-positive"); },
            getScenarioIcon: function(turn) { if(turn<=5)return"fa-door-open"; if(turn<=20)return"fa-dungeon"; return"fa-star-of-life"; },
            getMadnessText: function() { const t=["殺了他們...","只有死是真實...","眼睛...","蟲...","回頭..."]; return t[Math.floor(Math.random()*t.length)]; },

            endGame: function(title, iconClass, desc) {
                this.isGameOver = true;
                const screen = document.getElementById('end-screen');
                document.getElementById('end-title').innerText = title;
                document.getElementById('end-desc').innerText = desc;
                document.getElementById('end-icon').innerHTML = `<i class="fas ${iconClass}"></i>`;
                document.getElementById('end-stats').innerText = `最終狀態: HP:${this.stats.hp} SAN:${this.stats.san}`;
                setTimeout(() => screen.style.display = 'flex', 1500);
            },

            copyHistory: function() {
                const text = this.historyLog.join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("歷程已複製到剪貼簿！");
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            }
        };
        window.onload = () => game.reset();
    </script>
</body>
</html>
